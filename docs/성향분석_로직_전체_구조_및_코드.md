# ì¸í…Œë¦¬ë´‡ ì„±í–¥ë¶„ì„ ë¡œì§ ì „ì²´ êµ¬ì¡° ë° ì½”ë“œ

> ì‘ì„±ì¼: 2024ë…„  
> ë²„ì „: V4 (V3 í˜¸í™˜)  
> ëª©ì : ì„±í–¥ë¶„ì„ ì‹œìŠ¤í…œì˜ ì „ì²´ êµ¬ì¡°ì™€ ì½”ë“œë¥¼ í•œëˆˆì— íŒŒì•…

---

## ğŸ“‹ ëª©ì°¨

1. [ì‹œìŠ¤í…œ ê°œìš”](#ì‹œìŠ¤í…œ-ê°œìš”)
2. [ì•„í‚¤í…ì²˜ êµ¬ì¡°](#ì•„í‚¤í…ì²˜-êµ¬ì¡°)
3. [V4 PersonalityEngine (ìµœì‹ )](#v4-personalityengine-ìµœì‹ )
4. [V3 TraitEngine (ê¸°ì¡´ ì—”ì§„)](#v3-traitengine-ê¸°ì¡´-ì—”ì§„)
5. [ë°ì´í„° ì†ŒìŠ¤](#ë°ì´í„°-ì†ŒìŠ¤)
6. [ë³€í™˜ê¸° (Converter)](#ë³€í™˜ê¸°-converter)
7. [Store ê´€ë¦¬](#store-ê´€ë¦¬)
8. [ì „ì²´ ì‹¤í–‰ íë¦„](#ì „ì²´-ì‹¤í–‰-íë¦„)

---

## ì‹œìŠ¤í…œ ê°œìš”

ì¸í…Œë¦¬ë´‡ì˜ ì„±í–¥ë¶„ì„ ì‹œìŠ¤í…œì€ **V4 PersonalityEngine**ì„ ë©”ì¸ìœ¼ë¡œ í•˜ë©°, ë‚´ë¶€ì ìœ¼ë¡œ **V3 TraitEngine**ì„ í˜¸ì¶œí•˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.

### í•µì‹¬ íŠ¹ì§•

- **V4**: ìµœì‹  ì¸í„°í˜ì´ìŠ¤, ì˜ë¬¸ í‚¤ ì‚¬ìš©, 1-10 ì ìˆ˜ ì²´ê³„
- **V3**: ê¸°ì¡´ ì—”ì§„, í•œê¸€ í‚¤ ì‚¬ìš©, 0-100 ì ìˆ˜ ì²´ê³„
- **ì–‘ë°©í–¥ ë³€í™˜**: V4 â†” V3 ìë™ ë³€í™˜ìœ¼ë¡œ í˜¸í™˜ì„± ìœ ì§€
- **ë‹¤ì¤‘ ë°ì´í„° ì†ŒìŠ¤**: ì§ˆë¬¸ ê¸°ì¤€í‘œ, answer-mappings, DB, VibeInput

---

## ì•„í‚¤í…ì²˜ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    V4 PersonalityEngine                  â”‚
â”‚  (lib/estimate-v4/engines/personality/)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ TraitScorer  â”‚  â”‚TypeClassifierâ”‚  â”‚ RiskAssessor â”‚  â”‚
â”‚  â”‚  (ì ìˆ˜ ê³„ì‚°)  â”‚  â”‚  (íƒ€ì… ë¶„ë¥˜)  â”‚  â”‚  (ìœ„í—˜ í‰ê°€)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                â”‚                 â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                        â”‚                               â”‚
â”‚                        â–¼                               â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚              â”‚  V3 TraitEngine  â”‚                      â”‚
â”‚              â”‚  (í•µì‹¬ ë¡œì§)      â”‚                      â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                        â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ì§ˆë¬¸ê¸°ì¤€í‘œâ”‚   â”‚answer-   â”‚   â”‚  Supabaseâ”‚
    â”‚  (JSON) â”‚   â”‚mappings  â”‚   â”‚    DB    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## V4 PersonalityEngine (ìµœì‹ )

### 1. PersonalityEngineV4.ts

**ê²½ë¡œ**: `lib/estimate-v4/engines/personality/PersonalityEngineV4.ts`

**ì—­í• **: ì„±í–¥ë¶„ì„ ë©”ì¸ ì—”ì§„ - 4ë‹¨ê³„ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸

```typescript
/**
 * V4 PersonalityEngine - ì„±í–¥ ë¶„ì„ ì—”ì§„
 * 
 * TraitScorer, TypeClassifier, RiskAssessorë¥¼ í†µí•©
 */

import type { CollectedInputV4, PersonalityResultV4 } from '../../types'
import { calculateTraitScores } from './TraitScorer'
import { classifyTypes } from './TypeClassifier'
import { assessRisk } from './RiskAssessor'
import { logger } from '../../utils/logger'

/**
 * ì„±í–¥ ë¶„ì„ ë©”ì¸ í•¨ìˆ˜
 */
export async function analyzePersonality(
  input: CollectedInputV4
): Promise<PersonalityResultV4> {
  logger.info('PersonalityEngine', 'ì„±í–¥ ë¶„ì„ ì‹œì‘', {
    pyeong: input.spaceInfo.pyeong,
    answersCount: input.answers.length,
  })

  // Step 1: ì ìˆ˜ ê³„ì‚° (ë¨¼ì €)
  const traitScores = await logger.measure(
    'PersonalityEngine',
    'ì ìˆ˜ ê³„ì‚°',
    () => calculateTraitScores(input.answers, input.spaceInfo)
  )

  // Step 2: íƒ€ì… ë¶„ë¥˜ (ì ìˆ˜ í•„ìš”)
  const classifiedTypes = await logger.measure(
    'PersonalityEngine',
    'íƒ€ì… ë¶„ë¥˜',
    () => Promise.resolve(classifyTypes(traitScores, input.preferences))
  )

  // Step 3: ìœ„í—˜ í‰ê°€ (ì ìˆ˜ + íƒ€ì… ëª¨ë‘ í•„ìš”)
  const riskAssessment = await logger.measure(
    'PersonalityEngine',
    'ìœ„í—˜ í‰ê°€',
    () =>
      Promise.resolve(
        assessRisk(
          traitScores,
          classifiedTypes,
          input.preferences,
          input.spaceInfo
        )
      )
  )

  // Step 4: ë¬¸ì œ ë¶„ë¥˜ (ì„ íƒì‚¬í•­)
  const problemClassification = classifyProblem(classifiedTypes, input.preferences)

  logger.info('PersonalityEngine', 'ì„±í–¥ ë¶„ì„ ì™„ë£Œ', {
    riskLevel: riskAssessment.level,
    typesCount:
      classifiedTypes.lifestyle.length +
      classifiedTypes.family.length +
      classifiedTypes.personality.length,
  })

  return {
    traitScores,
    classifiedTypes,
    riskAssessment,
    problemClassification,
    analyzedAt: new Date().toISOString(),
  }
}

/**
 * ë¬¸ì œ ìœ í˜• ë¶„ë¥˜ (ê°„ì†Œí™” ë²„ì „)
 */
function classifyProblem(
  classifiedTypes: PersonalityResultV4['classifiedTypes'],
  preferences: CollectedInputV4['preferences']
): PersonalityResultV4['problemClassification'] {
  // ê¸°ë³¸ê°’: ê³µê°„í˜• ë¶ˆí¸ì´ ë” í¼
  return {
    locationScore: 0.3,
    spaceScore: 0.7,
    recommendation: 'remodel',
    message: 'ê³µê°„ êµ¬ì¡° ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.',
  }
}
```

**ì²˜ë¦¬ ë‹¨ê³„**:
1. **TraitScorer**: ë‹µë³€ â†’ ì„±í–¥ ì ìˆ˜ ê³„ì‚°
2. **TypeClassifier**: ì ìˆ˜ â†’ ìƒí™œ/ê°€ì¡±/ì„±ê²© ìœ í˜• ë¶„ë¥˜
3. **RiskAssessor**: ìœ„í—˜ ìš”ì†Œ í‰ê°€ ë° ì˜ˆë¹„ë¹„ ê³„ì‚°
4. **ProblemClassification**: ì…ì§€í˜• vs ê³µê°„í˜• ë¶ˆí¸ ë¶„ë¥˜

---

### 2. TraitScorer.ts

**ê²½ë¡œ**: `lib/estimate-v4/engines/personality/TraitScorer.ts`

**ì—­í• **: V3 TraitEngineì„ ë˜í•‘í•˜ì—¬ V4 í¬ë§·ìœ¼ë¡œ ë³€í™˜

```typescript
/**
 * V4 TraitScorer - ì„±í–¥ ì ìˆ˜ ê³„ì‚°ê¸°
 * 
 * V3 TraitEngineì„ ë˜í•‘í•˜ì—¬ V4 í¬ë§·ìœ¼ë¡œ ë³€í™˜
 */

import { TraitEngine } from '@/lib/analysis/engine-v3/engines/TraitEngine'
import type { UserAnswerV4, SpaceInfoV4, TraitScoreV4 } from '../../types'
import { toV3TraitEngineInput } from '../../converters/input-converter'
import { toV4TraitScores } from '../../converters/output-converter'
import { logger } from '../../utils/logger'
import { V3EngineError } from '../../errors'

/**
 * V3 TraitEngineì„ ë˜í•‘í•˜ì—¬ V4 í¬ë§·ìœ¼ë¡œ ë³€í™˜
 */
export async function calculateTraitScores(
  answers: UserAnswerV4[],
  spaceInfo: SpaceInfoV4
): Promise<TraitScoreV4[]> {
  try {
    logger.debug('TraitScorer', 'ì ìˆ˜ ê³„ì‚° ì‹œì‘', {
      answersCount: answers.length,
      pyeong: spaceInfo.pyeong,
    })

    // 1. V4 ì…ë ¥ â†’ V3 ì…ë ¥ ë³€í™˜
    const v3Input = toV3TraitEngineInput({
      answers,
      spaceInfo,
      preferences: {
        budget: { min: 0, max: 0, flexibility: 'uncertain' },
        family: {
          totalPeople: 0,
          hasInfant: false,
          hasChild: false,
          hasElderly: false,
          hasPet: false,
        },
        lifestyle: {
          remoteWork: false,
          cookOften: false,
          guestsOften: false,
        },
        purpose: 'live',
      },
      selectedSpaces: [],
      selectedProcesses: {},
      timestamp: new Date().toISOString(),
    })

    // 2. V3 TraitEngine í˜¸ì¶œ
    const traitEngine = new TraitEngine()
    const v3Result = await logger.measure(
      'TraitScorer',
      'V3 TraitEngine í˜¸ì¶œ',
      () => traitEngine.analyze(v3Input)
    )

    // 3. V3 ê²°ê³¼ â†’ V4 í¬ë§· ë³€í™˜
    const v4Scores = toV4TraitScores(v3Result)

    logger.debug('TraitScorer', 'ì ìˆ˜ ê³„ì‚° ì™„ë£Œ', {
      scoresCount: v4Scores.length,
    })

    return v4Scores
  } catch (error) {
    logger.error('TraitScorer', 'ì ìˆ˜ ê³„ì‚° ì‹¤íŒ¨', error)
    
    // V3 ì—”ì§„ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì ìˆ˜ ë°˜í™˜
    if (error instanceof Error) {
      throw new V3EngineError('TraitEngine', error)
    }
    
    // ê¸°ë³¸ ì ìˆ˜ ë°˜í™˜ (fallback)
    return getDefaultTraitScores()
  }
}

/**
 * ê¸°ë³¸ ì ìˆ˜ (Fallback)
 */
function getDefaultTraitScores(): TraitScoreV4[] {
  const defaultTraits = [
    'storage_importance',
    'flow_importance',
    'light_importance',
    'noise_sensitivity',
    'cleaning_preference',
    'style_preference',
    'color_preference',
    'family_impact',
    'pet_friendly',
    'budget_flexibility',
    'complexity_tolerance',
    'value_protection',
  ]

  return defaultTraits.map(code => ({
    traitCode: code,
    score: 5, // ì¤‘ê°„ê°’
    confidence: 0.3, // ë‚®ì€ ì‹ ë¢°ë„
  }))
}
```

**ë³€í™˜ ê³¼ì •**:
1. V4 ì…ë ¥ (ì˜ë¬¸ í‚¤, 1-10 ì ìˆ˜) â†’ V3 ì…ë ¥ (í•œê¸€ í‚¤, 0-100 ì ìˆ˜)
2. V3 TraitEngine ì‹¤í–‰
3. V3 ê²°ê³¼ (í•œê¸€ í‚¤, 0-100) â†’ V4 ê²°ê³¼ (ì˜ë¬¸ í‚¤, 1-10)

---

### 3. TypeClassifier.ts

**ê²½ë¡œ**: `lib/estimate-v4/engines/personality/TypeClassifier.ts`

**ì—­í• **: ì„±í–¥ ì ìˆ˜ë¥¼ ì§ê´€ì ì¸ íƒ€ì…ìœ¼ë¡œ ë¶„ë¥˜

```typescript
/**
 * V4 TypeClassifier - íƒ€ì… ë¶„ë¥˜ê¸°
 * 
 * ì„±í–¥ ì ìˆ˜ë¥¼ ì§ê´€ì ì¸ íƒ€ì…ìœ¼ë¡œ ë¶„ë¥˜
 */

import type {
  TraitScoreV4,
  PreferencesV4,
  ClassifiedTypesV4,
} from '../../types'
import { logger } from '../../utils/logger'

/**
 * íƒ€ì… ë¶„ë¥˜ê¸°
 * @param scores - ì„±í–¥ ì ìˆ˜ ëª©ë¡
 * @param preferences - ì‚¬ìš©ì ì„ í˜¸ ì„¤ì •
 * @returns ë¶„ë¥˜ëœ íƒ€ì…
 */
export function classifyTypes(
  scores: TraitScoreV4[],
  preferences: PreferencesV4
): ClassifiedTypesV4 {
  logger.debug('TypeClassifier', 'íƒ€ì… ë¶„ë¥˜ ì‹œì‘')

  const lifestyle: string[] = []
  const family: string[] = []
  const personality: string[] = []

  // ì ìˆ˜ë¥¼ ë§µìœ¼ë¡œ ë³€í™˜ (ë¹ ë¥¸ ì¡°íšŒ)
  const scoreMap = new Map<string, number>()
  for (const score of scores) {
    scoreMap.set(score.traitCode, score.score)
  }

  // ìƒí™œ ìœ í˜• ë¶„ë¥˜
  if (preferences.lifestyle.remoteWork) {
    lifestyle.push('remote_work')
  }
  if (preferences.lifestyle.cookOften) {
    lifestyle.push('cooking_focused')
  }
  if (preferences.lifestyle.guestsOften) {
    lifestyle.push('social_host')
  }

  // ê°€ì¡± ìœ í˜• ë¶„ë¥˜
  if (preferences.family.hasInfant) {
    family.push('has_infant')
  }
  if (preferences.family.hasChild) {
    family.push('has_child')
  }
  if (preferences.family.hasElderly) {
    family.push('has_elderly')
  }
  if (preferences.family.hasPet) {
    family.push('has_pet')
  }

  // ì„±ê²© ìœ í˜• ë¶„ë¥˜
  const orgScore = scoreMap.get('organization_habit') ?? 5
  const storageScore = scoreMap.get('storage_importance') ?? 5
  const cleaningScore = scoreMap.get('cleaning_preference') ?? 5
  const noiseScore = scoreMap.get('noise_sensitivity') ?? 5
  const lightScore = scoreMap.get('light_importance') ?? 5

  if (orgScore >= 7 && cleaningScore >= 7) {
    personality.push('clean_oriented')
  }
  if (storageScore >= 7 && orgScore >= 7) {
    personality.push('storage_focused')
  }
  if (noiseScore >= 7) {
    personality.push('noise_sensitive')
  }
  if (lightScore >= 7) {
    personality.push('light_focused')
  }

  // ì˜ì‚¬ê²°ì • ìœ í˜• (ê¸°ë³¸ê°’: solo)
  let decision: 'solo' | 'joint' | 'split' = 'solo'
  if (preferences.family.totalPeople >= 2) {
    decision = 'joint'
  }

  logger.debug('TypeClassifier', 'íƒ€ì… ë¶„ë¥˜ ì™„ë£Œ', {
    lifestyleCount: lifestyle.length,
    familyCount: family.length,
    personalityCount: personality.length,
  })

  return {
    lifestyle,
    family,
    personality,
    decision,
  }
}
```

**ë¶„ë¥˜ ê¸°ì¤€**:
- **ìƒí™œ ìœ í˜•**: ì¬íƒê·¼ë¬´, ìš”ë¦¬ë¹ˆë„, ì†ë‹˜ë¹ˆë„
- **ê°€ì¡± ìœ í˜•**: ìœ ì•„, ì•„ì´, ë…¸ì¸, ë°˜ë ¤ë™ë¬¼
- **ì„±ê²© ìœ í˜•**: ì •ë¦¬/ì²­ì†Œ ì¤‘ì‹œ, ìˆ˜ë‚© ì¤‘ì‹œ, ì†ŒìŒ ë¯¼ê°, ì¡°ëª… ì¤‘ì‹œ
- **ì˜ì‚¬ê²°ì •**: í˜¼ì / ê³µë™ / ë¶„ë¦¬

---

### 4. RiskAssessor.ts

**ê²½ë¡œ**: `lib/estimate-v4/engines/personality/RiskAssessor.ts`

**ì—­í• **: ìœ„í—˜ ìš”ì†Œ í‰ê°€ ë° ì˜ˆë¹„ë¹„ ê³„ì‚°

```typescript
/**
 * V4 RiskAssessor - ìœ„í—˜ í‰ê°€ê¸°
 * 
 * V3 RiskEngine ë˜í•‘ + í›„íšŒìœ„í—˜ í‰ê°€ í™•ì¥
 */

import { RiskEngine } from '@/lib/analysis/engine-v3/engines/RiskEngine'
import type {
  TraitScoreV4,
  PreferencesV4,
  SpaceInfoV4,
  RiskAssessmentV4,
  ClassifiedTypesV4,
} from '../../types'
import { toV3Indicators, toV3RiskEngineInput } from '../../converters/input-converter'
import { toV4RiskAssessment, calculateBufferPercentage } from '../../converters/output-converter'
import { REGRET_RISK_CODES } from '../../converters/risk-mapper'
import { logger } from '../../utils/logger'
import { V3EngineError } from '../../errors'

/**
 * V3 RiskEngine ë˜í•‘ + í›„íšŒìœ„í—˜ í‰ê°€ í™•ì¥
 * 
 * ë™ê¸° ë²„ì „: processResult ì—†ì´ ê¸°ë³¸ ìœ„í—˜ í‰ê°€ë§Œ ìˆ˜í–‰
 */
export function assessRisk(
  scores: TraitScoreV4[],
  classifiedTypes: ClassifiedTypesV4,
  preferences: PreferencesV4,
  spaceInfo: SpaceInfoV4
): RiskAssessmentV4 {
  logger.debug('RiskAssessor', 'ìœ„í—˜ í‰ê°€ ì‹œì‘ (ë™ê¸°)')

  // V4 ì‹ ê·œ: í›„íšŒìœ„í—˜ í‰ê°€
  const regretRisks = assessRegretRisks(preferences, spaceInfo, classifiedTypes)

  // ê¸°ë³¸ ìœ„í—˜ ì ìˆ˜ ê³„ì‚°
  let totalScore = 20 // ê¸°ë³¸ê°’
  let level: 'low' | 'medium' | 'high' = 'low'

  // í›„íšŒìœ„í—˜ ë°˜ì˜
  for (const risk of regretRisks) {
    const riskInfo = REGRET_RISK_CODES[risk as keyof typeof REGRET_RISK_CODES]
    if (riskInfo) {
      totalScore += riskInfo.bufferAdd * 5
    }
  }

  // ìœ„í—˜ ìˆ˜ì¤€ ê²°ì •
  if (totalScore >= 50) level = 'high'
  else if (totalScore >= 30) level = 'medium'

  // ì˜ˆë¹„ë¹„ ë¹„ìœ¨ ê³„ì‚°
  const bufferPercentage = calculateBufferPercentage(level, regretRisks.length)

  return {
    totalScore,
    level,
    triggeredRisks: regretRisks,
    bufferPercentage,
  }
}

/**
 * V4 ì‹ ê·œ: í›„íšŒìœ„í—˜ í‰ê°€
 * - ì²« ì¸í…Œë¦¬ì–´, ë¹ ë“¯í•œ ì˜ˆì‚°, ìŠ¤íƒ€ì¼ ë¯¸ì • ë“±
 */
function assessRegretRisks(
  preferences: PreferencesV4,
  spaceInfo: SpaceInfoV4,
  classifiedTypes: ClassifiedTypesV4
): string[] {
  const risks: string[] = []

  // ë¹ ë“¯í•œ ì˜ˆì‚°
  if (preferences.budget.flexibility === 'strict') {
    risks.push('tight_budget')
  }

  // ì˜¤ë˜ëœ ê±´ë¬¼
  if (spaceInfo.buildingAge && spaceInfo.buildingAge >= 20) {
    risks.push('old_building')
  }

  // ëŒ€ê°€ì¡±
  if (preferences.family.totalPeople >= 5) {
    risks.push('large_family')
  }

  // ê³µë™ ì˜ì‚¬ê²°ì •
  if (classifiedTypes.decision === 'joint') {
    risks.push('joint_decision')
  }

  return risks
}
```

**í›„íšŒìœ„í—˜ ìš”ì†Œ**:
- `tight_budget`: ì˜ˆì‚° ì—¬ìœ  ì—†ìŒ
- `old_building`: 20ë…„ ì´ìƒ ê±´ë¬¼
- `large_family`: 5ì¸ ì´ìƒ ê°€ì¡±
- `joint_decision`: ê³µë™ ì˜ì‚¬ê²°ì •

---

## V3 TraitEngine (ê¸°ì¡´ ì—”ì§„)

### TraitEngine.ts

**ê²½ë¡œ**: `lib/analysis/engine-v3/engines/TraitEngine.ts`

**ì—­í• **: í•µì‹¬ ì„±í–¥ ë¶„ì„ ë¡œì§ - 12ê°œ ì§€í‘œ ê³„ì‚°

```typescript
/**
 * V3 ì„±í–¥ ì—”ì§„ (TraitEngine)
 * 
 * ê³ ê°ì˜ ì§ˆë¬¸ ë‹µë³€ì„ ê¸°ë°˜ìœ¼ë¡œ 12ê°œ ì„±í–¥ ì§€í‘œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
 * 
 * ì²˜ë¦¬ íë¦„:
 * 1. ì§ˆë¬¸ ë‹µë³€ ì •ê·œí™”
 * 2. ì§ˆë¬¸ ê¸°ì¤€í‘œ ë¡œë“œ
 * 3. 12ê°œ ì§€í‘œ ê³„ì‚° (ë‹µë³€ë³„ ì˜í–¥ ëˆ„ì )
 * 4. í‚¤ì›Œë“œ ì¶”ì¶œ
 * 5. ìš°ì„  ë¬¸ì œ ì˜ì—­ ë„ì¶œ
 * 6. ìƒí™œ ë£¨í‹´ ìœ í˜• íŒë‹¨
 */

import {
  TraitEngineInput,
  TraitEngineResult,
  TraitIndicators12,
  LifestyleType,
  QuestionDefinition
} from '../types'
import { loadQuestionCriteria } from '../utils/dataLoader'
import {
  createDefaultIndicators,
  validateAllIndicators,
  validateIndicatorRange,
  getTopIndicators,
  scoreToLevel
} from '../utils/scoreValidator'
import { getAnswerImpacts, type AnswerImpact } from '../../answer-mappings'

export class TraitEngine {
  /**
   * ì„±í–¥ ë¶„ì„ ë©”ì¸ í•¨ìˆ˜
   */
  async analyze(input: TraitEngineInput): Promise<TraitEngineResult> {
    console.log('ğŸ” [TraitEngine] ì„±í–¥ ë¶„ì„ ì‹œì‘')
    const startTime = Date.now()

    try {
      // 1. ì§ˆë¬¸ ê¸°ì¤€í‘œ ë¡œë“œ
      const criteria = await loadQuestionCriteria()

      // 2. ì´ˆê¸° ì§€í‘œ ìƒì„± (ëª¨ë‘ 50ì )
      let indicators = createDefaultIndicators()

      // 3. í‚¤ì›Œë“œ ìˆ˜ì§‘
      const keywords = new Set<string>()

      // 4. ìƒí™œ ë£¨í‹´ ìœ í˜• í›„ë³´
      const lifestyleTypes: LifestyleType[] = []

      // 5. ë‹µë³€ë³„ ì˜í–¥ ì ìš©
      for (const [questionId, answerId] of Object.entries(input.answers)) {
        // ë¨¼ì € answer-mappings.tsì—ì„œ ì°¾ê¸° (íŒë‹¨ ì¶• ì§ˆë¬¸ ë“±)
        let impact: any = null
        const answerMappingsImpacts = getAnswerImpacts(questionId, answerId)
        
        if (answerMappingsImpacts && answerMappingsImpacts.length > 0) {
          // answer-mappings í˜•ì‹ì„ TraitEngine í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          impact = this.convertAnswerMappingsToImpact(answerMappingsImpacts)
        } else {
          // answer-mappingsì— ì—†ìœ¼ë©´ ì§ˆë¬¸ ê¸°ì¤€í‘œì—ì„œ ì°¾ê¸°
          impact = this.getAnswerImpact(criteria, questionId, answerId)
        }
        
        if (impact) {
          // ì§€í‘œ ì ìˆ˜ ë³€í™” ì ìš©
          if (impact.indicators) {
            for (const [indicator, change] of Object.entries(impact.indicators)) {
              const key = indicator as keyof TraitIndicators12
              const currentValue = indicators[key]
              // íƒ€ì… ê°€ë“œ: changeê°€ ImpactValue ê°ì²´ì¸ì§€ í™•ì¸
              if (change && typeof change === 'object' && 'value' in change) {
                const newValue = currentValue + (change.value as number)
                indicators[key] = validateIndicatorRange(key, newValue)
              } else if (typeof change === 'number') {
                // answer-mappingsì—ì„œ ì˜¨ ê²½ìš° ì§ì ‘ ìˆ«ìì¼ ìˆ˜ ìˆìŒ
                const newValue = currentValue + change
                indicators[key] = validateIndicatorRange(key, newValue)
              }
            }
          }

          // í‚¤ì›Œë“œ ìˆ˜ì§‘
          if (impact.keywords) {
            impact.keywords.forEach((kw: string) => keywords.add(kw))
          }

          // ìƒí™œ ë£¨í‹´ ìœ í˜• ìˆ˜ì§‘
          if (impact.lifestyleType) {
            lifestyleTypes.push(impact.lifestyleType)
          }
        } else {
          console.warn(`[TraitEngine] ë‹µë³€ ì˜í–¥ ì—†ìŒ: ${questionId} â†’ ${answerId}`)
        }
      }

      // 6. ìµœì¢… ê²€ì¦
      indicators = validateAllIndicators(indicators)

      // 7. SpaceInfo ê¸°ë°˜ ì¶”ê°€ ì¡°ì •
      indicators = this.adjustBySpaceInfo(indicators, input.spaceInfo)

      // 8. VibeInput ê¸°ë°˜ ì¶”ê°€ ì¡°ì • (ì˜µì…˜)
      if (input.vibeInput) {
        indicators = this.adjustByVibeInput(indicators, input.vibeInput)
      }

      // 9. ìš°ì„  ë¬¸ì œ ì˜ì—­ ë„ì¶œ
      const priorityAreas = this.identifyPriorityAreas(indicators)

      // 10. ìƒí™œ ë£¨í‹´ ìœ í˜• íŒë‹¨
      const lifestyleType = this.determineLifestyleType(lifestyleTypes)

      // 11. í‚¤ì›Œë“œ ìµœì¢… ì •ë¦¬ (ìƒìœ„ 7ê°œ)
      const finalKeywords = Array.from(keywords).slice(0, 7)

      const executionTime = Date.now() - startTime
      console.log(`âœ… [TraitEngine] ì„±í–¥ ë¶„ì„ ì™„ë£Œ (${executionTime}ms)`)

      return {
        indicators,
        keywords: finalKeywords,
        priorityAreas,
        lifestyleType
      }
    } catch (error) {
      console.error('âŒ [TraitEngine] ì„±í–¥ ë¶„ì„ ì˜¤ë¥˜:', error)
      
      // Fallback: ê¸°ë³¸ ê²°ê³¼ ë°˜í™˜
      return {
        indicators: createDefaultIndicators(),
        keywords: ['ì¼ë°˜'],
        priorityAreas: ['ê±°ì‹¤', 'ì£¼ë°©'],
        lifestyleType: 'general'
      }
    }
  }

  /**
   * ì§ˆë¬¸ ê¸°ì¤€í‘œì—ì„œ ë‹µë³€ì˜ ì˜í–¥ ê°€ì ¸ì˜¤ê¸°
   */
  private getAnswerImpact(
    criteria: any,
    questionId: string,
    answerId: string
  ): any | null {
    // quick/standard/deep ëª¨ë“œ ìˆœíšŒ
    for (const mode of ['quick', 'standard', 'deep']) {
      const questions = criteria.questions[mode]
      
      for (const [qId, question] of Object.entries(questions) as Array<[string, QuestionDefinition]>) {
        if (question.id === questionId || qId === questionId) {
          const option = question.options[answerId]
          if (option && option.impact) {
            return option.impact
          }
        }
      }
    }

    // ê²½ê³ ëŠ” ìƒìœ„ì—ì„œ ì¶œë ¥í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” nullë§Œ ë°˜í™˜
    return null
  }

  /**
   * answer-mappings í˜•ì‹ì„ TraitEngine í˜•ì‹ìœ¼ë¡œ ë³€í™˜
   */
  private convertAnswerMappingsToImpact(answerMappingsImpacts: AnswerImpact[]): any {
    const indicators: Record<string, { value: number }> = {}
    
    // answer-mappingsì˜ score(1-10)ë¥¼ TraitEngineì˜ value(-50~+50)ë¡œ ë³€í™˜
    // score 1-10ì„ -50~+50 ë²”ìœ„ë¡œ ë§¤í•‘: (score - 5.5) * 10
    answerMappingsImpacts.forEach(({ category, score }) => {
      // PreferenceCategoryë¥¼ TraitIndicators12 í‚¤ë¡œ ë§¤í•‘
      const indicatorKey = this.mapCategoryToIndicator(category)
      if (indicatorKey) {
        // score 1-10ì„ -50~+50 ë²”ìœ„ë¡œ ë³€í™˜
        const value = (score - 5.5) * 10
        indicators[indicatorKey] = { value }
      }
    })
    
    return Object.keys(indicators).length > 0 ? { indicators } : null
  }

  /**
   * PreferenceCategoryë¥¼ TraitIndicators12 í‚¤ë¡œ ë§¤í•‘
   */
  private mapCategoryToIndicator(category: string): keyof TraitIndicators12 | null {
    const mapping: Record<string, keyof TraitIndicators12> = {
      'space_sense': 'ìŠ¤íƒ€ì¼ê³ ì§‘ë„',
      'sensory_sensitivity': 'ì†ŒìŒë¯¼ê°ë„',
      'cleaning_preference': 'ê´€ë¦¬ë¯¼ê°ë„',
      'organization_habit': 'ìˆ˜ë‚©ì¤‘ìš”ë„',
      'family_composition': 'ê°€ì¡±ì˜í–¥ë„',
      'health_factors': 'ê´€ë¦¬ë¯¼ê°ë„',
      'budget_sense': 'ì˜ˆì‚°íƒ„ë ¥ì„±',
      'color_preference': 'ìƒ‰ê°ì·¨í–¥',
      'lighting_preference': 'ì¡°ëª…ì·¨í–¥',
      'home_purpose': 'ì§‘ê°’ë°©ì–´ì˜ì‹',
      'discomfort_factors': 'ê³µì‚¬ë³µì¡ë„ìˆ˜ìš©ì„±',
      'activity_flow': 'ë™ì„ ì¤‘ìš”ë„',
      'life_routine': 'ê°€ì¡±ì˜í–¥ë„',
      'sleep_pattern': 'ì†ŒìŒë¯¼ê°ë„',
      'hobby_lifestyle': 'ìŠ¤íƒ€ì¼ê³ ì§‘ë„',
    }
    
    return mapping[category] || null
  }

  /**
   * SpaceInfo ê¸°ë°˜ ì¶”ê°€ ì¡°ì •
   */
  private adjustBySpaceInfo(
    indicators: TraitIndicators12,
    spaceInfo: any
  ): TraitIndicators12 {
    const adjusted = { ...indicators }

    // ê°€ì¡± êµ¬ì„±ì› ìˆ˜ê°€ ë§ìœ¼ë©´ ê°€ì¡±ì˜í–¥ë„, ìˆ˜ë‚©ì¤‘ìš”ë„ ì¦ê°€
    if (spaceInfo.totalPeople && spaceInfo.totalPeople >= 4) {
      adjusted.ê°€ì¡±ì˜í–¥ë„ = validateIndicatorRange('ê°€ì¡±ì˜í–¥ë„', adjusted.ê°€ì¡±ì˜í–¥ë„ + 10)
      adjusted.ìˆ˜ë‚©ì¤‘ìš”ë„ = validateIndicatorRange('ìˆ˜ë‚©ì¤‘ìš”ë„', adjusted.ìˆ˜ë‚©ì¤‘ìš”ë„ + 10)
    }

    // í‰ìˆ˜ê°€ ì‘ìœ¼ë©´ ë™ì„ ì¤‘ìš”ë„, ìˆ˜ë‚©ì¤‘ìš”ë„ ì¦ê°€
    if (spaceInfo.pyeong && spaceInfo.pyeong <= 20) {
      adjusted.ë™ì„ ì¤‘ìš”ë„ = validateIndicatorRange('ë™ì„ ì¤‘ìš”ë„', adjusted.ë™ì„ ì¤‘ìš”ë„ + 10)
      adjusted.ìˆ˜ë‚©ì¤‘ìš”ë„ = validateIndicatorRange('ìˆ˜ë‚©ì¤‘ìš”ë„', adjusted.ìˆ˜ë‚©ì¤‘ìš”ë„ + 5)
    }

    // ìš•ì‹¤ 1ê°œë©´ ë™ì„ ì¤‘ìš”ë„ ì¦ê°€
    if (spaceInfo.bathrooms && spaceInfo.bathrooms === 1) {
      adjusted.ë™ì„ ì¤‘ìš”ë„ = validateIndicatorRange('ë™ì„ ì¤‘ìš”ë„', adjusted.ë™ì„ ì¤‘ìš”ë„ + 5)
    }

    return adjusted
  }

  /**
   * VibeInput ê¸°ë°˜ ì¶”ê°€ ì¡°ì •
   */
  private adjustByVibeInput(
    indicators: TraitIndicators12,
    vibeInput: any
  ): TraitIndicators12 {
    const adjusted = { ...indicators }

    // MBTI ê¸°ë°˜ ì¡°ì • (ê°„ë‹¨í•œ ì˜ˆì‹œ)
    if (vibeInput.mbti) {
      const mbti = vibeInput.mbti.toUpperCase()
      
      // J ìœ í˜•: ì •ë¦¬ì •ëˆ ì¤‘ì‹œ
      if (mbti.includes('J')) {
        adjusted.ìˆ˜ë‚©ì¤‘ìš”ë„ = validateIndicatorRange('ìˆ˜ë‚©ì¤‘ìš”ë„', adjusted.ìˆ˜ë‚©ì¤‘ìš”ë„ + 5)
        adjusted.ê´€ë¦¬ë¯¼ê°ë„ = validateIndicatorRange('ê´€ë¦¬ë¯¼ê°ë„', adjusted.ê´€ë¦¬ë¯¼ê°ë„ + 5)
      }
      
      // P ìœ í˜•: ììœ ë¡œìš´ í¸
      if (mbti.includes('P')) {
        adjusted.ìŠ¤íƒ€ì¼ê³ ì§‘ë„ = validateIndicatorRange('ìŠ¤íƒ€ì¼ê³ ì§‘ë„', adjusted.ìŠ¤íƒ€ì¼ê³ ì§‘ë„ + 5)
      }
      
      // F ìœ í˜•: ê°ì„± ì¤‘ì‹œ
      if (mbti.includes('F')) {
        adjusted.ì¡°ëª…ì·¨í–¥ = validateIndicatorRange('ì¡°ëª…ì·¨í–¥', adjusted.ì¡°ëª…ì·¨í–¥ + 5)
        adjusted.ìƒ‰ê°ì·¨í–¥ = validateIndicatorRange('ìƒ‰ê°ì·¨í–¥', adjusted.ìƒ‰ê°ì·¨í–¥ + 5)
      }
    }

    return adjusted
  }

  /**
   * ìš°ì„  ë¬¸ì œ ì˜ì—­ ë„ì¶œ
   * ì§€í‘œ ì ìˆ˜ ìƒìœ„ 3ê°œë¥¼ ì˜ì—­ìœ¼ë¡œ ë³€í™˜
   */
  private identifyPriorityAreas(indicators: TraitIndicators12): string[] {
    const topIndicators = getTopIndicators(indicators, 3)

    const areaMapping: Record<keyof TraitIndicators12, string> = {
      ìˆ˜ë‚©ì¤‘ìš”ë„: 'ìˆ˜ë‚©',
      ë™ì„ ì¤‘ìš”ë„: 'ë™ì„ ',
      ì¡°ëª…ì·¨í–¥: 'ì¡°ëª…',
      ì†ŒìŒë¯¼ê°ë„: 'ë°©ìŒ',
      ê´€ë¦¬ë¯¼ê°ë„: 'ê´€ë¦¬/ì²­ì†Œ',
      ìŠ¤íƒ€ì¼ê³ ì§‘ë„: 'ìŠ¤íƒ€ì¼',
      ìƒ‰ê°ì·¨í–¥: 'ìƒ‰ê°',
      ê°€ì¡±ì˜í–¥ë„: 'ê°€ì¡± ê³µê°„',
      ë°˜ë ¤ë™ë¬¼ì˜í–¥ë„: 'ë°˜ë ¤ë™ë¬¼',
      ì˜ˆì‚°íƒ„ë ¥ì„±: 'ì˜ˆì‚°',
      ê³µì‚¬ë³µì¡ë„ìˆ˜ìš©ì„±: 'êµ¬ì¡° ë³€ê²½',
      ì§‘ê°’ë°©ì–´ì˜ì‹: 'ì§‘ê°’ ë°©ì–´'
    }

    return topIndicators
      .filter(item => item.score >= 60)  // 60ì  ì´ìƒë§Œ
      .map(item => areaMapping[item.indicator])
  }

  /**
   * ìƒí™œ ë£¨í‹´ ìœ í˜• íŒë‹¨
   * ë‹µë³€ì—ì„œ ìˆ˜ì§‘ëœ lifestyleType ì¤‘ ê°€ì¥ ë§ì´ ë‚˜ì˜¨ ê²ƒ
   */
  private determineLifestyleType(types: LifestyleType[]): LifestyleType {
    if (types.length === 0) return 'general'

    // ë¹ˆë„ ê³„ì‚°
    const frequency = types.reduce((acc, type) => {
      acc[type] = (acc[type] || 0) + 1
      return acc
    }, {} as Record<LifestyleType, number>)

    // ê°€ì¥ ë§ì´ ë‚˜ì˜¨ íƒ€ì…
    const mostCommon = Object.entries(frequency)
      .sort((a, b) => b[1] - a[1])[0][0] as LifestyleType

    return mostCommon
  }
}

/**
 * ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ (ì˜µì…˜)
 */
export const traitEngine = new TraitEngine()
```

**12ê°œ ì„±í–¥ ì§€í‘œ (V3 í•œê¸€ í‚¤)**:
1. `ìˆ˜ë‚©ì¤‘ìš”ë„`: ìˆ˜ë‚© ê³µê°„ì— ëŒ€í•œ ì¤‘ìš”ë„
2. `ë™ì„ ì¤‘ìš”ë„`: ë™ì„  ê³„íšì— ëŒ€í•œ ì¤‘ìš”ë„
3. `ì¡°ëª…ì·¨í–¥`: ì¡°ëª… ë””ìì¸ ì„ í˜¸ë„
4. `ì†ŒìŒë¯¼ê°ë„`: ì†ŒìŒì— ëŒ€í•œ ë¯¼ê°ë„
5. `ê´€ë¦¬ë¯¼ê°ë„`: ì²­ì†Œ/ê´€ë¦¬ í¸ì˜ì„± ì¤‘ì‹œë„
6. `ìŠ¤íƒ€ì¼ê³ ì§‘ë„`: ì¸í…Œë¦¬ì–´ ìŠ¤íƒ€ì¼ ê³ ì§‘ë„
7. `ìƒ‰ê°ì·¨í–¥`: ìƒ‰ìƒ ì„ í˜¸ë„
8. `ê°€ì¡±ì˜í–¥ë„`: ê°€ì¡± êµ¬ì„±ì› ê³ ë ¤ë„
9. `ë°˜ë ¤ë™ë¬¼ì˜í–¥ë„`: ë°˜ë ¤ë™ë¬¼ ê³ ë ¤ë„
10. `ì˜ˆì‚°íƒ„ë ¥ì„±`: ì˜ˆì‚° ì¡°ì • ê°€ëŠ¥ì„±
11. `ê³µì‚¬ë³µì¡ë„ìˆ˜ìš©ì„±`: ë³µì¡í•œ ê³µì‚¬ ìˆ˜ìš©ë„
12. `ì§‘ê°’ë°©ì–´ì˜ì‹`: ì§‘ê°’ ë³´í˜¸ ì˜ì‹

---

## ë°ì´í„° ì†ŒìŠ¤

### 1. answer-mappings.ts

**ê²½ë¡œ**: `lib/analysis/answer-mappings.ts`

**ì—­í• **: ì§ˆë¬¸ ë‹µë³€ â†’ ì„±í–¥ ì ìˆ˜ ì§ì ‘ ë§¤í•‘

```typescript
/**
 * ë‹µë³€â†’ì ìˆ˜ ë§¤í•‘ í…Œì´ë¸”
 * 
 * ê¸°ì¡´ hashToScore í•¨ìˆ˜(ë‚œìˆ˜ ê¸°ë°˜)ë¥¼ ëŒ€ì²´í•˜ì—¬
 * ê³ ê°ì˜ ì‹¤ì œ ë‹µë³€ ë‚´ìš©ì— ë”°ë¼ ì •í™•í•œ ì ìˆ˜ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
 * 
 * ê° ë‹µë³€ì€ 1~2ê°œì˜ ì¹´í…Œê³ ë¦¬ì— ì˜í–¥ì„ ë¯¸ì¹˜ë©°,
 * ì ìˆ˜ëŠ” 1~10 ë²”ìœ„ì…ë‹ˆë‹¤.
 */

import { PreferenceCategory } from './questions/types';

// ë‹µë³€ ë§¤í•‘ íƒ€ì… ì •ì˜
export interface AnswerImpact {
  category: PreferenceCategory;
  score: number; // 1~10
}

export interface AnswerMapping {
  questionId: string;
  answerValue: string;
  impacts: AnswerImpact[];
}

// Quick ëª¨ë“œ, Standard ëª¨ë“œ, Deep ëª¨ë“œ, íŒë‹¨ ì¶• ì§ˆë¬¸ ë§¤í•‘ í¬í•¨
const ALL_ANSWER_MAPPINGS: AnswerMapping[] = [
  // ... ìˆ˜ë°± ê°œì˜ ë§¤í•‘ ë°ì´í„°
]

/**
 * íŠ¹ì • ì§ˆë¬¸ì˜ ë‹µë³€ì— í•´ë‹¹í•˜ëŠ” ì ìˆ˜ ë§¤í•‘ì„ ì°¾ìŠµë‹ˆë‹¤.
 */
export function getAnswerImpacts(
  questionId: string,
  answerValue: string
): AnswerImpact[] | null {
  const mapping = ALL_ANSWER_MAPPINGS.find(
    (m) => m.questionId === questionId && m.answerValue === answerValue
  );
  return mapping ? mapping.impacts : null;
}
```

**íŠ¹ì§•**:
- Quick/Standard/Deep ëª¨ë“œë³„ ë§¤í•‘
- íŒë‹¨ ì¶• ì§ˆë¬¸ (judgment_*) ë§¤í•‘
- 1-10 ì ìˆ˜ ì²´ê³„
- 1-2ê°œ ì¹´í…Œê³ ë¦¬ ì˜í–¥

---

### 2. ì§ˆë¬¸ ê¸°ì¤€í‘œ (JSON)

**ê²½ë¡œ**: `lib/traits/question-criteria-v3.json`

**ì—­í• **: ì§ˆë¬¸ ì •ì˜ ë° ë‹µë³€ë³„ ì˜í–¥ ì •ì˜

**êµ¬ì¡°**:
```json
{
  "version": "3.0.0",
  "questions": {
    "quick": {
      "quick_first_scene": {
        "id": "quick_first_scene",
        "text": "í‡´ê·¼í•´ì„œ ì œì¼ ë¨¼ì € ë³´ì´ê³  ì‹¶ì€ ì¥ë©´ì€?",
        "options": {
          "hotel_hallway": {
            "text": "í˜¸í…” ë³µë„ì²˜ëŸ¼ ê¹”ë”í•œ",
            "impact": {
              "indicators": {
                "ìˆ˜ë‚©ì¤‘ìš”ë„": { "value": 15 },
                "ê´€ë¦¬ë¯¼ê°ë„": { "value": 10 }
              },
              "keywords": ["ê¹”ë”", "ì •ë¦¬"]
            }
          }
        }
      }
    }
  }
}
```

---

### 3. personality-adapter.ts (Supabase)

**ê²½ë¡œ**: `lib/db/adapters/personality-adapter.ts`

**ì—­í• **: Supabase DBì—ì„œ ì„±í–¥ ê´€ë ¨ ë°ì´í„° ì¡°íšŒ

```typescript
/**
 * ì„±í–¥ ì–´ëŒ‘í„° - Supabase DB ì¡°íšŒ
 * 
 * ì„±í–¥ ê´€ë ¨ ë°ì´í„°ë¥¼ Supabaseì—ì„œ ì¡°íšŒí•˜ëŠ” ì–´ëŒ‘í„°
 * personality_traits, personality_materials, answer_score_mapping í…Œì´ë¸” ì‚¬ìš©
 */

import { supabase } from '@/lib/db/supabase'
import type { PreferenceScores } from '@/lib/analysis/types'

/**
 * ë‹µë³€-ì ìˆ˜ ë§¤í•‘ ì¡°íšŒ (DB)
 */
export async function getAnswerScoreMappingFromDB(
  questionId: string,
  answerValue: string,
  analysisMode: string = 'standard'
): Promise<Partial<PreferenceScores> | null> {
  try {
    const { data, error } = await supabase
      .from('answer_score_mapping')
      .select('trait_scores')
      .eq('question_id', questionId)
      .eq('answer_value', answerValue)
      .eq('analysis_mode', analysisMode)
      .maybeSingle()
    
    if (error) {
      console.error('ë‹µë³€-ì ìˆ˜ ë§¤í•‘ ì¡°íšŒ ì—ëŸ¬:', error)
      return null
    }
    
    if (!data) {
      return null
    }
    
    return data.trait_scores as Partial<PreferenceScores>
    
  } catch (error: any) {
    console.error('getAnswerScoreMappingFromDB ì—ëŸ¬:', error)
    return null
  }
}

/**
 * ì„±í–¥ ì ìˆ˜ ê¸°ë°˜ ìì¬ ì¶”ì²œ ì¡°íšŒ (DB)
 */
export async function getRecommendedMaterialsFromDB(
  traitScores: PreferenceScores,
  phaseId?: string | null
): Promise<PersonalityMaterialMapping[]> {
  // Supabase í•¨ìˆ˜ í˜¸ì¶œ ë˜ëŠ” ì§ì ‘ ì¿¼ë¦¬
  const { data, error } = await supabase.rpc('get_recommended_materials', {
    p_trait_scores: traitScoresJson,
    p_phase_id: phaseId || null
  })
  
  // ... ì²˜ë¦¬ ë¡œì§
}
```

---

### 4. vibeAnalyzer.ts

**ê²½ë¡œ**: `lib/analysis/vibeAnalyzer.ts`

**ì—­í• **: MBTI, í˜ˆì•¡í˜•, ë³„ìë¦¬ ê¸°ë°˜ ì„±í–¥ ë¶„ì„

```typescript
/**
 * MBTI, í˜ˆì•¡í˜•, ë³„ìë¦¬ ê¸°ë°˜ ì„±í–¥ ë¶„ì„ ë¡œì§
 */

export interface VibeInput {
  mbti?: string
  bloodType?: string
  zodiac?: string
}

export interface TraitScore {
  ìš”ë¦¬ë¹ˆë„: number
  ì •ë¦¬ì •ëˆ: number
  ì²­ì†Œì„±í–¥: number
  ì¡°ëª…ì·¨í–¥: number
  ì˜ˆì‚°ê°ê°: number
}

/**
 * MBTI, í˜ˆì•¡í˜•, ë³„ìë¦¬ë¥¼ ì¢…í•©í•˜ì—¬ ì„±í–¥ ì ìˆ˜ ê³„ì‚°
 */
export function analyzeVibeTraits(input: VibeInput): TraitScore {
  const scores: TraitScore = {
    ìš”ë¦¬ë¹ˆë„: 50,
    ì •ë¦¬ì •ëˆ: 50,
    ì²­ì†Œì„±í–¥: 50,
    ì¡°ëª…ì·¨í–¥: 50,
    ì˜ˆì‚°ê°ê°: 50,
  }

  let count = 0

  // MBTI ì ìˆ˜ ë°˜ì˜ (ê°€ì¤‘ì¹˜: 40%)
  if (input.mbti && MBTI_TRAITS[input.mbti.toUpperCase()]) {
    const mbtiScores = MBTI_TRAITS[input.mbti.toUpperCase()]
    Object.keys(scores).forEach((key) => {
      const traitKey = key as keyof TraitScore
      if (mbtiScores[traitKey] !== undefined) {
        scores[traitKey] += (mbtiScores[traitKey]! - 50) * 0.4
      }
    })
    count++
  }

  // í˜ˆì•¡í˜• ì ìˆ˜ ë°˜ì˜ (ê°€ì¤‘ì¹˜: 30%)
  if (input.bloodType && BLOOD_TYPE_TRAITS[input.bloodType.toUpperCase()]) {
    const bloodScores = BLOOD_TYPE_TRAITS[input.bloodType.toUpperCase()]
    Object.keys(scores).forEach((key) => {
      const traitKey = key as keyof TraitScore
      if (bloodScores[traitKey] !== undefined) {
        scores[traitKey] += (bloodScores[traitKey]! - 50) * 0.3
      }
    })
    count++
  }

  // ë³„ìë¦¬ ì ìˆ˜ ë°˜ì˜ (ê°€ì¤‘ì¹˜: 30%)
  if (input.zodiac && ZODIAC_TRAITS[input.zodiac.toLowerCase()]) {
    const zodiacScores = ZODIAC_TRAITS[input.zodiac.toLowerCase()]
    Object.keys(scores).forEach((key) => {
      const traitKey = key as keyof TraitScore
      if (zodiacScores[traitKey] !== undefined) {
        scores[traitKey] += (zodiacScores[traitKey]! - 50) * 0.3
      }
    })
    count++
  }

  // ì ìˆ˜ë¥¼ 0-100 ë²”ìœ„ë¡œ ì œí•œ
  Object.keys(scores).forEach((key) => {
    const traitKey = key as keyof TraitScore
    scores[traitKey] = Math.max(0, Math.min(100, Math.round(scores[traitKey])))
  })

  return scores
}
```

---

## ë³€í™˜ê¸° (Converter)

### 1. input-converter.ts

**ê²½ë¡œ**: `lib/estimate-v4/converters/input-converter.ts`

**ì—­í• **: V4 ì…ë ¥ â†’ V3 ì…ë ¥ ë³€í™˜

```typescript
/**
 * V4 ì…ë ¥ â†’ V3 ì…ë ¥ ë³€í™˜
 */

import type {
  CollectedInputV4,
  SpaceInfoV4,
  UserAnswerV4,
} from '../types'
import type {
  TraitEngineInput,
  RiskEngineInput,
  ProcessEngineInput,
} from '@/lib/analysis/engine-v3/types'
import type { TraitIndicators12 } from '@/lib/analysis/engine-v3/types'
import { V4_EN_TO_V3_KO } from './trait-mapper'
import type { TraitScoreV4 } from '../types'

/**
 * V4 SpaceInfo â†’ V3 SpaceInfo ë³€í™˜
 */
export function toV3SpaceInfo(spaceInfo: SpaceInfoV4) {
  return {
    housingType: spaceInfo.housingType,
    pyeong: spaceInfo.pyeong,
    rooms: spaceInfo.rooms,
    bathrooms: spaceInfo.bathrooms,
    buildingAge: spaceInfo.buildingAge ?? 0,
    floor: spaceInfo.floor,
  }
}

/**
 * V4 ì…ë ¥ â†’ V3 TraitEngine ì…ë ¥ ë³€í™˜
 */
export function toV3TraitEngineInput(
  input: CollectedInputV4
): TraitEngineInput {
  // V4 answers ë°°ì—´ì„ V3 Record í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  const answers: Record<string, string> = {}
  for (const answer of input.answers) {
    answers[answer.questionId] = String(answer.answerId)
  }

  return {
    answers,
    spaceInfo: toV3SpaceInfo(input.spaceInfo),
  }
}

/**
 * V4 TraitScoreV4[] â†’ V3 TraitIndicators12 ë³€í™˜ (í•œê¸€ í‚¤)
 */
export function toV3Indicators(scores: TraitScoreV4[]): TraitIndicators12 {
  const result: Record<string, number> = {}

  for (const score of scores) {
    // V4 ì˜ë¬¸ í‚¤ â†’ V3 í•œê¸€ í‚¤ë¡œ ë³€í™˜
    const v3Key = V4_EN_TO_V3_KO[score.traitCode]
    if (v3Key) {
      // V3ëŠ” 0-100 ë²”ìœ„, V4ëŠ” 1-10 ë²”ìœ„ì´ë¯€ë¡œ ë³€í™˜ í•„ìš”
      // V4 score (1-10) â†’ V3 (0-100): score * 10
      result[v3Key] = score.score * 10
    }
  }

  // ëˆ„ë½ëœ í•„ë“œëŠ” ê¸°ë³¸ê°’ 50 (V3 í•œê¸€ í‚¤ë¡œ)
  const requiredKoFields = [
    'ìˆ˜ë‚©ì¤‘ìš”ë„',
    'ë™ì„ ì¤‘ìš”ë„',
    'ì¡°ëª…ì·¨í–¥',
    'ì†ŒìŒë¯¼ê°ë„',
    'ê´€ë¦¬ë¯¼ê°ë„',
    'ìŠ¤íƒ€ì¼ê³ ì§‘ë„',
    'ìƒ‰ê°ì·¨í–¥',
    'ê°€ì¡±ì˜í–¥ë„',
    'ë°˜ë ¤ë™ë¬¼ì˜í–¥ë„',
    'ì˜ˆì‚°íƒ„ë ¥ì„±',
    'ê³µì‚¬ë³µì¡ë„ìˆ˜ìš©ì„±',
    'ì§‘ê°’ë°©ì–´ì˜ì‹',
  ]

  for (const field of requiredKoFields) {
    if (!(field in result)) {
      result[field] = 50 // V3 ê¸°ë³¸ê°’
    }
  }

  return result as TraitIndicators12
}
```

---

### 2. output-converter.ts

**ê²½ë¡œ**: `lib/estimate-v4/converters/output-converter.ts`

**ì—­í• **: V3 ì¶œë ¥ â†’ V4 ì¶œë ¥ ë³€í™˜

```typescript
/**
 * V3 ì¶œë ¥ â†’ V4 ì¶œë ¥ ë³€í™˜
 */

import type { TraitScoreV4, RiskAssessmentV4 } from '../types'
import type {
  TraitEngineResult,
  RiskEngineResult,
} from '@/lib/analysis/engine-v3/types'
import { V3_KO_TO_V4_EN } from './trait-mapper'

/**
 * V3 TraitEngineOutput â†’ V4 TraitScoreV4[] ë³€í™˜
 * 
 * V3 ê²°ê³¼ëŠ” í•œê¸€ í‚¤ì´ë¯€ë¡œ ì˜ë¬¸ í‚¤ë¡œ ë³€í™˜
 */
export function toV4TraitScores(
  v3Result: TraitEngineResult
): TraitScoreV4[] {
  const { indicators, priorityAreas } = v3Result
  const confidence = priorityAreas.length > 0 ? 0.85 : 0.7

  return Object.entries(indicators).map(([koKey, score]) => {
    // V3 í•œê¸€ í‚¤ â†’ V4 ì˜ë¬¸ í‚¤ë¡œ ë³€í™˜
    const enKey = V3_KO_TO_V4_EN[koKey] ?? koKey

    // V3ëŠ” 0-100 ë²”ìœ„, V4ëŠ” 1-10 ë²”ìœ„ì´ë¯€ë¡œ ë³€í™˜ í•„ìš”
    // V3 score (0-100) â†’ V4 (1-10): Math.round(score / 10)
    const v4Score = Math.max(1, Math.min(10, Math.round(score / 10)))

    return {
      traitCode: enKey,
      score: v4Score,
      confidence,
    }
  })
}

/**
 * ì˜ˆë¹„ë¹„ ë¹„ìœ¨ ê³„ì‚°
 */
export function calculateBufferPercentage(
  level: 'low' | 'medium' | 'high',
  additionalRiskCount: number
): number {
  let base = 5 // ê¸°ë³¸ 5%

  // V3 ì‹¬ê°ë„ ë°˜ì˜
  if (level === 'medium') base += 3
  if (level === 'high') base += 5

  // ì¶”ê°€ ìœ„í—˜ ë°˜ì˜
  base += additionalRiskCount * 2

  return Math.min(base, 20) // ìµœëŒ€ 20%
}
```

---

### 3. trait-mapper.ts

**ê²½ë¡œ**: `lib/estimate-v4/converters/trait-mapper.ts`

**ì—­í• **: V3 â†” V4 ì„±í–¥ ì½”ë“œ ë§¤í•‘

```typescript
/**
 * V3 â†” V4 ì„±í–¥ ì½”ë“œ ë§¤í•‘
 * 
 * V3ëŠ” í•œê¸€ í‚¤ë¥¼ ì‚¬ìš©í•˜ê³ , V4ëŠ” ì˜ë¬¸ í‚¤ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ì–‘ë°©í–¥ ë§¤í•‘ í•„ìš”
 */

/**
 * V3 í•œê¸€ í‚¤ â†’ V4 ì˜ë¬¸ í‚¤ ë§¤í•‘
 */
export const V3_KO_TO_V4_EN: Record<string, string> = {
  // ê¸°ë³¸ ì„±í–¥
  'ìˆ˜ë‚©ì¤‘ìš”ë„': 'storage_importance',
  'ë™ì„ ì¤‘ìš”ë„': 'flow_importance',
  'ì¡°ëª…ì·¨í–¥': 'light_importance',
  'ì†ŒìŒë¯¼ê°ë„': 'noise_sensitivity',
  'ê´€ë¦¬ë¯¼ê°ë„': 'cleaning_preference',
  'ìŠ¤íƒ€ì¼ê³ ì§‘ë„': 'style_preference',
  'ìƒ‰ê°ì·¨í–¥': 'color_preference',
  'ê°€ì¡±ì˜í–¥ë„': 'family_impact',
  'ë°˜ë ¤ë™ë¬¼ì˜í–¥ë„': 'pet_friendly',
  'ì˜ˆì‚°íƒ„ë ¥ì„±': 'budget_flexibility',
  'ê³µì‚¬ë³µì¡ë„ìˆ˜ìš©ì„±': 'complexity_tolerance',
  'ì§‘ê°’ë°©ì–´ì˜ì‹': 'value_protection',
}

/**
 * V4 ì˜ë¬¸ í‚¤ â†’ V3 í•œê¸€ í‚¤ ë§¤í•‘
 */
export const V4_EN_TO_V3_KO: Record<string, string> = {
  'storage_importance': 'ìˆ˜ë‚©ì¤‘ìš”ë„',
  'flow_importance': 'ë™ì„ ì¤‘ìš”ë„',
  'light_importance': 'ì¡°ëª…ì·¨í–¥',
  'noise_sensitivity': 'ì†ŒìŒë¯¼ê°ë„',
  'cleaning_preference': 'ê´€ë¦¬ë¯¼ê°ë„',
  'style_preference': 'ìŠ¤íƒ€ì¼ê³ ì§‘ë„',
  'color_preference': 'ìƒ‰ê°ì·¨í–¥',
  'family_impact': 'ê°€ì¡±ì˜í–¥ë„',
  'pet_friendly': 'ë°˜ë ¤ë™ë¬¼ì˜í–¥ë„',
  'budget_flexibility': 'ì˜ˆì‚°íƒ„ë ¥ì„±',
  'complexity_tolerance': 'ê³µì‚¬ë³µì¡ë„ìˆ˜ìš©ì„±',
  'value_protection': 'ì§‘ê°’ë°©ì–´ì˜ì‹',
}
```

---

### 4. risk-mapper.ts

**ê²½ë¡œ**: `lib/estimate-v4/converters/risk-mapper.ts`

**ì—­í• **: ìœ„í—˜ ì½”ë“œ ë° ì‹¬ê°ë„ ë§¤í•‘

```typescript
/**
 * V3 â†” V4 ìœ„í—˜ ì½”ë“œ ë§¤í•‘
 */

/**
 * V3 ì‹¬ê°ë„ â†’ ì ìˆ˜ ë§¤í•‘
 */
export const RISK_SEVERITY_MAP: Record<string, number> = {
  'low': 10,
  'medium': 25,
  'high': 50,
}

/**
 * í›„íšŒìœ„í—˜ ì½”ë“œ ë° ì„¤ëª…
 */
export const REGRET_RISK_CODES = {
  'first_time_buyer': {
    message: 'ì²« ì¸í…Œë¦¬ì–´ ê²½í—˜ìœ¼ë¡œ ì˜ˆìƒì¹˜ ëª»í•œ ìƒí™©ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    severity: 'medium' as const,
    bufferAdd: 3,
  },
  'tight_budget': {
    message: 'ì˜ˆì‚° ì—¬ìœ ê°€ ì—†ì–´ ì¶”ê°€ ë¹„ìš© ë°œìƒ ì‹œ ì–´ë ¤ì›€ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    severity: 'medium' as const,
    bufferAdd: 2,
  },
  'old_building': {
    message: '20ë…„ ì´ìƒ ê±´ë¬¼ì€ ìˆ¨ì€ í•˜ì ë°œê²¬ í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤.',
    severity: 'high' as const,
    bufferAdd: 5,
  },
  'large_family': {
    message: 'ê°€ì¡± êµ¬ì„±ì›ì´ ë§ì•„ ì˜ê²¬ ì¡°ìœ¨ì´ í•„ìš”í•©ë‹ˆë‹¤.',
    severity: 'low' as const,
    bufferAdd: 1,
  },
  'joint_decision': {
    message: 'ê³µë™ ì˜ì‚¬ê²°ì •ìœ¼ë¡œ ì§„í–‰ ì†ë„ê°€ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    severity: 'low' as const,
    bufferAdd: 1,
  },
} as const
```

---

## Store ê´€ë¦¬

### personalityV5.store.ts

**ê²½ë¡œ**: `lib/store/personalityV5.store.ts`

**ì—­í• **: V5 ì„±í–¥ë¶„ì„ ê²°ê³¼ ì „ì—­ ìƒíƒœ ê´€ë¦¬

```typescript
/**
 * V5 ì„±í–¥ë¶„ì„ ê²°ê³¼ ì „ìš© Store
 * 
 * ë‹¨ì¼ ì§„ì‹¤ ì €ì¥ì†Œ (Single Source of Truth)
 * - í˜ì´ì§€ ìƒëª…ì£¼ê¸° ì˜ì¡´ âŒ
 * - props ì „ë‹¬ âŒ
 * - ì „ì—­ Storeë¡œ ê³„ì•½ ê³ ì • â­•
 */

import { create } from 'zustand';
import type { PersonalityV5Result } from '@/lib/analysis/decision-impact/v5-result.types';

interface PersonalityV5State {
  /**
   * V5 ì„±í–¥ë¶„ì„ ê²°ê³¼
   * nullì´ë©´ ì•„ì§ ë¶„ì„ ì™„ë£Œë˜ì§€ ì•ŠìŒ
   */
  v5Result: PersonalityV5Result | null;

  /**
   * V5 ê²°ê³¼ ì„¤ì •
   */
  setV5Result: (result: PersonalityV5Result) => void;

  /**
   * V5 ê²°ê³¼ ì´ˆê¸°í™”
   */
  clearV5Result: () => void;
}

export const usePersonalityV5Store = create<PersonalityV5State>((set) => ({
  v5Result: null,

  setV5Result: (result) =>
    set({
      v5Result: result,
    }),

  clearV5Result: () =>
    set({
      v5Result: null,
    }),
}));
```

---

## ì „ì²´ ì‹¤í–‰ íë¦„

### 1. ì‚¬ìš©ì ì…ë ¥ ìˆ˜ì§‘

```typescript
// CollectedInputV4 í˜•ì‹
{
  answers: [
    { questionId: 'quick_first_scene', answerId: 'hotel_hallway' },
    // ... ë” ë§ì€ ë‹µë³€
  ],
  spaceInfo: {
    housingType: 'apartment',
    pyeong: 30,
    rooms: 3,
    bathrooms: 2,
    buildingAge: 10,
    floor: 5,
  },
  preferences: {
    budget: { min: 5000, max: 10000, flexibility: 'moderate' },
    family: {
      totalPeople: 3,
      hasInfant: false,
      hasChild: true,
      hasElderly: false,
      hasPet: false,
    },
    lifestyle: {
      remoteWork: true,
      cookOften: true,
      guestsOften: false,
    },
    purpose: 'live',
  },
}
```

### 2. V4 PersonalityEngine ì‹¤í–‰

```typescript
import { analyzePersonality } from '@/lib/estimate-v4/engines/personality'

const result = await analyzePersonality(input)
```

**ë‚´ë¶€ ì²˜ë¦¬ ìˆœì„œ**:
1. **TraitScorer**: 
   - V4 ì…ë ¥ â†’ V3 ì…ë ¥ ë³€í™˜
   - V3 TraitEngine í˜¸ì¶œ
   - V3 ê²°ê³¼ â†’ V4 ì ìˆ˜ ë³€í™˜
   
2. **TypeClassifier**:
   - ì ìˆ˜ ê¸°ë°˜ ìƒí™œ/ê°€ì¡±/ì„±ê²© ìœ í˜• ë¶„ë¥˜
   
3. **RiskAssessor**:
   - í›„íšŒìœ„í—˜ í‰ê°€
   - ì˜ˆë¹„ë¹„ ë¹„ìœ¨ ê³„ì‚°
   
4. **ProblemClassification**:
   - ì…ì§€í˜• vs ê³µê°„í˜• ë¶ˆí¸ ë¶„ë¥˜

### 3. V3 TraitEngine ë‚´ë¶€ ì²˜ë¦¬

```typescript
// 1. ì§ˆë¬¸ ê¸°ì¤€í‘œ ë¡œë“œ
const criteria = await loadQuestionCriteria()

// 2. ì´ˆê¸° ì§€í‘œ ìƒì„± (ëª¨ë‘ 50ì )
let indicators = createDefaultIndicators()

// 3. ë‹µë³€ë³„ ì˜í–¥ ì ìš©
for (const [questionId, answerId] of Object.entries(input.answers)) {
  // answer-mappingsì—ì„œ ë¨¼ì € ì°¾ê¸°
  const answerMappingsImpacts = getAnswerImpacts(questionId, answerId)
  
  if (answerMappingsImpacts) {
    // answer-mappings í˜•ì‹ ë³€í™˜
    impact = convertAnswerMappingsToImpact(answerMappingsImpacts)
  } else {
    // ì§ˆë¬¸ ê¸°ì¤€í‘œì—ì„œ ì°¾ê¸°
    impact = getAnswerImpact(criteria, questionId, answerId)
  }
  
  // ì§€í‘œ ì ìˆ˜ ë³€í™” ì ìš©
  if (impact.indicators) {
    for (const [indicator, change] of Object.entries(impact.indicators)) {
      indicators[indicator] += change.value
    }
  }
}

// 4. SpaceInfo ê¸°ë°˜ ì¶”ê°€ ì¡°ì •
indicators = adjustBySpaceInfo(indicators, input.spaceInfo)

// 5. VibeInput ê¸°ë°˜ ì¶”ê°€ ì¡°ì • (ì˜µì…˜)
if (input.vibeInput) {
  indicators = adjustByVibeInput(indicators, input.vibeInput)
}

// 6. ìš°ì„  ë¬¸ì œ ì˜ì—­ ë„ì¶œ
const priorityAreas = identifyPriorityAreas(indicators)

// 7. ìƒí™œ ë£¨í‹´ ìœ í˜• íŒë‹¨
const lifestyleType = determineLifestyleType(lifestyleTypes)
```

### 4. ìµœì¢… ê²°ê³¼ ë°˜í™˜

```typescript
// PersonalityResultV4 í˜•ì‹
{
  traitScores: [
    { traitCode: 'storage_importance', score: 8, confidence: 0.85 },
    { traitCode: 'flow_importance', score: 7, confidence: 0.85 },
    // ... 12ê°œ ì„±í–¥ ì ìˆ˜
  ],
  classifiedTypes: {
    lifestyle: ['remote_work', 'cooking_focused'],
    family: ['has_child'],
    personality: ['clean_oriented', 'storage_focused'],
    decision: 'joint',
  },
  riskAssessment: {
    totalScore: 35,
    level: 'medium',
    triggeredRisks: ['tight_budget', 'joint_decision'],
    bufferPercentage: 10,
  },
  problemClassification: {
    locationScore: 0.3,
    spaceScore: 0.7,
    recommendation: 'remodel',
    message: 'ê³µê°„ êµ¬ì¡° ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.',
  },
  analyzedAt: '2024-01-01T00:00:00.000Z',
}
```

---

## ì£¼ìš” íŒŒì¼ ê²½ë¡œ ìš”ì•½

### V4 PersonalityEngine
- `lib/estimate-v4/engines/personality/PersonalityEngineV4.ts` - ë©”ì¸ ì—”ì§„
- `lib/estimate-v4/engines/personality/TraitScorer.ts` - ì ìˆ˜ ê³„ì‚°
- `lib/estimate-v4/engines/personality/TypeClassifier.ts` - íƒ€ì… ë¶„ë¥˜
- `lib/estimate-v4/engines/personality/RiskAssessor.ts` - ìœ„í—˜ í‰ê°€
- `lib/estimate-v4/engines/personality/index.ts` - ë°°ëŸ´ export

### V3 TraitEngine
- `lib/analysis/engine-v3/engines/TraitEngine.ts` - í•µì‹¬ ë¡œì§
- `lib/analysis/engine-v3/types.ts` - íƒ€ì… ì •ì˜

### ë³€í™˜ê¸°
- `lib/estimate-v4/converters/input-converter.ts` - V4 â†’ V3 ì…ë ¥ ë³€í™˜
- `lib/estimate-v4/converters/output-converter.ts` - V3 â†’ V4 ì¶œë ¥ ë³€í™˜
- `lib/estimate-v4/converters/trait-mapper.ts` - ì„±í–¥ ì½”ë“œ ë§¤í•‘
- `lib/estimate-v4/converters/risk-mapper.ts` - ìœ„í—˜ ì½”ë“œ ë§¤í•‘

### ë°ì´í„° ì†ŒìŠ¤
- `lib/analysis/answer-mappings.ts` - ë‹µë³€ ë§¤í•‘ í…Œì´ë¸”
- `lib/traits/question-criteria-v3.json` - ì§ˆë¬¸ ê¸°ì¤€í‘œ
- `lib/db/adapters/personality-adapter.ts` - Supabase ì–´ëŒ‘í„°
- `lib/analysis/vibeAnalyzer.ts` - MBTI/í˜ˆì•¡í˜•/ë³„ìë¦¬ ë¶„ì„

### Store
- `lib/store/personalityV5.store.ts` - V5 ê²°ê³¼ ì „ì—­ ìƒíƒœ

### íƒ€ì… ì •ì˜
- `lib/estimate-v4/types/personality.types.ts` - V4 ì„±í–¥ íƒ€ì…
- `lib/estimate-v4/types/index.ts` - V4 íƒ€ì… ë°°ëŸ´

---

## ì ìˆ˜ ì²´ê³„ ë¹„êµ

| í•­ëª© | V3 | V4 |
|------|----|----|
| **í‚¤ í˜•ì‹** | í•œê¸€ (`ìˆ˜ë‚©ì¤‘ìš”ë„`) | ì˜ë¬¸ (`storage_importance`) |
| **ì ìˆ˜ ë²”ìœ„** | 0-100 | 1-10 |
| **ê¸°ë³¸ê°’** | 50 | 5 |
| **ë³€í™˜ ê³µì‹** | - | V4 = V3 / 10 (ë°˜ì˜¬ë¦¼) |
| | | V3 = V4 * 10 |

---

## ë°ì´í„° ì†ŒìŠ¤ ìš°ì„ ìˆœìœ„

1. **answer-mappings.ts** (ìµœìš°ì„ )
   - íŒë‹¨ ì¶• ì§ˆë¬¸ ë“± ì§ì ‘ ë§¤í•‘
   - 1-10 ì ìˆ˜ ì²´ê³„

2. **ì§ˆë¬¸ ê¸°ì¤€í‘œ (JSON)**
   - Quick/Standard/Deep ëª¨ë“œë³„ ì§ˆë¬¸
   - -50~+50 ì˜í–¥ê°’

3. **Supabase DB**
   - ë™ì  ë§¤í•‘ ë°ì´í„°
   - ìì¬ ì¶”ì²œ

4. **VibeInput (MBTI/í˜ˆì•¡í˜•/ë³„ìë¦¬)**
   - ì¶”ê°€ ì¡°ì •ìš©
   - ê°€ì¤‘ì¹˜ ì ìš©

---

## í™•ì¥ í¬ì¸íŠ¸

### ìƒˆë¡œìš´ ì„±í–¥ ì§€í‘œ ì¶”ê°€ ì‹œ

1. **V3 íƒ€ì…ì— ì¶”ê°€** (`lib/analysis/engine-v3/types.ts`)
   ```typescript
   export interface TraitIndicators12 {
     // ... ê¸°ì¡´ 12ê°œ
     ìƒˆë¡œìš´ì§€í‘œ: number  // 13ë²ˆì§¸ ì¶”ê°€
   }
   ```

2. **V4 íƒ€ì…ì— ì¶”ê°€** (`lib/estimate-v4/types/personality.types.ts`)
   ```typescript
   export interface TraitScoreV4 {
     traitCode: 'new_trait'
     score: number
     confidence: number
   }
   ```

3. **ë§¤í•‘ ì¶”ê°€** (`lib/estimate-v4/converters/trait-mapper.ts`)
   ```typescript
   export const V3_KO_TO_V4_EN: Record<string, string> = {
     'ìƒˆë¡œìš´ì§€í‘œ': 'new_trait',
   }
   ```

4. **ì§ˆë¬¸ ê¸°ì¤€í‘œì— ì˜í–¥ ì¶”ê°€**
   - `lib/traits/question-criteria-v3.json`
   - ê° ë‹µë³€ì˜ `impact.indicators`ì— ìƒˆ ì§€í‘œ ì¶”ê°€

### ìƒˆë¡œìš´ ë°ì´í„° ì†ŒìŠ¤ ì¶”ê°€ ì‹œ

1. **ì–´ëŒ‘í„° í•¨ìˆ˜ ì‘ì„±**
   ```typescript
   export async function getNewDataSource(
     questionId: string,
     answerId: string
   ): Promise<AnswerImpact[] | null> {
     // ìƒˆ ë°ì´í„° ì†ŒìŠ¤ ì¡°íšŒ ë¡œì§
   }
   ```

2. **TraitEngineì— í†µí•©**
   ```typescript
   // TraitEngine.analyze() ë‚´ë¶€
   const newDataSourceImpacts = await getNewDataSource(questionId, answerId)
   if (newDataSourceImpacts) {
     impact = convertNewDataSourceToImpact(newDataSourceImpacts)
   }
   ```

---

## ì£¼ì˜ì‚¬í•­

1. **ì ìˆ˜ ë²”ìœ„ ê²€ì¦**
   - V3: 0-100 ë²”ìœ„ ìœ ì§€ (`validateIndicatorRange`)
   - V4: 1-10 ë²”ìœ„ ìœ ì§€ (ë³€í™˜ ì‹œ ìë™ ì²˜ë¦¬)

2. **í‚¤ ë³€í™˜ í•„ìˆ˜**
   - V3 í•œê¸€ í‚¤ â†” V4 ì˜ë¬¸ í‚¤ ë³€í™˜ í•„ìˆ˜
   - `trait-mapper.ts`ì˜ ë§¤í•‘ í…Œì´ë¸” ìœ ì§€

3. **Fallback ì²˜ë¦¬**
   - ë°ì´í„° ì†ŒìŠ¤ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ë°˜í™˜
   - ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ ì ìˆ˜ (5ì ) ë°˜í™˜

4. **ì„±ëŠ¥ ìµœì í™”**
   - ì§ˆë¬¸ ê¸°ì¤€í‘œëŠ” í•œ ë²ˆë§Œ ë¡œë“œ (ìºì‹±)
   - ë‹µë³€ë³„ ì˜í–¥ì€ ìˆœì°¨ ì²˜ë¦¬ (ì˜ì¡´ì„± ê³ ë ¤)

---

## ê²°ë¡ 

ì¸í…Œë¦¬ë´‡ì˜ ì„±í–¥ë¶„ì„ ì‹œìŠ¤í…œì€ **V4 PersonalityEngine**ì´ ë©”ì¸ ì¸í„°í˜ì´ìŠ¤ì´ë©°, ë‚´ë¶€ì ìœ¼ë¡œ **V3 TraitEngine**ì„ í˜¸ì¶œí•˜ëŠ” 2ë‹¨ê³„ êµ¬ì¡°ì…ë‹ˆë‹¤. 

**í•µì‹¬ íŠ¹ì§•**:
- âœ… V3ì™€ V4 ì–‘ë°©í–¥ í˜¸í™˜
- âœ… ë‹¤ì¤‘ ë°ì´í„° ì†ŒìŠ¤ ì§€ì› (answer-mappings, JSON, DB, VibeInput)
- âœ… 12ê°œ ì„±í–¥ ì§€í‘œ ì²´ê³„
- âœ… íƒ€ì… ë¶„ë¥˜ ë° ìœ„í—˜ í‰ê°€ í™•ì¥
- âœ… í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°

**ì£¼ìš” ê°œì„ ì **:
- V4 ì¸í„°í˜ì´ìŠ¤ë¡œ í†µì¼ (ì˜ë¬¸ í‚¤, 1-10 ì ìˆ˜)
- í›„íšŒìœ„í—˜ í‰ê°€ ì¶”ê°€
- íƒ€ì… ë¶„ë¥˜ ê¸°ëŠ¥ ì¶”ê°€
- ë¬¸ì œ ìœ í˜• ë¶„ë¥˜ ê¸°ëŠ¥ ì¶”ê°€

---

**ë¬¸ì„œ ì‘ì„±ì¼**: 2024ë…„  
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2024ë…„  
**ì‘ì„±ì**: AI Assistant




