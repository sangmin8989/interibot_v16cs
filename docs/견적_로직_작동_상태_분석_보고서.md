# 견적 로직 작동 상태 분석 보고서

## 📋 개요

**작성일**: 2024년 12월  
**분석 대상**: 인테리봇 견적 계산 시스템 V3  
**목적**: 현재 견적 로직이 제대로 작동하는지 종합 분석

---

## ✅ 정상 작동하는 부분

### 1. 평수 계산 로직 (부분 개선됨)

**위치**: `app/onboarding/estimate/page.tsx` (443-525줄)

**현재 로직**:
1. ✅ `spaceInfo.pyeong`이 있으면 무조건 그대로 사용 (최우선)
2. ✅ 없으면 `approximateRange`에서 대표값 추출 (fallback)
3. ✅ 평수 불일치 감지 및 강제 수정 로직 존재

**문제점**:
- ⚠️ 평수 계산이 여러 단계를 거쳐서 복잡함
- ⚠️ 불일치 감지 후 강제 수정하는 로직이 있지만, 이게 실행되기 전에 이미 API에 전달될 수 있음

**권장사항**:
- 평수 계산을 단순화하고, 입력값을 절대 변경하지 않는 원칙을 더 엄격하게 적용

---

### 2. 공정 선택 로직 (복잡하지만 작동함)

**위치**: `app/onboarding/estimate/page.tsx` (615-740줄)

**현재 로직**:
1. ✅ 선택된 공간에 해당하는 공정만 필터링
2. ✅ 고객 정보 기반 자동 공정 추가 (욕실/방 개수)
3. ✅ `mergedProcessesBySpace`로 병합
4. ✅ `processSelections`에서 공정 추출 (B안)
5. ✅ `tierSelections`에서 공정 추출 (A안 - B안 없을 때)
6. ✅ 공간 기반 공정 추론 (3차 fallback)

**문제점**:
- ⚠️ 공정 추출 경로가 3개나 있어서 예상치 못한 동작 가능
- ⚠️ 각 경로의 우선순위가 명확하지 않을 수 있음

**권장사항**:
- 공정 추출 로직을 단순화하고, 우선순위를 명확히 정의

---

### 3. API 레벨 검증 (잘 작동함)

**위치**: `app/api/estimate/v3/route.ts` (21-62줄)

**현재 로직**:
1. ✅ 평수 검증: 0 이하 시 에러
2. ✅ 등급 검증: 유효한 값만 허용
3. ✅ `processSelections` 검증: 없으면 에러 (단, `mode="FULL"`은 허용)

**평가**: ✅ **정상 작동**

---

### 4. Calculator V3 로직 (복잡하지만 구조는 좋음)

**위치**: `lib/estimate/calculator-v3.ts`

**현재 로직**:
1. ✅ `processSelections`가 단일 진실 소스
2. ✅ `mode="FULL"`일 때만 전체 시공
3. ✅ `extractProcessesFromSelections()` 함수로 공정 추출
4. ✅ 각 공정별 활성화 여부 엄격하게 판단

**문제점**:
- ⚠️ 로직이 매우 복잡하고, 여러 조건문이 중첩됨
- ⚠️ `hasAllProcesses`가 `mode="FULL"`에만 의존하는데, 이게 제대로 전달되는지 확인 필요

**권장사항**:
- 로직을 단순화하고, 각 조건의 의미를 명확히 문서화

---

## ⚠️ 잠재적 문제점

### 1. 평수 전달 문제

**위치**: `app/onboarding/estimate/page.tsx` (799-815줄)

**문제**:
```typescript
const baseInput: Omit<EstimateInputV3, 'grade'> = {
  py: finalPyForEstimate, // ✅ 이미 확정된 최종 평수 사용
  // ...
}
```

**잠재적 문제**:
- `finalPyForEstimate`가 계산 과정에서 변경될 수 있음
- 불일치 감지 로직이 있지만, API 호출 전에 실행되는지 확인 필요

**확인 필요**:
- 실제로 `spaceInfo.pyeong`과 `baseInput.py`가 항상 일치하는지 로그 확인

---

### 2. 공정 선택 누락 가능성

**위치**: `app/onboarding/estimate/page.tsx` (686-691줄)

**문제**:
```typescript
const hasValidProcessSelections = mergedProcessesBySpace && 
  Object.keys(mergedProcessesBySpace).length > 0 &&
  Object.values(mergedProcessesBySpace).some(selections => 
    selections && Object.keys(selections).length > 0 &&
    Object.values(selections).some(value => value !== null && value !== 'none')
  )
```

**잠재적 문제**:
- `hasValidProcessSelections`가 `false`일 때 `mode="FULL"`로 설정하는 로직이 있지만, 이게 제대로 작동하는지 확인 필요

**확인 필요**:
- 공정이 없을 때 실제로 `mode="FULL"`이 설정되는지 로그 확인

---

### 3. 전체 공정 모드 판단 로직

**위치**: `app/onboarding/estimate/page.tsx` (795-814줄)

**문제**:
```typescript
const isFullProcess = (!hasValidProcessSelections && v3SelectedSpaces.length >= 5) || 
                      (v3SelectedSpaces.length >= 8) // 공간 8개 이상 선택 시 전체 공정으로 간주

// ...
...(isFullProcess && { mode: 'FULL' as any })
```

**잠재적 문제**:
- 공간 5개 이상 선택 시 전체 공정으로 간주하는 로직이 있지만, 이게 의도한 동작인지 확인 필요
- `mode="FULL"`이 `as any`로 캐스팅되어 있어서 타입 안정성이 떨어짐

**확인 필요**:
- 실제로 전체 공정 모드가 올바르게 설정되는지 로그 확인

---

### 4. 입주 청소 계산

**위치**: `lib/estimate/calculator-v3.ts` (946-948줄)

**현재 로직**:
```typescript
cleaningArea = py;  // 고객 입력 평수 그대로 사용
cleaningCost = cleaningArea * 20000;  // 평당 2만원
```

**평가**: ✅ **정상 작동** (이미 수정됨)

---

### 5. 조명/전기 자동 포함 문제

**위치**: `lib/estimate/calculator-v3.ts` (648-653줄, 415줄)

**현재 로직**:
```typescript
includeLighting = false  // ✅ 기본값을 false로 변경: 고객이 선택하지 않으면 포함하지 않음

const hasElectric = hasAllProcesses || (
  finalEnabledProcessIds.includes('electric') || 
  extractedData.hasElectricLighting
);
```

**평가**: ✅ **정상 작동** (이미 수정됨)

---

## 🔍 종합 평가

### 작동 상태: ⚠️ **부분적으로 작동하지만 개선 필요**

**이유**:
1. ✅ **정상 작동**: API 검증, 입주 청소 계산, 조명/전기 자동 포함 방지
2. ⚠️ **개선 필요**: 평수 계산 로직 복잡성, 공정 선택 로직 복잡성, 전체 공정 모드 판단 로직

---

## 📊 주요 문제점 요약

### 1. 평수 계산 로직의 복잡성
- **문제**: 여러 단계를 거쳐서 계산하고, 불일치 감지 후 강제 수정하는 로직이 있음
- **영향**: 평수가 예상과 다르게 계산될 수 있음
- **해결**: 평수 계산을 단순화하고, 입력값을 절대 변경하지 않는 원칙을 더 엄격하게 적용

### 2. 공정 선택 로직의 복잡성
- **문제**: 공정 추출 경로가 3개나 있어서 예상치 못한 동작 가능
- **영향**: 선택한 공정이 누락되거나, 선택하지 않은 공정이 포함될 수 있음
- **해결**: 공정 추출 로직을 단순화하고, 우선순위를 명확히 정의

### 3. 전체 공정 모드 판단 로직
- **문제**: 공간 5개 이상 선택 시 전체 공정으로 간주하는 로직이 있지만, 이게 의도한 동작인지 확인 필요
- **영향**: 부분 공정을 선택했는데 전체 공정으로 계산될 수 있음
- **해결**: 전체 공정 모드 판단 로직을 명확히 하고, 사용자 의도와 일치하는지 확인

---

## 🛠️ 권장 수정 사항

### Priority 1: 평수 계산 단순화

**수정 위치**: `app/onboarding/estimate/page.tsx` (443-525줄)

**수정 내용**:
```typescript
// ✅ 단순화: 입력한 평수를 절대 변경하지 않음
let finalPyForEstimate = spaceInfo.pyeong || 0

// approximateRange는 fallback으로만 사용
if (finalPyForEstimate <= 0 && spaceInfo.approximateRange) {
  const approximateToActual: Record<string, number> = {
    '20평대': 22,
    '30평대': 32, 
    '40평대': 42,
    '50평 이상': 55
  }
  finalPyForEstimate = approximateToActual[spaceInfo.approximateRange] || 32
}

// 검증
if (finalPyForEstimate <= 0) {
  setError('평수 정보가 없습니다.')
  return
}
```

---

### Priority 2: 공정 선택 로직 단순화

**수정 위치**: `app/onboarding/estimate/page.tsx` (615-780줄)

**수정 내용**:
1. `processSelections`에서 공정 추출 (최우선)
2. `tierSelections`에서 공정 추출 (fallback)
3. 공간 기반 공정 추론 제거 (복잡성 증가)

---

### Priority 3: 전체 공정 모드 판단 로직 명확화

**수정 위치**: `app/onboarding/estimate/page.tsx` (795-814줄)

**수정 내용**:
```typescript
// ✅ 명확한 조건: processSelections가 없고, 공간이 8개 이상 선택되었을 때만 전체 공정
const isFullProcess = !hasValidProcessSelections && v3SelectedSpaces.length >= 8

// 또는 사용자가 명시적으로 "전체 공정"을 선택한 경우
const isExplicitFullProcess = tierSelections?.all?.enabled === true

const shouldUseFullMode = isFullProcess || isExplicitFullProcess
```

---

## 📝 테스트 권장 사항

### 1. 평수 일치 테스트
- [ ] 25평 입력 → 25평으로 계산되는지 확인
- [ ] 32평 입력 → 32평으로 계산되는지 확인
- [ ] approximateRange 사용 시 올바른 평수로 변환되는지 확인

### 2. 공정 선택 테스트
- [ ] 주방만 선택 → 주방 공정만 포함되는지 확인
- [ ] 욕실만 선택 → 욕실 공정만 포함되는지 확인
- [ ] 공정 없이 공간만 선택 → 올바른 에러 메시지 표시되는지 확인

### 3. 전체 공정 모드 테스트
- [ ] 공간 8개 이상 선택 → 전체 공정 모드로 계산되는지 확인
- [ ] 공간 5개 선택 → 부분 공정으로 계산되는지 확인
- [ ] "전체 공정" 명시적 선택 → 전체 공정 모드로 계산되는지 확인

---

## 🎯 결론

**현재 상태**: ⚠️ **부분적으로 작동하지만 개선 필요**

**주요 문제**:
1. 평수 계산 로직의 복잡성
2. 공정 선택 로직의 복잡성
3. 전체 공정 모드 판단 로직의 불명확성

**권장 조치**:
1. 평수 계산 로직 단순화 (Priority 1)
2. 공정 선택 로직 단순화 (Priority 2)
3. 전체 공정 모드 판단 로직 명확화 (Priority 3)
4. 종합 테스트 수행

**예상 효과**:
- 평수 일치 문제 해결
- 공정 선택 누락 문제 해결
- 전체 공정 모드 오동작 문제 해결
- 코드 유지보수성 향상

---

## 📅 작성일
2024년 12월

## 📌 버전
V3 (calculator-v3.ts 기준)









