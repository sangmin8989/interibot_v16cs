# Phase 8 — 적용 전략 지시문 (A/B 선택형)

> **버전**: 1.0 (고정본)  
> **작성일**: 2025-01-21  
> **상태**: 전략 지시문 (Phase 7.5 통과 후 적용)

---

## Phase 8A — IMAGE Level 2 (하드 제한) 부분 적용 [권장 시나리오]

### 목적
- 비용 폭증 차단
- 악용성 연속 호출 명확 차단
- 정상 UX 영향 최소화

### 적용 조건 (Phase 7.5 통과 후)

| 조건 | 기준 |
|------|------|
| 체감 제한 비율 | ≤ 3% |
| 실패율 | 안정 (변화 없음) |
| p95 | 개선 또는 유지 |

**→ 위 조건 모두 충족 시 Phase 8A 진입**

---

### 적용 범위 (아주 제한적)

#### ON
- `IMAGE_GENERATE` 중 연속 호출 과다 세션
  - 기준: N초 내 연속 M회 이상
  - 예시: 10초 내 3회 이상

#### OFF (절대 건드리지 않음)
- `IMAGE_PROMPT`
- `VISION_ANALYSIS`
- 전체 `CHAT` / 분석 / 견적

---

### 제한 방식 (Level 2)

#### 행동
- 요청 차단 (HTTP 429 또는 내부 에러 코드)
- 대체 UX 제공

#### 대체 UX
1. **안내 메시지**
   ```
   "이미지 생성 요청이 많아 잠시 제한되었습니다"
   ```

2. **텍스트 설명 결과 제공**
   - 이미지 대신 텍스트 기반 설명 제공
   - 스타일 키워드, 색상 팔레트 등

3. **이전 이미지 재사용 제안**
   - 최근 생성된 이미지 재사용 옵션
   - 캐시된 결과 반환

---

### 보호 규칙 (강제)

1. **첫 요청 무조건 통과**
   - 세션의 첫 IMAGE_GENERATE 호출은 항상 성공

2. **정상 사용자 99% 무영향**
   - 연속 호출 과다 세션만 제한
   - 일반 사용자는 영향 없음

3. **제한은 세션 단위**
   - 세션별로 독립적으로 판단
   - 다른 세션에 영향 없음

---

### 롤백

**환경변수 변경:**
```env
NEXT_PUBLIC_AI_RATE_LIMIT=false
```

**재배포 1회**

**추가 조치 없음**

---

### 성공 기준

- ✅ IMAGE 비용 유의미 감소
- ✅ UX 이슈 0
- ✅ CHAT/견적 무영향

---

## Phase 8B — Phase 7 유지 (동결 전략)

### 선택 조건

| 조건 | 설명 |
|------|------|
| 비용/부하 이미 안정 | IMAGE 비용 비중 감소 또는 유지 |
| Soft Delay만으로 충분 | Level 1로 충분한 효과 |
| UX 민감도가 높은 경우 | 사용자 경험 최우선 |

**→ 위 조건 중 2개 이상 충족 시 Phase 8B 선택**

---

### 전략

- **Level 1 유지**
  - 현재 Phase 7 상태 유지
  - 추가 제한 없음

- **정책 변경 없음**
  - 코드 변경 없음
  - 환경변수 변경 없음

- **관측만 지속 (주 1회)**
  - 주간 모니터링 리포트 작성
  - 트리거 기준 재평가

---

### 장점

- ✅ 리스크 최소
- ✅ 운영 안정성 최고
- ✅ 불필요한 복잡도 차단

---

## 최종 정리 (중요)

### Phase 7.5는 숫자 수집 단계
- 실제 적용 없음
- 관측 및 분석만 수행
- Phase 8 진입 판단 근거 수집

### Phase 8은 선택 단계
- Phase 8A: Level 2 부분 적용 (비용 폭증 차단)
- Phase 8B: Level 1 유지 (안정성 우선)

### 어떤 경우든 보호 대상 (끝까지)
- ✅ `CHAT`
- ✅ `TRAIT_ANALYSIS`
- ✅ `ESTIMATE_AI`
- ✅ `SUMMARY`
- ✅ `PROCESS_RECOMMEND`
- ✅ `OPTION_RECOMMEND`

**→ 위 라우트는 절대 제한하지 않음**

---

## Phase 8A 구현 체크리스트 (진입 시)

### 코드 구현
- [ ] 연속 호출 과다 세션 판별 로직
- [ ] Level 2 하드 제한 로직 (차단)
- [ ] 대체 UX 제공 로직
- [ ] 첫 요청 통과 로직 (강제)

### 모니터링
- [ ] 차단된 요청 수 추적
- [ ] 대체 UX 제공 비율
- [ ] UX 이슈 리포트 수집

### 테스트
- [ ] 첫 요청 통과 테스트
- [ ] 연속 호출 차단 테스트
- [ ] 대체 UX 제공 테스트
- [ ] 롤백 테스트

---

## Phase 8B 유지 체크리스트 (선택 시)

### 관측 지속
- [ ] 주간 모니터링 리포트 작성
- [ ] 트리거 기준 재평가
- [ ] 비용/부하 추이 확인

### 정책 검토
- [ ] Level 1 효과 지속 확인
- [ ] 추가 제한 필요성 평가
- [ ] Phase 8A 진입 조건 재검토

---

## 의사결정 플로우

```
Phase 7.5 관측 완료
    ↓
지표 분석
    ↓
┌─────────────────┬─────────────────┐
│ Phase 8A 조건 충족? │ Phase 8B 조건 충족? │
└─────────────────┴─────────────────┘
    ↓                    ↓
Phase 8A 진입      Phase 8B 유지
(Level 2 적용)    (Level 1 동결)
```

---

**문서 끝**

**버전:** 1.0 (고정본)  
**작성일:** 2025-01-21  
**상태:** 전략 지시문 (Phase 7.5 통과 후 적용)


