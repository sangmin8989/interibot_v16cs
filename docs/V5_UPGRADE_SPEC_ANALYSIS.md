# 인테리봇 V5 업그레이드 명세서 분석 보고서

## 📋 명세서 핵심 요구사항 요약

### 최상위 강제 규칙
- ✅ 기존 폴더/파일 구조 변경 금지
- ✅ 새 폴더 생성 금지
- ✅ 새 파일 생성 금지
- ✅ 기존 함수명, 타입명, API 엔드포인트 유지
- ✅ UI 수정 금지 (로직만 수정)
- ✅ 견적 숫자 계산 로직 추가·수정 금지

### 작업 목표
1. **고객 입력 정보가 실제로 반영되는 질문 로직**
2. **불필요한 질문 제거, 핵심 질문만 남김**
3. **질문 → 검증 → 폐기/확정 구조 강제 루프**
4. **고객이 답하기 곤란한 상황 구조적 처리**
5. **색상 파렛트 기능 추가 (질문이 아닌 범위 제안)**

---

## 🔍 현재 코드베이스 분석

### 1. 고객 입력 데이터 생성/저장 위치

#### 저장 위치
- **`lib/store/spaceInfoStore.ts`**: `SpaceInfo` 타입으로 저장
  - `pyeong`, `housingType`, `rooms`, `bathrooms`
  - `familySizeRange`, `totalPeople`, `ageRanges`, `ageGroups`
  - `lifestyleTags`, `budget`, `budgetAmount`
  - `livingPurpose`, `livingYears`
  - `additionalNotes` (✅ 매우 중요!)
  - `specialConditions` (hasPets, hasElderly 등)

#### 질문 생성 시 참조 위치
- **`app/api/generate-questions/route.ts`**
  - `buildCustomerProfile(spaceInfo)`: 고객 정보를 한국어 요약으로 변환
  - `customerProfile`을 AI 프롬프트에 포함

### 2. 질문 생성 함수 목록

#### 메인 질문 생성 함수
- **`app/api/generate-questions/route.ts`** → `POST` 핸들러
  - OpenAI GPT-3.5-turbo 사용
  - `buildCustomerProfile()`로 고객 정보 요약 생성
  - 시스템 프롬프트에 V3.1 설계서 규칙 포함
  - 모드별 질문 개수: `quick: 4`, `standard: 10`, `deep: 18`, `vibe: 7`

#### 질문 호출 위치
- **`app/onboarding/personality/page.tsx`**
  - `loadAIQuestions(mode)` 함수
  - `/api/generate-questions` API 호출
  - 최대 7개로 제한 (`slice(0, 7)`)

### 3. 질문 생성 시 참조하는 고객 입력 값

#### 현재 참조하는 값 (buildCustomerProfile 기준)
```typescript
// 항상 포함
- housingType (주거형태)
- pyeong (평수)
- rooms (방 개수)
- bathrooms (욕실 개수)

// 있을 때만 포함
- familySizeRange, totalPeople (가족 규모)
- ageRanges, ageGroups (연령대)
- additionalNotes (✅ 매우 중요!)
- lifestyleTags (라이프스타일)
- budget, budgetAmount (예산)
- livingPurpose, livingYears (거주 목적/기간)
```

#### AI 프롬프트에서 명시하는 규칙
- ✅ "이미 제공된 정보를 다시 물어보는 질문 절대 금지"
- ✅ "추가 정보(additionalNotes)가 있으면 반드시 활용"
- ⚠️ **하지만 실제 검증 로직은 AI에 의존 (코드 레벨 검증 없음)**

### 4. 입력 값이 있음에도 질문이 생성되는 조건

#### 현재 문제점
1. **AI 의존적 검증**: 코드 레벨에서 고객 입력 정보를 체크하지 않음
2. **명시적 필터링 없음**: 질문 생성 전에 "이미 입력된 정보인지" 확인하는 로직 없음
3. **질문 우선순위 로직 없음**: 견적/공정에 직접 영향 있는 질문만 선별하는 로직 없음

#### 예상 시나리오
- 고객이 `totalPeople: 3` 입력 → AI가 "몇 명이 거주하시나요?" 질문 생성 가능
- 고객이 `additionalNotes: "2살 아기 있음"` 입력 → AI가 활용하지만, 명시적 검증 없음

---

## ⚠️ 명세서 요구사항 vs 현재 구현 비교

### ✅ 이미 구현된 항목

1. **고객 정보 요약 생성**
   - `buildCustomerProfile()` 함수 존재
   - 있을 때만 표시하는 로직 구현

2. **AI 기반 질문 생성**
   - OpenAI API 사용
   - V3.1 설계서 규칙 프롬프트에 포함

3. **질문 카테고리 분류**
   - 6개 묶음: family, lifestyle, storage, cleaning, mood, concerns

4. **색상 추천 기능 (부분 구현)**
   - `lib/analysis/color-recommendation.ts` 존재
   - `getColorRecommendation()` 함수
   - ⚠️ 하지만 질문 형태가 아닌지 확인 필요

### ❌ 미구현 항목 (명세서 요구사항)

#### 1. 질문 생성 허용/금지 조건 (코드 레벨)
```typescript
// 명세서 요구: 질문 생성 전 명시적 체크
// 현재: AI 프롬프트에만 의존, 코드 레벨 검증 없음

// 필요한 로직:
- 질문이 참조하는 고객 입력 값이 존재하는지 체크
- 견적 금액/공정 수/옵션 분기에 직접 영향 있는지 체크
```

#### 2. 질문 우선순위 (1라운드 강제)
```typescript
// 명세서 요구: 견적 금액/공정 개수/옵션 분기에 영향 있는 질문만 (최대 6개)
// 현재: 모드별로 다른 개수 (4, 10, 18, 7)

// 필요한 로직:
- 질문 생성 후 "견적 영향도" 점수 계산
- 영향도 높은 질문만 선별 (최대 6개)
```

#### 3. "잘 모르겠습니다" / "전문가 판단" 옵션
```typescript
// 명세서 요구: 모든 질문에 공통 선택지 추가
// 현재: 구현 없음

// 필요한 로직:
- 각 질문의 options에 "잘 모르겠습니다", "전문가 판단에 맡길게요" 추가
- 선택 시 처리 로직:
  * "잘 모르겠습니다" → 보수적 기본값, 추가 질문 생성 금지
  * "전문가 판단" → 가정값 저장, 견적에 가정 문구 포함
```

#### 4. 질문 검증 로직 (FAIL 처리)
```typescript
// 명세서 요구: 질문 → 검증 → 폐기/확정 구조
// 현재: AI 생성 후 바로 사용, 검증 단계 없음

// 필요한 로직:
- 질문 생성 후 검증:
  * 고객 입력 정보와 무관한 질문 → FAIL
  * 추상적 질문 → FAIL
  * 견적/공정에 영향 없음 → FAIL
- FAIL 시 해당 질문 폐기, 한 단계 이전 조건으로 되돌림
```

#### 5. 색상 파렛트 기능 (질문 아님)
```typescript
// 명세서 요구: 색상 질문 전면 금지, 범위 제안만
// 현재: color-recommendation.ts 존재하지만, 질문 형태인지 확인 필요

// 필요한 로직:
- 색상 질문 생성 금지 (코드 레벨)
- 파렛트 생성 조건: 2개 이상 충족 시만
  * 주거/상업 구분
  * 가족 구성 (영유아/노부모)
  * 반려동물 여부
  * 실거주/임대
  * 선택된 공정
- 고객 선택: "이대로 진행" / "조금 바꾸고 싶어요" / "잘 모르겠어요"
```

#### 6. 현장 실행 가정 문구
```typescript
// 명세서 요구: 색상/옵션 확정 안 되었을 때 필수 문구
// 현재: 구현 없음

// 필요한 문구:
"해당 항목은 현장 조명, 자재 수급, 샘플 확인 후 최종 확정되며 
현재 단계에서는 범위 기준으로 제안됩니다."
```

---

## 📊 명세서 요구사항 체크리스트

### 질문 생성 로직
- [ ] 질문 생성 전 고객 입력 정보 체크 (코드 레벨)
- [ ] 견적/공정 영향도 기반 질문 우선순위 (최대 6개)
- [ ] "잘 모르겠습니다" 옵션 추가 및 처리
- [ ] "전문가 판단" 옵션 추가 및 처리
- [ ] 질문 검증 로직 (FAIL 처리)
- [ ] 질문 수 최대 6개로 제한

### 색상 파렛트
- [ ] 색상 질문 생성 금지 (코드 레벨)
- [ ] 파렛트 생성 조건 체크 (2개 이상 충족)
- [ ] 파렛트 구성 규칙 (메인/서브/포인트 컬러)
- [ ] 고객 선택 처리 ("이대로 진행" / "조금 바꾸고 싶어요" / "잘 모르겠어요")
- [ ] "잘 모르겠어요" 선택 시 전문가 판단 + 가정 문구

### 현장 실행 가정 문구
- [ ] 색상/옵션 미확정 시 가정 문구 표시

---

## 🎯 작업 우선순위 (명세서 기준)

### Phase 1: 질문 생성 로직 강화 (핵심)
1. **고객 입력 정보 체크 로직 추가**
   - `buildCustomerProfile()` 결과를 기반으로 질문 생성 전 필터링
   - 이미 입력된 정보를 참조하는 질문 생성 금지

2. **질문 우선순위 로직 추가**
   - 견적 금액/공정 개수/옵션 분기 영향도 계산
   - 영향도 높은 질문만 선별 (최대 6개)

3. **질문 검증 로직 추가**
   - 질문 생성 후 검증 단계
   - FAIL 조건 체크 및 폐기 처리

### Phase 2: 고객 답변 곤란 처리
1. **공통 선택지 추가**
   - 모든 질문에 "잘 모르겠습니다", "전문가 판단에 맡길게요" 추가

2. **선택지별 처리 로직**
   - "잘 모르겠습니다" → 보수적 기본값, 추가 질문 금지
   - "전문가 판단" → 가정값 저장, 견적에 가정 문구 포함

### Phase 3: 색상 파렛트 기능
1. **색상 질문 생성 금지**
   - 코드 레벨에서 색상 관련 질문 필터링

2. **파렛트 생성 조건 체크**
   - 2개 이상 충족 시만 파렛트 생성

3. **파렛트 구성 및 고객 선택 처리**

### Phase 4: 현장 실행 가정 문구
1. **가정 문구 표시 로직**
   - 색상/옵션 미확정 시 자동 표시

---

## 🔧 수정이 필요한 파일 목록

### 핵심 수정 파일
1. **`app/api/generate-questions/route.ts`**
   - 질문 생성 전 고객 입력 정보 체크 로직 추가
   - 질문 우선순위 로직 추가
   - 질문 검증 로직 추가
   - 질문 수 최대 6개로 제한

2. **`app/onboarding/personality/page.tsx`**
   - "잘 모르겠습니다", "전문가 판단" 옵션 추가
   - 선택지별 처리 로직 추가

3. **`lib/analysis/color-recommendation.ts`** (확인 필요)
   - 색상 질문 생성 금지 로직 추가
   - 파렛트 생성 조건 체크 로직 추가

### 보조 수정 파일
4. **`lib/store/personalityStore.ts`**
   - "전문가 판단" 선택 시 가정값 저장 로직 추가

5. **`app/onboarding/ai-recommendation/page.tsx`**
   - 현장 실행 가정 문구 표시 로직 추가

---

## ⚠️ 주의사항

### 명세서 강제 규칙 준수
- ✅ 기존 파일 구조 유지
- ✅ 새 파일 생성 금지
- ✅ UI 수정 금지 (로직만 수정)
- ✅ 견적 계산 로직 수정 금지

### 작업 원칙
- **질문을 잘 만드는 것이 아니라, 쓸 질문만 남기고 나머지를 제거**
- 고객 입력이 많을수록 질문 수가 줄어들어야 함
- 같은 입력값 → 같은 질문 결과 재현
- '모르겠다' 선택 시 질문이 늘어나지 않아야 함

---

## 📝 다음 단계

1. **명세서 분석 완료** ✅
2. **현재 코드베이스 분석 완료** ✅
3. **수정 계획 수립** (이 문서)
4. **Phase 1 작업 시작** (질문 생성 로직 강화)

---

**작성일**: 2024년
**분석 대상**: 인테리봇 V5 업그레이드 명세서
**현재 버전**: V3.1 → V5 업그레이드 준비




















