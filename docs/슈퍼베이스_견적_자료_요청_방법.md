# ìŠˆí¼ë² ì´ìŠ¤(Supabase) ê²¬ì  ìë£Œ ìš”ì²­ ë°©ë²• ë³´ê³ ì„œ

## ğŸ“‹ ê°œìš”

ì¸í…Œë¦¬ë´‡ í”„ë¡œì íŠ¸ì—ì„œ ìŠˆí¼ë² ì´ìŠ¤(Supabase)ì— ê²¬ì  ê´€ë ¨ ìë£Œë¥¼ ìš”ì²­í•˜ëŠ” ë°©ë²•ì„ ì •ë¦¬í•œ ë¬¸ì„œì…ë‹ˆë‹¤.

---

## ğŸ”§ Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”

### ìœ„ì¹˜
- `lib/db/supabase.ts`

### ì´ˆê¸°í™” ì½”ë“œ

```typescript
import { createClient as createSupabaseClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY

// í´ë¼ì´ì–¸íŠ¸ ìƒì„±
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: false, // Next.jsì—ì„œëŠ” ì„¸ì…˜ ìœ ì§€ í•„ìš” ì—†ìŒ
  },
})
```

### í™˜ê²½ ë³€ìˆ˜
- `NEXT_PUBLIC_SUPABASE_URL`: Supabase í”„ë¡œì íŠ¸ URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Supabase Anon Key

---

## ğŸ“Š ê²¬ì  ìë£Œ ìš”ì²­ íŒ¨í„´

### 1. ê¸°ë³¸ ì¿¼ë¦¬ íŒ¨í„´

```typescript
// ê¸°ë³¸ êµ¬ì¡°
const { data, error } = await supabase
  .from('í…Œì´ë¸”ëª…')
  .select('ì»¬ëŸ¼ëª…1, ì»¬ëŸ¼ëª…2, ...')
  .eq('ì¡°ê±´ì»¬ëŸ¼', 'ì¡°ê±´ê°’')      // ê°™ìŒ
  .lte('ì¡°ê±´ì»¬ëŸ¼', 'ì¡°ê±´ê°’')     // ì´í•˜
  .gte('ì¡°ê±´ì»¬ëŸ¼', 'ì¡°ê±´ê°’')     // ì´ìƒ
  .order('ì •ë ¬ì»¬ëŸ¼', { ascending: true/false })
  .limit(ê°œìˆ˜)
  .maybeSingle()  // ë˜ëŠ” .single()
```

---

## ğŸ—„ï¸ ì£¼ìš” í…Œì´ë¸” ë° ìš”ì²­ í•¨ìˆ˜

### 1. ì² ê±° ê´€ë ¨ í…Œì´ë¸”

#### 1-1. ì „ì²´ ì² ê±° íŒ¨í‚¤ì§€ ì¡°íšŒ

**ìœ„ì¹˜**: `lib/db/adapters/demolition-adapter.ts` (70-108ì¤„)

**í•¨ìˆ˜**: `getFullDemolitionPackageFromDB()`

**í…Œì´ë¸”**: `demolition_packages`

**ìš”ì²­ ì½”ë“œ**:
```typescript
const { data, error } = await supabase
  .from('demolition_packages')
  .select('*')
  .eq('property_type', propertyType)  // 'apartment' | 'commercial'
  .eq('is_active', true)
  .lte('pyeong', pyeong)              // í‰ìˆ˜ ì´í•˜
  .order('pyeong', { ascending: false })
  .limit(1)
  .maybeSingle()
```

**ë°˜í™˜ ë°ì´í„°**:
```typescript
{
  package_id: string
  pyeong: number
  package_name: string
  total_price: number
  price_per_pyeong: number | null
  includes: string | null
  property_type: string
  is_active: boolean
}
```

#### 1-2. ìš•ì‹¤ ì² ê±° í•­ëª© ì¡°íšŒ

**ìœ„ì¹˜**: `lib/db/adapters/demolition-adapter.ts` (120-149ì¤„)

**í•¨ìˆ˜**: `getBathroomItemByPyeong()`

**í…Œì´ë¸”**: `demolition_items`

**ìš”ì²­ ì½”ë“œ**:
```typescript
const { data, error } = await supabase
  .from('demolition_items')
  .select('*')
  .eq('category_id', 'DEM-BATH')      // ìš•ì‹¤ ì² ê±° ì¹´í…Œê³ ë¦¬
  .eq('is_package', true)
  .eq('is_active', true)
  .lte('pyeong_min', pyeong)          // í‰ìˆ˜ ìµœì†Œê°’ ì´í•˜
  .gte('pyeong_max', pyeong)           // í‰ìˆ˜ ìµœëŒ€ê°’ ì´ìƒ
  .limit(1)
  .maybeSingle()
```

#### 1-3. ì£¼ë°© ì² ê±° í•­ëª© ì¡°íšŒ

**ìœ„ì¹˜**: `lib/db/adapters/demolition-adapter.ts` (157-186ì¤„)

**í•¨ìˆ˜**: `getKitchenItemByPyeong()`

**í…Œì´ë¸”**: `demolition_items`

**ìš”ì²­ ì½”ë“œ**:
```typescript
const { data, error } = await supabase
  .from('demolition_items')
  .select('*')
  .eq('category_id', 'DEM-KITCHEN')   // ì£¼ë°© ì² ê±° ì¹´í…Œê³ ë¦¬
  .eq('is_package', true)
  .eq('is_active', true)
  .lte('pyeong_min', pyeong)
  .gte('pyeong_max', pyeong)
  .limit(1)
  .maybeSingle()
```

#### 1-4. ì¹´í…Œê³ ë¦¬ë³„ ì² ê±° í•­ëª© ì¡°íšŒ

**ìœ„ì¹˜**: `lib/db/adapters/demolition-adapter.ts` (195-228ì¤„)

**í•¨ìˆ˜**: `getDemolitionItemsByCategory()`

**í…Œì´ë¸”**: `demolition_items`

**ìš”ì²­ ì½”ë“œ**:
```typescript
let query = supabase
  .from('demolition_items')
  .select('*')
  .eq('category_id', categoryId)      // ì˜ˆ: 'DEM-FLOOR', 'DEM-CEILING'
  .eq('is_active', true)

// í‰í˜• í•„í„° (íŒ¨í‚¤ì§€ì¸ ê²½ìš°)
if (pyeong !== undefined) {
  query = query.or(`is_package.eq.false,and(pyeong_min.lte.${pyeong},pyeong_max.gte.${pyeong})`)
}

const { data, error } = await query
```

#### 1-5. íê¸°ë¬¼ Config ì¡°íšŒ

**ìœ„ì¹˜**: `lib/db/adapters/demolition-adapter.ts` (240-288ì¤„)

**í•¨ìˆ˜**: `getWasteConfigFromDB()`

**í…Œì´ë¸”**: `demolition_waste_config`

**ìš”ì²­ ì½”ë“œ**:
```typescript
// 1ì°¨: ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” í‰í˜• ì°¾ê¸°
let { data, error } = await supabase
  .from('demolition_waste_config')
  .select('*')
  .eq('pyeong', pyeong)
  .eq('is_active', true)
  .limit(1)
  .maybeSingle()

// 2ì°¨: ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²ƒì´ ì—†ìœ¼ë©´ ê°€ì¥ ê°€ê¹Œìš´ ìƒìœ„ í‰í˜• ì°¾ê¸°
if (!data && !error) {
  const { data: fallbackData, error: fallbackError } = await supabase
    .from('demolition_waste_config')
    .select('*')
    .eq('is_active', true)
    .gte('pyeong', pyeong)            // í‰ìˆ˜ ì´ìƒ
    .order('pyeong', { ascending: true })
    .limit(1)
    .maybeSingle()
}
```

**ë°˜í™˜ ë°ì´í„°**:
```typescript
{
  pyeong: number
  max_ton: number
  price_per_ton: number
  total_cost: number
  description: string | null
  is_active: boolean
}
```

#### 1-6. ë³´ì–‘ í•­ëª© ì¡°íšŒ

**ìœ„ì¹˜**: `lib/db/adapters/demolition-adapter.ts` (299-320ì¤„)

**í•¨ìˆ˜**: `getProtectionFromDB()`

**í…Œì´ë¸”**: `demolition_protection`

**ìš”ì²­ ì½”ë“œ**:
```typescript
const { data, error } = await supabase
  .from('demolition_protection')
  .select('*')
  .eq('is_active', true)
```

**ë°˜í™˜ ë°ì´í„°**:
```typescript
Array<{
  protection_id: string
  protection_name: string
  base_price: number
  additional_unit: string | null
  additional_price: number | null
  description: string | null
}>
```

---

### 2. íƒ€ì¼ ê´€ë ¨ í…Œì´ë¸”

#### 2-1. íƒ€ì¼ ë‹¨ê°€ ì¡°íšŒ

**ìœ„ì¹˜**: `lib/db/adapters/tile-adapter.ts` (22-66ì¤„)

**í•¨ìˆ˜**: `getTilePriceFromDB()`

**í…Œì´ë¸”**: `materials_pricing`

**ìš”ì²­ ì½”ë“œ**:
```typescript
const gradeMap: Record<Grade, string> = {
  'BASIC': 'basic',
  'STANDARD': 'standard',
  'ARGEN': 'argen',
  'PREMIUM': 'premium'
}

const dbGrade = gradeMap[grade]

const { data, error } = await supabase
  .from('materials_pricing')
  .select('price_min, price_max')
  .eq('grade', dbGrade)
  .eq('is_current', true)
  .limit(1)
  .single()

// í‰ê· ê°’ ë¦¬í„´
const avgPrice = (data.price_min + data.price_max) / 2
```

---

### 3. ì„±í–¥ ë¶„ì„ ê´€ë ¨ í…Œì´ë¸”

#### 3-1. ì„±í–¥ ì ìˆ˜ ì¡°íšŒ

**ìœ„ì¹˜**: `lib/db/adapters/personality-adapter.ts` (59-63ì¤„)

**í…Œì´ë¸”**: `answer_score_mapping`

**ìš”ì²­ ì½”ë“œ**:
```typescript
const { data, error } = await supabase
  .from('answer_score_mapping')
  .select('trait_scores')
  .eq('question_id', questionId)
  .eq('answer_value', answerValue)
  .eq('analysis_mode', analysisMode)
  .maybeSingle()
```

#### 3-2. ì¶”ì²œ ìì¬ ì¡°íšŒ (RPC í•¨ìˆ˜ ì‚¬ìš©)

**ìœ„ì¹˜**: `lib/db/adapters/personality-adapter.ts` (194-197ì¤„)

**í•¨ìˆ˜**: `getRecommendedMaterialsFromDB()`

**ë°©ë²• 1: RPC í•¨ìˆ˜ ì‚¬ìš© (ê¶Œì¥)**
```typescript
const { data, error } = await supabase.rpc('get_recommended_materials', {
  p_trait_scores: traitScoresJson,  // JSONB í˜•ì‹
  p_phase_id: phaseId || null
})
```

**ë°©ë²• 2: ì§ì ‘ ì¿¼ë¦¬ (Fallback)**
```typescript
let query = supabase
  .from('personality_materials')
  .select(`
    mapping_id,
    trait_id,
    material_id,
    phase_id,
    score_threshold,
    score_direction,
    recommendation_type,
    grade_adjustment,
    priority,
    reason_template,
    personality_traits!inner(trait_code, trait_name),
    materials(material_code, product_name, category_1, category_2, category_3)
  `)
  .eq('is_active', true)

if (phaseId) {
  query = query.eq('phase_id', phaseId)
}

const { data, error } = await query
```

---

## ğŸ”„ ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œ

### ì˜ˆì‹œ 1: ì „ì²´ ì² ê±° íŒ¨í‚¤ì§€ ì¡°íšŒ

```typescript
// lib/estimate/calculator-v3.ts (813-828ì¤„)
import { calculateFullDemolitionBreakdown } from '@/lib/data/pricing-v3/demolition-packages'

const breakdown = await calculateFullDemolitionBreakdown(
  py,                    // í‰ìˆ˜
  'apartment',           // ê±´ë¬¼ ìœ í˜•
  true,                  // hasElevator
  5                      // hallwaySheets
)

// breakdown êµ¬ì¡°:
{
  packagePrice: number,    // ì „ì²´ íŒ¨í‚¤ì§€ ê°€ê²©
  wasteTon: number,        // íê¸°ë¬¼ í†¤ìˆ˜
  wasteCost: number,       // íê¸°ë¬¼ ì²˜ë¦¬ë¹„
  laborCost: number,        // ì¸ê±´ë¹„ (ë…¸ë¬´ë¹„)
  protectionCost: number,   // ë³´ì–‘ë¹„
  elevatorCost: number      // ì—˜ë¦¬ë² ì´í„° ë³´ì–‘ë¹„
}
```

### ì˜ˆì‹œ 2: ë¶€ë¶„ ì² ê±° í•­ëª© ì¡°íšŒ

```typescript
// lib/estimate/calculator-v3.ts (840-848ì¤„)
import {
  getBathroomItemByPyeong,
  getKitchenItemByPyeong,
  getDemolitionItemsByCategory
} from '@/lib/db/adapters/demolition-adapter'

// ìš•ì‹¤ ì² ê±°
if (hasBathroomProcess) {
  const bathroomItem = await getBathroomItemByPyeong(py)
  if (bathroomItem) {
    demolitionItems.push({
      name: bathroomItem.item_name,
      cost: bathroomItem.unit_price,
      includes: bathroomItem.includes
    })
  }
}

// ì£¼ë°© ì² ê±°
if (hasKitchenProcess) {
  const kitchenItem = await getKitchenItemByPyeong(py)
  // ...
}

// ë°”ë‹¥ ì² ê±°
if (needsFloorDemolition) {
  const floorItems = await getDemolitionItemsByCategory('DEM-FLOOR', py)
  // ...
}
```

### ì˜ˆì‹œ 3: íƒ€ì¼ ë‹¨ê°€ ì¡°íšŒ

```typescript
// lib/estimate/calculator-v3.ts (íƒ€ì¼ ê³„ì‚° ì‹œ)
import { getTilePriceFromDB } from '@/lib/db/adapters/tile-adapter'

const tilePrice = await getTilePriceFromDB(grade)  // 'BASIC' | 'STANDARD' | 'ARGEN' | 'PREMIUM'
```

---

## ğŸ› ï¸ ì£¼ìš” ì¿¼ë¦¬ ë©”ì„œë“œ

### í•„í„°ë§ ë©”ì„œë“œ

| ë©”ì„œë“œ | ì„¤ëª… | ì˜ˆì‹œ |
|--------|------|------|
| `.eq()` | ê°™ìŒ | `.eq('is_active', true)` |
| `.neq()` | ê°™ì§€ ì•ŠìŒ | `.neq('status', 'deleted')` |
| `.gt()` | ì´ˆê³¼ | `.gt('price', 1000)` |
| `.gte()` | ì´ìƒ | `.gte('pyeong', 25)` |
| `.lt()` | ë¯¸ë§Œ | `.lt('price', 5000)` |
| `.lte()` | ì´í•˜ | `.lte('pyeong', 30)` |
| `.like()` | ë¶€ë¶„ ì¼ì¹˜ | `.like('name', '%ì£¼ë°©%')` |
| `.ilike()` | ëŒ€ì†Œë¬¸ì ë¬´ì‹œ ë¶€ë¶„ ì¼ì¹˜ | `.ilike('name', '%kitchen%')` |
| `.in()` | ë°°ì—´ ë‚´ í¬í•¨ | `.in('category', ['A', 'B'])` |
| `.or()` | OR ì¡°ê±´ | `.or('pyeong.gte.25,pyeong.lte.30')` |

### ì •ë ¬ ë° ì œí•œ

| ë©”ì„œë“œ | ì„¤ëª… | ì˜ˆì‹œ |
|--------|------|------|
| `.order()` | ì •ë ¬ | `.order('pyeong', { ascending: false })` |
| `.limit()` | ê°œìˆ˜ ì œí•œ | `.limit(10)` |
| `.range()` | ë²”ìœ„ ì§€ì • | `.range(0, 9)` |

### ê²°ê³¼ ì²˜ë¦¬

| ë©”ì„œë“œ | ì„¤ëª… | ì˜ˆì‹œ |
|--------|------|------|
| `.single()` | ë‹¨ì¼ ê²°ê³¼ (ì—†ìœ¼ë©´ ì—ëŸ¬) | `.single()` |
| `.maybeSingle()` | ë‹¨ì¼ ê²°ê³¼ (ì—†ìœ¼ë©´ null) | `.maybeSingle()` |
| `.select()` | ì»¬ëŸ¼ ì„ íƒ | `.select('id, name, price')` |

---

## ğŸ” ì—ëŸ¬ ì²˜ë¦¬ íŒ¨í„´

### ê¸°ë³¸ íŒ¨í„´

```typescript
try {
  // í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
  if (!process.env.NEXT_PUBLIC_SUPABASE_URL || !process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {
    console.warn('âš ï¸ Supabase í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Fallback ì‚¬ìš©')
    return null  // ë˜ëŠ” fallback ê°’
  }

  const { data, error } = await supabase
    .from('í…Œì´ë¸”ëª…')
    .select('*')
    // ... ì¡°ê±´ë“¤

  if (error) {
    console.error('âŒ ì¡°íšŒ ì—ëŸ¬:', error)
    return null  // ë˜ëŠ” fallback ê°’
  }

  if (!data) {
    console.warn('âš ï¸ ë°ì´í„° ì—†ìŒ')
    return null
  }

  return data
} catch (err: any) {
  console.error('âŒ ì˜ˆì™¸ ë°œìƒ:', err)
  return null  // ë˜ëŠ” fallback ê°’
}
```

### Fallback íŒ¨í„´

```typescript
// 1. DB ì¡°íšŒ ì‹œë„
const dbData = await getDataFromDB(params)

// 2. DB ì‹¤íŒ¨ ì‹œ Fallback ì‚¬ìš©
if (!dbData) {
  console.warn('âš ï¸ DB ì¡°íšŒ ì‹¤íŒ¨, Fallback ì‚¬ìš©')
  return getFallbackData(params)
}

return dbData
```

---

## ğŸ“‹ ì£¼ìš” í…Œì´ë¸” ëª©ë¡

### ì² ê±° ê´€ë ¨
- `demolition_packages`: ì „ì²´ ì² ê±° íŒ¨í‚¤ì§€
- `demolition_items`: ë¶€ë¶„ ì² ê±° í•­ëª©
- `demolition_waste_config`: íê¸°ë¬¼ Config
- `demolition_protection`: ë³´ì–‘ í•­ëª©

### ìì¬ ê´€ë ¨
- `materials_pricing`: ìì¬ ê°€ê²©
- `materials_quantity_rules`: ìì¬ ìˆ˜ëŸ‰ ê·œì¹™
- `materials`: ìì¬ ë§ˆìŠ¤í„°

### ì„±í–¥ ë¶„ì„ ê´€ë ¨
- `personality_materials`: ì„±í–¥-ìì¬ ë§¤í•‘
- `personality_traits`: ì„±í–¥ íŠ¹ì„±
- `answer_score_mapping`: ë‹µë³€-ì ìˆ˜ ë§¤í•‘

---

## ğŸ¯ ì‚¬ìš© íë¦„

### ê²¬ì  ê³„ì‚° ì‹œ DB ì¡°íšŒ íë¦„

```
1. calculateFullEstimateV3() í˜¸ì¶œ
   â†“
2. calculateCommonCosts() ì‹¤í–‰
   â†“
3. ì „ì²´ ê³µì •ì¸ ê²½ìš°:
   - getFullDemolitionPackageFromDB() â†’ demolition_packages
   - getWasteConfigFromDB() â†’ demolition_waste_config
   - calculateProtectionCostFromDB() â†’ demolition_protection
   â†“
4. ë¶€ë¶„ ê³µì •ì¸ ê²½ìš°:
   - getBathroomItemByPyeong() â†’ demolition_items
   - getKitchenItemByPyeong() â†’ demolition_items
   - getDemolitionItemsByCategory() â†’ demolition_items
   â†“
5. íƒ€ì¼ ê³„ì‚° ì‹œ:
   - getTilePriceFromDB() â†’ materials_pricing
```

---

## ğŸ“ ì£¼ì˜ì‚¬í•­

### 1. í™˜ê²½ ë³€ìˆ˜ í•„ìˆ˜
- ëª¨ë“  DB ì¡°íšŒ í•¨ìˆ˜ëŠ” í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ì„ ë¨¼ì € ìˆ˜í–‰
- í™˜ê²½ ë³€ìˆ˜ê°€ ì—†ìœ¼ë©´ `null` ë°˜í™˜ ë˜ëŠ” Fallback ì‚¬ìš©

### 2. ì—ëŸ¬ ì²˜ë¦¬
- ëª¨ë“  í•¨ìˆ˜ëŠ” try-catchë¡œ ê°ì‹¸ì„œ ì—ëŸ¬ ì²˜ë¦¬
- ì—ëŸ¬ ë°œìƒ ì‹œ `null` ë°˜í™˜ ë˜ëŠ” Fallback ê°’ ì‚¬ìš©

### 3. Fallback ë¡œì§
- DB ì¡°íšŒ ì‹¤íŒ¨ ì‹œ í•˜ë“œì½”ë”©ëœ ê°’ ì‚¬ìš©
- ì˜ˆ: `calculateFromConfig()`, `calculateWasteConfigFallback()`

### 4. maybeSingle() vs single()
- ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆëŠ” ê²½ìš°: `.maybeSingle()` ì‚¬ìš©
- ë°ì´í„°ê°€ ë°˜ë“œì‹œ ìˆì–´ì•¼ í•˜ëŠ” ê²½ìš°: `.single()` ì‚¬ìš©

---

## ğŸ“… ì‘ì„±ì¼
2024ë…„ 12ì›”

## ğŸ“Œ ë²„ì „
V3 (calculator-v3.ts ê¸°ì¤€)

















