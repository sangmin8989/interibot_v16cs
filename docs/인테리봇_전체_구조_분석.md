# 인테리봇 전체 구조 분석 및 문제점 진단

**작성일**: 2025-12-17  
**목적**: 현재 에러 원인 파악 및 전체 시스템 구조 정리

---

## 1. 프로젝트 전체 구조

### 1.1 디렉토리 구조

```
interibot/
├── app/                          # Next.js App Router
│   ├── api/                      # API 라우트
│   │   ├── estimate/            # 견적 관련 API
│   │   │   ├── constitution/    # 헌법 v1 엔진 API
│   │   │   ├── v3/              # V3 계산기 API
│   │   │   └── ...
│   │   └── ...
│   ├── onboarding/              # 온보딩 플로우
│   │   └── estimate/            # 견적 페이지 (문제 발생 지점)
│   └── ...
├── lib/                          # 핵심 비즈니스 로직
│   ├── adapters/                # 어댑터 레이어 (새로 생성됨)
│   │   └── estimate-result-adapter.ts
│   ├── estimate/                # 견적 계산 엔진
│   │   ├── calculator-v3.ts    # V3 계산기 (4등급)
│   │   ├── constitution-v1-engine.ts  # 헌법 v1 엔진
│   │   └── ...
│   ├── data/                    # 데이터 정의
│   │   └── pricing-v3/         # V3 가격 데이터
│   ├── store/                   # Zustand 상태 관리
│   │   ├── spaceInfoStore.ts
│   │   ├── processStore.ts
│   │   └── ...
│   └── types/                   # 타입 정의
│       └── 헌법_견적_타입.ts
└── components/                   # React 컴포넌트
```

---

## 2. 현재 에러 분석

### 2.1 에러 발생 위치

**파일**: `app/onboarding/estimate/page.tsx`  
**라인**: 660번  
**에러 메시지**: `TypeError: Cannot read properties of undefined (reading 'grandTotal')`

### 2.2 에러 발생 코드

```typescript
// 637-652번 줄: 4등급 견적 계산
const basicEstimate = calculateFullEstimateV3({ ...baseInput, grade: 'BASIC' })
const standardEstimate = calculateFullEstimateV3({ ...baseInput, grade: 'STANDARD' })
const argenEstimate = calculateFullEstimateV3({ ...baseInput, grade: 'ARGEN' })
const premiumEstimate = calculateFullEstimateV3({ ...baseInput, grade: 'PREMIUM' })

// 660번 줄: 에러 발생 지점
console.log('✅ V3 견적 결과:', {
  평수: py,
  basic: formatWon(basicEstimate.summary.grandTotal),  // ❌ summary가 undefined
  standard: formatWon(standardEstimate.summary.grandTotal),
  argen: formatWon(argenEstimate.summary.grandTotal),
  premium: formatWon(premiumEstimate.summary.grandTotal),
})
```

### 2.3 근본 원인

1. **비동기 함수를 동기적으로 호출**
   - `calculateFullEstimateV3`는 `async` 함수인데 `await` 없이 호출됨
   - Promise 객체가 반환되어 `summary` 접근 시 `undefined` 발생

2. **`calculateFullEstimateV3` 함수가 `summary` 없이 객체를 반환할 수 있음**
   - 함수 내부에서 에러 발생 시 `summary` 필드가 없는 객체 반환 가능
   - 또는 비동기 처리 문제로 불완전한 객체 반환

3. **안전 체크 부재**
   - `summary` 존재 여부 확인 없이 직접 접근
   - 옵셔널 체이닝(`?.`) 미사용

4. **어댑터 미사용**
   - `lib/adapters/estimate-result-adapter.ts`를 생성했지만 실제 코드에서 사용하지 않음

---

## 3. 시스템 아키텍처 문제점

### 3.1 견적 엔진 이중화

**문제**: 두 개의 견적 시스템이 혼재되어 있음

1. **V3 계산기** (`calculator-v3.ts`)
   - 4등급 시스템 (BASIC, STANDARD, ARGEN, PREMIUM)
   - 파일 기반 가격 데이터 사용
   - `calculateFullEstimateV3` 함수

2. **헌법 v1 엔진** (`constitution-v1-engine.ts`)
   - 단일 아르젠 기준
   - Supabase DB 기반
   - `generateEstimate` 함수

**영향**:
- 코드 중복 및 유지보수 어려움
- 일관성 없는 데이터 소스
- UI에서 두 시스템을 혼용하여 사용

### 3.2 타입 불일치

**문제**: 엔진 결과 타입과 UI 기대 타입 불일치

```typescript
// V3 계산기 반환 타입
interface FullEstimateV3 {
  summary: {
    grandTotal: number;
    materialTotal: number;
    laborTotal: number;
    // ...
  };
}

// 실제 반환값: summary가 undefined일 수 있음
// 타입 정의와 실제 구현 불일치
```

### 3.3 에러 처리 부재

**문제**: 견적 계산 실패 시 안전한 폴백 없음

- 계산 실패 시 `undefined` 반환
- UI에서 `undefined.summary.grandTotal` 접근 시 크래시
- 사용자에게 명확한 에러 메시지 제공 안 됨

### 3.4 상태 관리 복잡성

**문제**: 여러 Store가 복잡하게 상호작용

- `spaceInfoStore`: 평수, 방 개수 등
- `processStore`: 공정 선택
- `scopeStore`: 공간 선택
- 각 Store 간 동기화 문제 가능

---

## 4. 주요 문제점 요약

### 4.1 즉시 수정 필요 (Critical) ✅ 완료

1. **`page.tsx:637-652` - await 추가** ✅
   - `calculateFullEstimateV3`는 `async` 함수이므로 `await` 필수
   - Promise 객체가 아닌 실제 결과를 받아야 함

2. **`page.tsx:660` - 안전 체크 추가** ✅
   ```typescript
   // 현재 (에러 발생)
   basic: formatWon(basicEstimate.summary.grandTotal)
   
   // 수정 완료
   basic: formatWon(basicEstimate?.summary?.grandTotal || 0)
   ```

3. **UI 렌더링 부분 안전 체크** ✅
   - 모든 `summary.grandTotal` 접근에 옵셔널 체이닝 적용

4. **어댑터 적용** (선택사항)
   - `estimate-result-adapter.ts`를 실제 코드에 적용 가능
   - 현재는 옵셔널 체이닝으로 해결했지만, 장기적으로 어댑터 사용 권장

### 4.2 구조적 개선 필요 (High Priority)

1. **견적 엔진 통합**
   - V3 계산기와 헌법 v1 엔진 중 하나로 통합
   - 또는 명확한 사용 시나리오 분리

2. **타입 안전성 강화**
   - 모든 엔진 함수의 반환 타입 명확화
   - `undefined` 가능성 제거 또는 명시

3. **에러 처리 표준화**
   - 모든 견적 계산에 try-catch 추가
   - 사용자 친화적 에러 메시지

### 4.3 장기 개선 사항 (Medium Priority)

1. **테스트 코드 추가**
   - 견적 계산 함수 단위 테스트
   - 통합 테스트

2. **로깅 시스템**
   - 구조화된 로깅
   - 에러 추적 시스템

---

## 5. 수정 방안

### 5.1 즉시 적용 가능한 수정

#### 수정 1: await 추가 (비동기 함수 호출)

```typescript
// app/onboarding/estimate/page.tsx:637-652
// ❌ 기존: await 없이 호출
const basicEstimate = calculateFullEstimateV3({ ...baseInput, grade: 'BASIC' })

// ✅ 수정: await 추가
const basicEstimate = await calculateFullEstimateV3({ ...baseInput, grade: 'BASIC' })
const standardEstimate = await calculateFullEstimateV3({ ...baseInput, grade: 'STANDARD' })
const argenEstimate = await calculateFullEstimateV3({ ...baseInput, grade: 'ARGEN' })
const premiumEstimate = await calculateFullEstimateV3({ ...baseInput, grade: 'PREMIUM' })
```

#### 수정 2: 안전 체크 추가

```typescript
// app/onboarding/estimate/page.tsx:658-665
console.log('✅ V3 견적 결과:', {
  평수: py,
  basic: formatWon(basicEstimate?.summary?.grandTotal || 0),
  standard: formatWon(standardEstimate?.summary?.grandTotal || 0),
  argen: formatWon(argenEstimate?.summary?.grandTotal || 0),
  premium: formatWon(premiumEstimate?.summary?.grandTotal || 0),
  평당단가_아르젠: `${Math.round((argenEstimate?.summary?.grandTotal || 0) / py / 10000)}만원`
})
```

#### 수정 3: UI 렌더링 부분 안전 체크

```typescript
// app/onboarding/estimate/page.tsx:1145
{formatPrice(estimate?.summary?.grandTotal || 0)}

// app/onboarding/estimate/page.tsx:1234
{formatWon(currentEstimate?.summary?.grandTotal || 0)}
```

#### 수정 2: 어댑터 적용

```typescript
// app/onboarding/estimate/page.tsx 상단
import { adaptEstimateResult } from '@/lib/adapters/estimate-result-adapter'

// 계산 후
const adaptedBasic = adaptEstimateResult(basicEstimate)
const adaptedStandard = adaptEstimateResult(standardEstimate)
// ...

// 사용 시
console.log('✅ V3 견적 결과:', {
  basic: formatWon(adaptedBasic.grandTotal),
  // ...
})
```

### 5.2 구조적 개선

1. **견적 계산 함수 래핑**
   ```typescript
   async function safeCalculateEstimate(input: EstimateInputV3, grade: Grade) {
     try {
       const result = await calculateFullEstimateV3({ ...input, grade })
       return adaptEstimateResult(result)
     } catch (error) {
       console.error(`견적 계산 실패 (${grade}):`, error)
       return adaptEstimateResult(null) // 안전한 기본값
     }
   }
   ```

2. **에러 바운더리 추가**
   - React Error Boundary로 UI 크래시 방지
   - 사용자에게 재시도 옵션 제공

---

## 6. 파일 의존성 맵

```
app/onboarding/estimate/page.tsx
  ├── lib/estimate/calculator-v3.ts (calculateFullEstimateV3)
  │   ├── lib/data/pricing-v3/types.ts
  │   └── lib/data/pricing-v3/*.ts
  ├── lib/store/spaceInfoStore.ts
  ├── lib/store/processStore.ts
  └── lib/store/scopeStore.ts

lib/estimate/calculator-v3.ts
  └── lib/data/pricing-v3/*.ts (가격 데이터)

lib/estimate/constitution-v1-engine.ts
  ├── lib/db/supabase.ts
  └── lib/types/헌법_견적_타입.ts
```

---

## 7. 권장 사항

### 7.1 단기 (1주일 내)

1. ✅ 안전 체크 추가 (옵셔널 체이닝)
2. ✅ 어댑터 적용
3. ✅ 에러 처리 강화

### 7.2 중기 (1개월 내)

1. 견적 엔진 통합 또는 명확한 분리
2. 타입 안전성 강화
3. 테스트 코드 작성

### 7.3 장기 (3개월 내)

1. 아키텍처 리팩토링
2. 모니터링 시스템 구축
3. 문서화 완성

---

## 8. 참고 파일

- **에러 발생 파일**: `app/onboarding/estimate/page.tsx`
- **V3 계산기**: `lib/estimate/calculator-v3.ts`
- **헌법 v1 엔진**: `lib/estimate/constitution-v1-engine.ts`
- **어댑터**: `lib/adapters/estimate-result-adapter.ts` (새로 생성됨)
- **타입 정의**: `lib/types/헌법_견적_타입.ts`

---

**다음 단계**: 즉시 수정 사항 적용 후 테스트 진행











