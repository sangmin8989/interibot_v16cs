# 헌법 v1.1 - 완료 체크리스트

**작성일**: 2025년 12월  
**목적**: 헌법 v1.1 최종 봉인 작업 완료 확인

---

## ✅ 완료된 작업

### 코드 레벨 작업
- [x] `material-service-strict.ts` 생성 완료
- [x] `labor-service-strict.ts` 생성 완료
- [x] `constitution-v1-engine.ts`에서 헌법 v1.1 전용 서비스 사용
- [x] API 라우트에서 에러 메시지 통일
- [x] 기존 함수 deprecated 표시

### DB 레벨 작업
- [x] 제약조건 위반 데이터 확인 완료
- [x] 위반 데이터 처리 완료 (비활성화)
- [x] 최종 확인 쿼리 결과 모두 0건 확인 완료
- [x] 제약조건 위반 재확인 완료 (활성화된 데이터만)
- [x] 기존 제약조건 삭제 및 수정본 재적용 완료
- [x] 제약조건 최종 확인 완료 (모든 테이블)
  - materials: 3개 제약조건 (price, unit, argen) ✅
  - labor_productivity: 2개 제약조건 (output, crew) ✅
  - labor_costs: 2개 제약조건 (rate, current) ✅

### 테스트 작업
- [ ] 정상 케이스 테스트 완료
- [ ] 에러 케이스 테스트 완료
- [ ] 통일된 에러 메시지 확인 완료
- [ ] 내부 로그 상세 메시지 확인 완료

---

## 📋 다음 단계

### 1. 제약조건 최종 확인

**파일**: `docs/헌법_v1.1_제약조건_최종_확인_SQL.sql`

**실행 방법**:
1. Supabase Dashboard → SQL Editor 열기
2. 파일 내용 복사하여 실행
3. 모든 테이블의 제약조건이 정상적으로 적용되었는지 확인

**확인 사항**:
- materials 테이블: 3개 제약조건 (price, unit, argen)
- labor_productivity 테이블: 2개 제약조건 (output, crew)
- labor_costs 테이블: 2개 제약조건 (rate, current)

**예상 결과**:
- 모든 제약조건이 `is_active = false OR ...` 형태로 표시 (활성화된 데이터만 체크)
- labor_costs는 조건 없이 모든 행 체크

---

### 2. 실제 테스트

**테스트 시나리오**:
1. 개발 서버 실행 (`npm run dev`)
2. 브라우저에서 견적 페이지 열기
3. 평수 25, 주방 공간 선택
4. finish/electric/kitchen 공정 선택
5. 견적 계산 버튼 클릭

**확인 사항**:

#### ✅ 정상 케이스
- 견적이 정상적으로 생성됨
- 0원 항목이 없음
- 모든 자재/노무 정보가 정상적으로 표시됨

#### ❌ 에러 케이스 (자재/노무 정보 없음)
- 에러 발생 시 브라우저 콘솔 확인
- 네트워크 탭에서 API 응답 확인
- 예상 응답:
  ```json
  {
    "status": "ESTIMATE_FAILED",
    "failedAt": "MATERIAL_OR_LABOR_VALIDATION",
    "reason": "견적에 필요한 필수 단가/노무 정보가 DB에 존재하지 않습니다."
  }
  ```

**서버 로그 확인**:
- 터미널에서 상세한 에러 메시지 확인
- `❌ 헌법 v1.1 검증 실패:` 로그 확인
- 내부 로그는 상세하게 표시됨 (디버깅 용이)

---

## 🎯 완료 기준

### 필수 완료 항목
- [x] 코드 레벨 작업 완료
- [x] DB 위반 데이터 처리 완료
- [x] DB 제약조건 적용 완료
- [x] 제약조건 최종 확인 완료
- [ ] 실제 테스트 완료

### 선택 완료 항목
- [x] 기존 함수 deprecated 표시 완료

---

## 📌 참고 사항

### 제약조건 구조
- **활성화된 데이터만 체크**: `is_active = false OR (조건)`
- **모든 행 체크**: 조건만 (labor_costs)

### 에러 메시지 구조
- **외부 응답**: 통일된 메시지 ("견적에 필요한 필수 단가/노무 정보가 DB에 존재하지 않습니다.")
- **내부 로그**: 상세한 메시지 (디버깅 용이)
- **failedAt**: 자재/노무 관련은 'MATERIAL_OR_LABOR_VALIDATION', 기타는 'ENGINE_VALIDATION'

---

**작성일**: 2025년 12월  
**상태**: ✅ DB 제약조건 적용 완료, 테스트 대기 중











