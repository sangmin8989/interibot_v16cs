# 헌법 v1 공정 블록 생성 로직 상세 명세서

**작성일**: 2024년 12월  
**목적**: 헌법 v1 STEP 2 - 공정 블록 생성 로직의 완전한 구현 명세  
**상태**: 실행 문서 (Cursor가 그대로 구현)

---

## 0. 공정 블록의 정의 (헌법 v1 - STEP 2)

### 0-1. 공정 블록 = 견적의 최소 단위

```
공정 블록 = {
  공정명: string
  공정 유형: '필수' | '선택' | '조건부'
  포함 항목: string[]
  제외 항목: string[]
  기본 가정: string[]
  옵션 리스트: Option[]
  자재 정보: Material[]
  노무 정보: Labor
  금액: {
    자재비: number
    노무비: number
    공정 총액: number
  }
}
```

### 0-2. 절대 규칙

* **공정이 없으면 견적도 없다**
* 공정 블록이 없으면 → `ESTIMATE_FAILED` 상태 반환
* 공정 블록은 **processSelections에서만 생성** (SSOT)

---

## 1. 공정 블록 생성 전체 흐름

### STEP 1. processSelections 순회 및 활성화 판단

```typescript
// 입력: processSelections
// 출력: 활성화된 공정 목록

활성화된 공정 = []

for (spaceId, selections) in processSelections:
  for (category, value) in selections:
    if value === null OR value === 'none':
      continue  // 비활성화
    
    processId = CATEGORY_TO_PROCESS_ID[category]
    if processId:
      활성화된 공정.add({
        processId,
        space: convertSpaceId(spaceId),
        category,
        value
      })
```

### STEP 2. 필수 공정 자동 삽입 (헌법 v1 - STEP 3)

```typescript
// 입력: 활성화된 공정 목록
// 출력: 필수 공정이 추가된 공정 목록

if 'bathroom' in 활성화된_공정:
  // 욕실 공정 선택 시 → 방수 / 설비 / 전기 / 철거 연동
  if 'demolition' not in 활성화된_공정:
    활성화된_공정.add({
      processId: 'demolition',
      space: 'bathroom',
      category: 'auto_linked',
      value: 'required',
      reason: '욕실 공정 필수 연동'
    })
  
  if 'electric' not in 활성화된_공정:
    활성화된_공정.add({
      processId: 'electric',
      space: 'bathroom',
      category: 'auto_linked',
      value: 'required',
      reason: '욕실 공정 필수 연동'
    })
  
  // 방수, 설비도 동일하게 추가

if 'storage' in 활성화된_공정:
  // 목공 공정 선택 시 → 철거 / 폐기물 연동
  if 'demolition' not in 활성화된_공정:
    활성화된_공정.add({
      processId: 'demolition',
      space: 'storage',
      category: 'auto_linked',
      value: 'required',
      reason: '목공 공정 필수 연동'
    })

if 'kitchen' in 활성화된_공정:
  // 주방 공정 선택 시 → 설비 / 전기 / 철거 연동
  // 동일 로직
```

### STEP 3. 공정별 그룹화

```typescript
// 공정 ID별로 그룹화
processGroups = Map<ProcessId, {
  spaces: SelectedSpace[]
  categories: string[]
  values: (string | string[])[]
}>
```

### STEP 4. 공정 유형 판단 (헌법 v1 - STEP 2)

각 공정에 대해 다음 규칙으로 유형 판단:

```typescript
function determineProcessType(
  processId: ProcessId,
  isAutoLinked: boolean,
  hasRequiredCondition: boolean
): '필수' | '선택' | '조건부' {
  
  // 필수 공정 자동 삽입된 경우
  if (isAutoLinked) {
    return '필수'
  }
  
  // 조건부 공정 판단 규칙
  if (hasRequiredCondition) {
    return '조건부'
  }
  
  // 그 외는 선택
  return '선택'
}
```

**필수 공정 목록**:
* 철거 (전체 공정 또는 필수 연동)
* 방수 (욕실 공정 시)
* 설비 (욕실/주방 공정 시)
* 전기 (욕실/주방 공정 시)

**조건부 공정 예시**:
* 목공 (가구 옵션 선택 시)
* 필름 (문/창호 교체 대신 필름 시공 선택 시)

---

## 2. 포함 / 제외 / 가정 생성 규칙 (헌법 v1 - STEP 5)

### 2-1. 포함 항목 (inclusions)

**생성 규칙**:
* 공정에 **반드시 포함되는 항목**만 명시
* DB에서 조회한 자재/노무 정보 기반
* "일반적으로", "보통" 같은 표현 금지

**생성 예시**:

```typescript
// 타일 공정
inclusions = [
  '타일 자재 (포세린 600x600)',
  '타일 시공 노무 (2인 1조)',
  '타일 접착제',
  '타일 그라우트',
  '타일 시공 보호재'
]

// 주방 공정
inclusions = [
  '시스템 주방 세트 (상부장 + 하부장)',
  '주방 상판 (쿼츠)',
  '싱크대 (스테인리스)',
  '수도꼭지 (믹서)',
  '주방 시공 노무 (2인 1조)',
  '배수관 연결',
  '가스관 연결'
]
```

### 2-2. 제외 항목 (exclusions)

**생성 규칙**:
* 공정에 **명확히 포함되지 않는 항목**만 명시
* 고객이 오해할 수 있는 항목 명시
* "일반적으로 제외" 같은 표현 금지

**생성 예시**:

```typescript
// 타일 공정
exclusions = [
  '타일 하부 방수 공사 (별도 공정)',
  '타일 하부 전기 배선 (별도 공정)',
  '타일 하부 배관 (별도 공정)',
  '가구 설치 (별도 공정)',
  '조명 설치 (별도 공정)'
]

// 주방 공정
exclusions = [
  '냉장고 (고객 자체 구매)',
  '가스레인지 (고객 자체 구매)',
  '후드 (옵션 선택 시에만 포함)',
  '주방 상부 조명 (별도 공정)',
  '주방 벽면 타일 (별도 공정)'
]
```

### 2-3. 현장 가정 사항 (assumptions)

**생성 규칙**:
* 고객이 입력하지 않아서 **가정한 사항**만 명시
* 가정임을 명확히 표시
* 숨긴 가정 금지

**생성 예시**:

```typescript
// 타일 공정
assumptions = [
  '[가정] 기존 타일 철거 완료 (철거 공정 포함 시)',
  '[가정] 바닥 평탄화 완료 (별도 공정 필요 시 명시)',
  '[가정] 배수구 위치 변경 없음',
  '[가정] 타일 하부 방수 공사 완료 (방수 공정 포함 시)'
]

// 주방 공정
assumptions = [
  '[가정] 기존 주방 철거 완료 (철거 공정 포함 시)',
  '[가정] 가스관 위치 변경 없음',
  '[가정] 배수관 위치 변경 없음',
  '[가정] 전기 콘센트 위치 변경 없음 (전기 공정 별도 시)',
  '[가정] 벽면 타일 시공 완료 (타일 공정 포함 시)'
]
```

---

## 3. 옵션 리스트 생성 규칙 (헌법 v1 - STEP 2, STEP 4)

### 3-1. 옵션은 공정 내부에서만 존재

* 옵션으로 공정을 대체하거나 삭제 ❌
* 옵션은 공정 내부의 **세부 선택 사항**만

### 3-2. 옵션 상태 판단

각 옵션은 다음 중 하나로만 처리:

* **기본 포함**: 공정 선택 시 자동 포함
* **선택 가능**: 고객이 선택해야 포함
* **조건부 자동 포함**: 특정 조건 만족 시 자동 포함

### 3-3. 옵션 생성 예시

```typescript
// 주방 공정 옵션
options = [
  {
    id: 'kitchen_hood',
    name: '후드',
    status: '선택 가능',
    condition: undefined
  },
  {
    id: 'kitchen_led',
    name: '상부장 LED',
    status: '조건부 자동 포함',
    condition: '상부장 선택 시'
  },
  {
    id: 'kitchen_sink_extension',
    name: '싱크대 확장',
    status: '기본 포함',
    condition: undefined
  }
]

// 타일 공정 옵션
options = [
  {
    id: 'tile_grout_color',
    name: '그라우트 색상 선택',
    status: '선택 가능',
    condition: undefined
  },
  {
    id: 'tile_pattern',
    name: '타일 패턴 시공',
    status: '조건부 자동 포함',
    condition: '대형 타일(600x600 이상) 선택 시'
  }
]
```

---

## 4. 공정별 상세 명세

### 4-1. 철거 공정 (demolition)

**공정 유형**: 필수 (전체 공정 또는 필수 연동)

**포함 항목**:
* 철거 노무 (평수 기준)
* 폐기물 반출 (톤 기준)
* 상차·하차 비용

**제외 항목**:
* 구조 변경 (별도 공정)
* 배관 철거 (설비 공정 포함)
* 전기 배선 철거 (전기 공정 포함)

**가정 사항**:
* [가정] 철거 범위는 고객 선택 공간 기준
* [가정] 철거 폐기물은 일반 폐기물 기준 (특수 폐기물 별도)

**옵션**:
* 없음 (철거는 옵션 없음)

---

### 4-2. 마감 공정 (finish)

**공정 유형**: 선택 (고객 선택)

**하위 공정**:
* 벽면 마감 (wall_finish): 도배 / 도장
* 바닥 마감 (floor_finish): 마루 / 타일 / 장판

**포함 항목** (벽면 도배):
* 벽지 자재 (롤 기준)
* 벽지 접착제
* 도배 노무 (㎡ 기준)
* 바탕 작업 (퍼티, 바탕칠)

**제외 항목**:
* 기존 벽지 제거 (철거 공정)
* 벽면 전기 배선 (전기 공정)
* 벽면 배관 (설비 공정)

**가정 사항**:
* [가정] 기존 벽지 제거 완료 (철거 공정 포함 시)
* [가정] 벽면 평탄화 완료
* [가정] 전기 배선 작업 완료 (전기 공정 별도 시)

**옵션**:
```typescript
[
  {
    id: 'wallpaper_type',
    name: '벽지 타입',
    status: '선택 가능',
    values: ['합지', '실크', '천벽지']
  },
  {
    id: 'wallpaper_pattern',
    name: '벽지 패턴',
    status: '조건부 자동 포함',
    condition: '고급 벽지 선택 시'
  }
]
```

---

### 4-3. 주방 공정 (kitchen)

**공정 유형**: 선택 (고객 선택)

**포함 항목**:
* 시스템 주방 세트 (상부장 + 하부장)
* 주방 상판 (기본: 쿼츠)
* 싱크대 (기본: 스테인리스)
* 수도꼭지 (기본: 믹서)
* 주방 시공 노무 (2인 1조)
* 배수관 연결
* 가스관 연결

**제외 항목**:
* 냉장고 (고객 자체 구매)
* 가스레인지 (고객 자체 구매)
* 후드 (옵션 선택 시에만 포함)
* 주방 상부 조명 (전기 공정)
* 주방 벽면 타일 (타일 공정)

**가정 사항**:
* [가정] 기존 주방 철거 완료 (철거 공정 포함 시)
* [가정] 가스관 위치 변경 없음
* [가정] 배수관 위치 변경 없음
* [가정] 전기 콘센트 위치 변경 없음 (전기 공정 별도 시)
* [가정] 벽면 타일 시공 완료 (타일 공정 포함 시)

**옵션**:
```typescript
[
  {
    id: 'kitchen_hood',
    name: '후드',
    status: '선택 가능'
  },
  {
    id: 'kitchen_countertop_upgrade',
    name: '상판 업그레이드',
    status: '선택 가능',
    values: ['엔지니어드 스톤', '수입 대리석']
  },
  {
    id: 'kitchen_led',
    name: '상부장 LED',
    status: '조건부 자동 포함',
    condition: '상부장 선택 시'
  },
  {
    id: 'kitchen_sink_extension',
    name: '싱크대 확장',
    status: '기본 포함'
  }
]
```

---

### 4-4. 욕실 공정 (bathroom)

**공정 유형**: 선택 (고객 선택, 필수 연동 공정 있음)

**포함 항목**:
* 욕실 세트 (양변기 + 세면대 + 거울장)
* 욕실 타일 (벽면 + 바닥)
* 욕실 시공 노무 (2인 1조)
* 방수 공사 (필수 연동)
* 배수관 연결
* 수도꼭지 연결

**제외 항목**:
* 욕조 (옵션 선택 시에만 포함)
* 샤워부스 (옵션 선택 시에만 포함)
* 비데 (옵션 선택 시에만 포함)
* 욕실 조명 (전기 공정)
* 환풍기 (전기 공정)

**가정 사항**:
* [가정] 기존 욕실 철거 완료 (철거 공정 포함 시)
* [가정] 배수관 위치 변경 없음
* [가정] 수도관 위치 변경 없음
* [가정] 전기 배선 작업 완료 (전기 공정 별도 시)

**옵션**:
```typescript
[
  {
    id: 'bathroom_bathtub',
    name: '욕조',
    status: '선택 가능'
  },
  {
    id: 'bathroom_shower',
    name: '샤워부스',
    status: '선택 가능'
  },
  {
    id: 'bathroom_bidet',
    name: '비데',
    status: '선택 가능'
  },
  {
    id: 'bathroom_tile_upgrade',
    name: '타일 업그레이드',
    status: '선택 가능',
    values: ['대형 타일(600x600)', '수입 타일']
  }
]
```

---

### 4-5. 조명·전기 공정 (electric)

**공정 유형**: 선택 또는 필수 (욕실/주방 연동 시 필수)

**포함 항목**:
* 조명 기구 (LED 다운라이트 등)
* 스위치/콘센트
* 전기 배선 (2.5SQ 기준)
* 전기 시공 노무 (1인 기준)
* 분전반 교체 (필요 시)

**제외 항목**:
* 전기 배선 하부 작업 (별도 공정)
* 스마트홈 시스템 (별도 공정)
* 태양광 설치 (별도 공정)

**가정 사항**:
* [가정] 기존 전기 배선 철거 완료 (철거 공정 포함 시)
* [가정] 분전반 위치 변경 없음
* [가정] 전기 용량 증설 없음

**옵션**:
```typescript
[
  {
    id: 'electric_lighting_type',
    name: '조명 타입',
    status: '선택 가능',
    values: ['다운라이트', '간접조명', '라인조명']
  },
  {
    id: 'electric_dimming',
    name: '디밍 기능',
    status: '조건부 자동 포함',
    condition: '간접조명 선택 시'
  },
  {
    id: 'electric_smart_home',
    name: '스마트홈',
    status: '선택 가능'
  }
]
```

---

## 5. 구현 함수 시그니처

### 5-1. 공정 블록 생성 메인 함수

```typescript
/**
 * 공정 블록 생성 (헌법 v1 - STEP 2)
 * 
 * @param processSelections - processSelections (SSOT)
 * @param pyeong - 평수 (입력값 그대로)
 * @param mode - 공정 모드 (FULL / PARTIAL)
 * @param spaceType - 공간 유형
 * @param familyComposition - 가족 구성
 * @param specialConditions - 특이 조건
 * @returns 공정 블록 배열
 */
export async function createProcessBlocks(
  processSelections: Record<string, Record<string, string | string[] | null>>,
  pyeong: number,
  mode: ProcessMode,
  spaceType?: '주거' | '상업' | '사무실' | '기타',
  familyComposition?: {
    adults: number
    children: number
    elderly: number
    pets: boolean
  },
  specialConditions?: string[]
): Promise<ProcessEstimateBlock[]>
```

### 5-2. 공정 유형 판단 함수

```typescript
/**
 * 공정 유형 판단 (헌법 v1 - STEP 2)
 */
function determineProcessType(
  processId: ProcessId,
  isAutoLinked: boolean,
  hasRequiredCondition: boolean,
  customerSelection: boolean
): '필수' | '선택' | '조건부'
```

### 5-3. 포함/제외/가정 생성 함수

```typescript
/**
 * 포함/제외/가정 생성 (헌법 v1 - STEP 5)
 */
function generateInclusionsExclusionsAssumptions(
  processId: ProcessId,
  materialRequests: MaterialRequest[],
  laborRequests: LaborRequest[],
  materialResults: MaterialDbResult[],
  laborResults: LaborDbResult[],
  linkedProcesses: ProcessId[],
  spaceType?: string,
  familyComposition?: any,
  specialConditions?: string[]
): {
  inclusions: string[]
  exclusions: string[]
  assumptions: string[]
}
```

### 5-4. 옵션 리스트 생성 함수

```typescript
/**
 * 옵션 리스트 생성 (헌법 v1 - STEP 2, STEP 4)
 */
function generateOptions(
  processId: ProcessId,
  category: string,
  value: string | string[],
  spaceType?: string,
  familyComposition?: any,
  specialConditions?: string[]
): {
  id: string
  name: string
  status: '기본 포함' | '선택 가능' | '조건부 자동 포함'
  condition?: string
}[]
```

---

## 6. 공정별 포함/제외/가정 템플릿

### 6-1. 철거 공정 템플릿

```typescript
const DEMOLITION_TEMPLATE = {
  inclusions: [
    '철거 노무 (평수 기준)',
    '폐기물 반출 (톤 기준)',
    '상차·하차 비용'
  ],
  exclusions: [
    '구조 변경 (별도 공정)',
    '배관 철거 (설비 공정 포함)',
    '전기 배선 철거 (전기 공정 포함)'
  ],
  assumptions: [
    '[가정] 철거 범위는 고객 선택 공간 기준',
    '[가정] 철거 폐기물은 일반 폐기물 기준 (특수 폐기물 별도)'
  ],
  options: []
}
```

### 6-2. 마감 공정 템플릿

```typescript
const FINISH_TEMPLATE = {
  wall_finish: {
    inclusions: [
      '벽지 자재 (롤 기준)',
      '벽지 접착제',
      '도배 노무 (㎡ 기준)',
      '바탕 작업 (퍼티, 바탕칠)'
    ],
    exclusions: [
      '기존 벽지 제거 (철거 공정)',
      '벽면 전기 배선 (전기 공정)',
      '벽면 배관 (설비 공정)'
    ],
    assumptions: [
      '[가정] 기존 벽지 제거 완료 (철거 공정 포함 시)',
      '[가정] 벽면 평탄화 완료',
      '[가정] 전기 배선 작업 완료 (전기 공정 별도 시)'
    ]
  },
  floor_finish: {
    inclusions: [
      '마루 자재 (㎡ 기준)',
      '마루 시공 노무 (㎡ 기준)',
      '마루 하부 방수 (필요 시)',
      '마루 하부 전기 배선 (필요 시)'
    ],
    exclusions: [
      '기존 마루 제거 (철거 공정)',
      '바닥 평탄화 (별도 공정)',
      '바닥 난방 (별도 공정)'
    ],
    assumptions: [
      '[가정] 기존 마루 제거 완료 (철거 공정 포함 시)',
      '[가정] 바닥 평탄화 완료',
      '[가정] 바닥 난방 작업 완료 (난방 공정 별도 시)'
    ]
  }
}
```

---

## 7. 구현 체크리스트

### Phase 1: 기본 구조
- [ ] processSelections 순회 및 활성화 판단
- [ ] 공정별 그룹화
- [ ] 공정 유형 판단 함수
- [ ] 기본 포함/제외/가정 템플릿

### Phase 2: 필수 공정 자동 삽입
- [ ] 욕실 → 방수/설비/전기/철거 연동
- [ ] 목공 → 철거/폐기물 연동
- [ ] 주방 → 설비/전기/철거 연동

### Phase 3: 포함/제외/가정 생성
- [ ] 공정별 템플릿 적용
- [ ] 연동 공정 기반 가정 생성
- [ ] 고객 입력 기반 가정 생성

### Phase 4: 옵션 리스트 생성
- [ ] 공정별 옵션 정의
- [ ] 옵션 상태 판단 (기본 포함/선택 가능/조건부)
- [ ] 조건부 옵션 자동 포함 로직

### Phase 5: DB 조회 및 금액 계산
- [ ] MaterialRequest → DB 조회
- [ ] LaborRequest → DB 조회
- [ ] 노무비 계산 (헌법 6-3 공식)
- [ ] 공정 총액 계산

---

## 8. 예외 처리 규칙

### 8-1. 공정 없음

```typescript
if (활성화된_공정.length === 0):
  return {
    status: 'ESTIMATE_FAILED',
    reason: '공정 없이 견적 생성 시도'
  }
```

### 8-2. 필수 연동 공정 누락

```typescript
if ('bathroom' in 활성화된_공정):
  if ('demolition' not in 활성화된_공정 AND mode !== 'FULL'):
    return {
      status: 'ESTIMATE_FAILED',
      reason: '욕실 공정 선택 시 철거 공정 필수 연동 필요'
    }
```

### 8-3. DB 데이터 없음

```typescript
if (materialResult.status === 'NOT_FOUND' OR laborResult.status === 'NOT_FOUND'):
  return {
    status: 'ESTIMATE_FAILED',
    reason: `공정 ${processId}: 자재 또는 노무 데이터 부족`
  }
```

---

## 9. 최종 출력 구조 (헌법 v1 - STEP 5)

공정 블록은 다음 순서로 출력:

1. **공정명** + **공정 유형**
2. **적용 공간**
3. **포함 항목**
4. **제외 항목**
5. **현장 가정 사항**
6. **옵션 리스트**
7. **자재 정보** (브랜드/제품명/규격)
8. **노무 정보** (단위/작업량/인원/난이도)
9. **금액** (자재비/노무비/공정 총액)
10. **DB 근거** (table + key)

---

## 10. 구현 우선순위

### Priority 1 (즉시 구현)
1. processSelections 순회 및 활성화 판단
2. 공정별 그룹화
3. 기본 포함/제외/가정 템플릿 적용
4. DB 조회 및 금액 계산

### Priority 2 (다음 단계)
1. 필수 공정 자동 삽입 규칙
2. 공정 유형 판단 로직
3. 옵션 리스트 생성

### Priority 3 (보완)
1. 조건부 옵션 자동 포함 로직
2. 고객 입력 기반 가정 생성
3. 특수 조건 처리 (아이, 반려동물, 고령자)

---

## 최종 선언

이 명세서는 **헌법 v1 STEP 2의 완전한 구현 가이드**입니다.

* 모든 규칙은 **절대 기준**
* 예외 처리 없음
* "일반적으로", "보통" 같은 표현 금지
* 가정은 반드시 명시

이 기준으로만 구현한다.










