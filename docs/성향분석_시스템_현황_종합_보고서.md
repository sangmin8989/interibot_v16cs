# 인테리봇 성향분석 시스템 현황 종합 보고서

> 작성일: 2024년  
> 목적: 성향분석 시스템 재설계를 위한 현황 파악  
> 범위: 질문 체계, 입력 스키마, 결정 대상, 삭제 범위, 기술 제약

---

## 📋 목차

1. [현재 기준 확정 소스](#1-현재-기준-확정-소스-필수)
2. [고객 입력 스키마](#2-고객-입력-스키마-필수)
3. [결정 대상 정의](#3-결정-대상-정의-핵심-필수)
4. [삭제·폐기 허용 범위](#4-삭제폐기-허용-범위-필수)
5. [기술 제약](#5-기술-제약-필수)

---

## 1. 현재 기준 확정 소스 (필수)

### 1.1 성향 질문 전체 목록

#### Quick 모드 (4문항)

| 질문 ID | 질문 문구 | 답변 타입 | 답변 옵션 수 |
|---------|----------|----------|------------|
| `quick_first_scene` | 퇴근해서 현관을 열었을 때, 제일 먼저 보이고 싶은 장면은 무엇인가요? | 단일 선택 | 6개 |
| `quick_photo_space` | 집에서 "사진 찍어 올리고 싶은 공간"을 하나 만든다면 어디인가요? | 단일 선택 | 6개 |
| `quick_no_compromise` | 인테리어에서 절대 타협하고 싶지 않은 한 가지는 무엇인가요? | 단일 선택 | 6개 |
| `quick_atmosphere` | 앞으로 집의 전체 분위기를 한 단어로 바꿀 수 있다면, 어떤 느낌이 가장 가깝나요? | 단일 선택 | 6개 |

**Quick 모드 답변 예시**:
- `quick_first_scene`: `hotel_hallway`, `warm_kitchen`, `cozy_living`, `family_space`, `aesthetic_decor`, `ai_choice`
- `quick_photo_space`: `living_room`, `kitchen`, `bedroom`, `bathroom`, `workspace`, `ai_choice`
- `quick_no_compromise`: `natural_light`, `lighting`, `storage`, `finish_quality`, `flow`, `ai_choice`
- `quick_atmosphere`: `healing`, `focus`, `family`, `leisure`, `success`, `ai_choice`

#### Standard 모드 (10문항 + 판단축 6문항 = 16문항)

| 질문 ID | 질문 문구 | 답변 타입 | 답변 옵션 수 |
|---------|----------|----------|------------|
| `standard_main_space` | 집에서 하루 중 가장 오래 머무는 공간은 어디인가요? | 단일 선택 | 6개 |
| `standard_daily_discomfort` | 현재 집에서 "매일 불편하지만 참고 넘어가는 것"에 가장 가까운 것은 무엇인가요? | 단일 선택 | 6개 |
| `standard_cleaning_style` | 청소와 정리에 대한 본인 스타일에 가장 가까운 것은? | 단일 선택 | 6개 |
| `standard_family_time` | 가족이 한자리에 가장 자주 모이는 시간대와 장소는 언제, 어디인가요? | 단일 선택 | 6개 |
| `standard_kids_pets` | 아이 또는 반려동물이 있다면, 그들의 공간에 대한 선호에 가장 가까운 것은? | 단일 선택 | 6개 (선택사항) |
| `standard_daily_scene` | 인테리어 후, 가장 먼저 바뀌었으면 하는 "하루의 장면"은 무엇인가요? | 단일 선택 | 6개 |
| `standard_budget_priority` | 예산을 생각할 때 가장 우선순위를 두고 싶은 부분은 어디인가요? | 단일 선택 | 6개 |
| `standard_lifestyle_change` | 앞으로 3년 안에 라이프스타일이 크게 달라질 가능성이 있는 요소는 무엇인가요? | 단일 선택 | 6개 (선택사항) |
| `standard_personal_space` | "이 집에서 나만을 위한 자리"를 만든다면, 어디에 가장 가깝나요? | 단일 선택 | 6개 (선택사항) |
| `standard_compliment` | 인테리어가 끝난 후, 지인들에게 가장 듣고 싶은 말은 무엇인가요? | 단일 선택 | 6개 (선택사항) |

**판단 축 질문 (6문항)**:
- `judgment_irreversible_priority`: 리스크 회피도 측정
- `judgment_construction_dislike`: 리스크 회피도 + 결정 지연 성향
- `judgment_choice_preference`: 통제 욕구 측정
- `judgment_decision_delay`: 결정 지연 성향
- `judgment_inconvenience_preference`: 비용 민감도 + 리스크 회피도
- `judgment_maintenance_tradeoff`: 비용 민감도

#### Deep 모드 (17문항)

| 질문 ID | 질문 문구 | 답변 타입 | 답변 옵션 수 |
|---------|----------|----------|------------|
| `deep_sleep_brightness` | 잠잘 때 방의 밝기에 대한 선호는? | 단일 선택 | 6개 |
| `deep_sleep_disturbance` | 수면에 가장 방해가 되는 요소는? | 단일 선택 | 6개 |
| `deep_morning_first_10min` | 아침 일어난 후 첫 10분을 가장 편하게 보내고 싶은 공간은? | 단일 선택 | 6개 |
| `deep_physical_constraint` | 몸 상태 때문에 피하고 싶은 동작·자세는? | 단일 선택 | 6개 (선택사항) |
| `deep_seasonal_usage` | 계절에 따라 집 사용 방식이 어떻게 달라지나요? | 단일 선택 | 6개 (선택사항) |
| `deep_organization_style` | 정리·수납에 대한 본인 스타일은? | 단일 선택 | 6개 |
| `deep_electronics_location` | 전자기기(모니터, 스피커, 콘센트)가 많이 몰린 공간은? | 단일 선택 | 6개 (선택사항) |
| `deep_bathroom_usage` | 욕실 사용 방식에 가장 가까운 것은? | 단일 선택 | 6개 (선택사항) |
| `deep_cooking_stress` | 요리할 때 가장 스트레스 받는 요소는? | 단일 선택 | 6개 (선택사항) |
| `deep_smell_concern` | 집 안에서 냄새가 가장 신경 쓰이는 곳은? | 단일 선택 | 6개 (선택사항) |
| `deep_allergy` | 알레르기나 공기질 때문에 신경 쓰이는 부분은? | 단일 선택 | 6개 (선택사항) |
| `deep_lighting_change` | 현재 조명 사용 상태와 바꾸고 싶은 방향은? | 단일 선택 | 6개 (선택사항) |
| `deep_work_hours` | 집에서 일(재택근무·공부·작업)하는 시간은? | 단일 선택 | 6개 (선택사항) |
| `deep_guest_frequency` | 손님(친구·지인·고객)이 집에 오는 빈도는? | 단일 선택 | 6개 (선택사항) |
| `deep_future_3_5_years` | 3~5년 뒤 이 집에서 가장 가능성 큰 변화는? | 단일 선택 | 6개 (선택사항) |
| `deep_health_goal` | 이 집이 나를 더 건강하게 만들었으면 하는 부분은? | 단일 선택 | 6개 (선택사항) |
| `deep_keep_unchanged` | 현재 집에서 절대 건드리지 않았으면 하는 것은? | 단일 선택 | 6개 (선택사항) |
| `deep_habit_change` | 이번 인테리어를 계기로 바꾸고 싶은 생활 습관은? | 단일 선택 | 6개 (선택사항) |

#### Vibe 모드

- MBTI, 혈액형, 별자리 입력 후 추가 질문 진행

**전체 질문 수**: 약 37개 (Quick 4 + Standard 16 + Deep 17)

---

### 1.2 answer-mappings 최종본

**파일 위치**: `lib/analysis/answer-mappings.ts`

**구조**:
```typescript
export interface AnswerMapping {
  questionId: string;
  answerValue: string;
  impacts: AnswerImpact[];  // 1~2개 카테고리, 점수 1~10
}

export interface AnswerImpact {
  category: PreferenceCategory;  // 15개 카테고리 중 하나
  score: number;  // 1~10 범위
}
```

**카테고리 목록 (15개)**:
1. `space_sense` - 공간 감각
2. `sensory_sensitivity` - 감각 민감도
3. `cleaning_preference` - 청소 선호도
4. `organization_habit` - 정리 습관
5. `family_composition` - 가족 구성
6. `health_factors` - 건강 요소
7. `budget_sense` - 예산 감각
8. `color_preference` - 색상 선호도
9. `lighting_preference` - 조명 선호도
10. `home_purpose` - 집 목적
11. `discomfort_factors` - 불편 요소
12. `activity_flow` - 활동 흐름
13. `life_routine` - 생활 루틴
14. `sleep_pattern` - 수면 패턴
15. `hobby_lifestyle` - 취미 라이프스타일

**매핑 데이터 통계**:
- Quick 모드: 24개 매핑 (4문항 × 6옵션)
- Standard 모드: 약 100개 매핑
- Deep 모드: 약 100개 매핑
- Vibe 모드: 약 50개 매핑
- 판단 축 질문: 약 30개 매핑
- **전체**: 약 300개 이상의 매핑

**사용 함수**:
```typescript
// 특정 질문-답변의 영향 가져오기
export function getAnswerImpacts(
  questionId: string,
  answerValue: string
): AnswerImpact[] | null

// 모든 답변으로부터 카테고리별 점수 계산
export function calculateScoresFromAnswers(
  answers: Record<string, unknown>
): Record<PreferenceCategory, number>
```

---

### 1.3 질문 기준표 (JSON) 최종본

**파일 위치**: `lib/traits/question-criteria-v3.json`

**구조**:
```json
{
  "version": "3.0.0",
  "description": "V3 질문 기준표",
  "questions": {
    "quick": {
      "Q1": {
        "id": "daily_tired_time",
        "text": "하루 중 집에서 가장 지치는 시간대는 언제인가요?",
        "mode": "quick",
        "options": {
          "morning": {
            "text": "아침 준비 시간",
            "impact": {
              "indicators": {
                "동선중요도": { "change": "very_large", "value": 25 },
                "수납중요도": { "change": "medium", "value": 15 }
              },
              "lifestyleType": "morning",
              "keywords": ["아침형", "동선 효율", "시간 단축"]
            }
          }
        }
      }
    },
    "standard": { /* ... */ },
    "deep": { /* ... */ }
  }
}
```

**Impact 구조**:
- `indicators`: V3 한글 키 → 영향값 (-50~+50)
- `lifestyleType`: `morning`, `evening`, `weekend`, `focus`, `general`
- `keywords`: 키워드 배열

**사용 여부**:
- ✅ V3 TraitEngine에서 사용
- ✅ answer-mappings에 없는 질문의 fallback
- ⚠️ answer-mappings 우선순위가 더 높음

**관련 파일**:
- `lib/traits/trait-indicators-v3.json`: 12개 성향 지표 정의
- `lib/traits/trait-process-mapping-v3.json`: 성향→공정 매핑
- `lib/traits/lifestyle-scenarios-v3.json`: 생활 시나리오

---

## 2. 고객 입력 스키마 (필수)

### 2.1 고객 기본 정보 입력 구조

**V4 입력 타입**: `CollectedInputV4`

```typescript
interface CollectedInputV4 {
  spaceInfo: SpaceInfoV4
  answers: UserAnswerV4[]
  preferences: PreferencesV4
  selectedSpaces: string[]
  selectedProcesses: Record<string, string[]>
  timestamp: string
}
```

#### SpaceInfoV4 (공간 정보)

```typescript
interface SpaceInfoV4 {
  housingType: 'apartment' | 'villa' | 'house' | 'officetel'  // 주거 유형
  pyeong: number                                              // 평수 (전용면적)
  rooms: number                                               // 방 개수
  bathrooms: number                                          // 화장실 개수
  buildingAge?: number                                        // 건물 연식 (년) - 선택
  floor?: number                                              // 층수 - 선택
}
```

#### UserAnswerV4 (성향 질문 답변)

```typescript
interface UserAnswerV4 {
  questionId: string      // 질문 ID (예: 'quick_first_scene')
  answerId: string        // 답변 ID (예: 'hotel_hallway')
  value: number | string | boolean  // 답변 값
}
```

#### PreferencesV4 (사용자 선호 설정)

```typescript
interface PreferencesV4 {
  budget: {
    min: number                                    // 최소 예산 (원)
    max: number                                    // 최대 예산 (원)
    flexibility: 'strict' | 'flexible' | 'uncertain'  // 예산 유연성
  }
  
  family: {
    totalPeople: number    // 총 거주 인원
    hasInfant: boolean     // 영유아 유무 (0-3세)
    hasChild: boolean      // 어린이 유무 (4-12세)
    hasElderly: boolean    // 노인 유무 (65세 이상)
    hasPet: boolean        // 반려동물 유무
  }
  
  lifestyle: {
    remoteWork: boolean    // 재택근무 여부
    cookOften: boolean     // 자주 요리하는지
    guestsOften: boolean   // 손님 자주 오는지
  }
  
  purpose: 'live' | 'sell' | 'rent'  // 거주 목적
}
```

---

### 2.2 실제 프론트에서 넘어오는 값 예시

**API 엔드포인트**: `/api/estimate/v4`

**요청 예시**:
```json
{
  "spaceInfo": {
    "housingType": "apartment",
    "pyeong": 32,
    "rooms": 3,
    "bathrooms": 2,
    "buildingAge": 10,
    "floor": 5
  },
  "answers": [
    {
      "questionId": "quick_first_scene",
      "answerId": "hotel_hallway",
      "value": "hotel_hallway"
    },
    {
      "questionId": "quick_photo_space",
      "answerId": "living_room",
      "value": "living_room"
    },
    {
      "questionId": "standard_cleaning_style",
      "answerId": "system_needed",
      "value": "system_needed"
    }
  ],
  "preferences": {
    "budget": {
      "min": 50000000,
      "max": 80000000,
      "flexibility": "moderate"
    },
    "family": {
      "totalPeople": 3,
      "hasInfant": false,
      "hasChild": true,
      "hasElderly": false,
      "hasPet": false
    },
    "lifestyle": {
      "remoteWork": true,
      "cookOften": true,
      "guestsOften": false
    },
    "purpose": "live"
  },
  "selectedSpaces": ["kitchen", "bathroom", "living"],
  "selectedProcesses": {
    "kitchen": ["kitchen_core"],
    "bathroom": ["bathroom_waterproof"]
  },
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

**입력 수집 경로**:
1. `app/space-info/page.tsx`: 공간 정보 입력
2. `app/onboarding/personality/page.tsx`: 성향 질문 답변
3. `app/onboarding/scope/page.tsx`: 공간 선택
4. `app/onboarding/process/page.tsx`: 공정 선택
5. `app/onboarding/estimate/page.tsx`: 예산 입력

**상태 관리**:
- `lib/store/spaceInfoStore.ts`: 공간 정보
- `lib/store/personalityStore.ts`: 성향 분석 결과
- `lib/store/scopeStore.ts`: 공간 선택
- `lib/store/processStore.ts`: 공정 선택

---

## 3. 결정 대상 정의 (핵심, 필수)

### 3.1 성향 분석 결과로 바꾸고 싶은 것 목록

#### 3.1.1 공정 포함/제외 항목 리스트

**V5 태그 기반 공정 변경** (`lib/analysis/v5/tag-process-mapper.ts`):

| 태그 | 공정 변경 | 이유 |
|------|----------|------|
| `OLD_RISK_HIGH` | `waterproof`, `insulation`, `window`, `plumbing` → **required** | 노후 리스크 HIGH - 필수 공정 |
| `OLD_RISK_MEDIUM` | `waterproof`, `insulation` → **recommend** | 노후 리스크 MEDIUM - 권장 공정 |
| `STORAGE_RISK_HIGH` | `closet`, `shoeRack` → **enable** | 수납 리스크 HIGH - 기본 ON |
| `SHORT_STAY` | `demolition` → **disable** | 단기 거주 - 구조변경 OFF |
| `LONG_STAY` | `demolition` → **enable** | 장기 거주 - 구조변경 허용 |
| `SAFETY_RISK` | `bathroomSafety` → **required** | 안전 리스크 - 욕실 안전옵션 필수 |
| `KITCHEN_IMPORTANT` | `kitchen` → **enable** | 주방 중요 - 공정 확장 |

**공정 액션 타입**:
- `enable`: 공정 활성화 (기본 ON)
- `disable`: 공정 비활성화 (기본 OFF)
- `recommend`: 공정 권장
- `required`: 공정 필수

---

#### 3.1.2 옵션 기본 ON/OFF 리스트

**V5 태그 기반 옵션 변경**:

| 태그 | 옵션 변경 | 이유 |
|------|----------|------|
| `SAFETY_RISK` | `slipPrevention`, `handrail`, `thresholdRemoval` → **show** | 안전 리스크 - 미끄럼방지/손잡이/턱제거 필수 |
| `DECISION_FATIGUE_HIGH` | 모든 옵션 → **limit: 3개** | 결정 피로 HIGH - 옵션 최대 3개 |
| `KITCHEN_IMPORTANT` | `kitchenOptions` → **prioritize** | 주방 중요 - 상세 옵션 우선 적용 |
| `BATHROOM_COMFORT` | `bathtub` → **prioritize** | 욕실 여유 - 욕조 옵션 우선 적용 |
| `MAINTENANCE_EASY` | `easyMaintenance` → **prioritize** | 관리 피로 - 관리 쉬운 자재 우선 |

**옵션 액션 타입**:
- `prioritize`: 우선 적용
- `limit`: 제한 (최대 개수)
- `hide`: 제외

---

#### 3.1.3 질문 우선순위 바뀌는 항목

**V5 질문 선택 시스템** (`lib/analysis/v5/question-selector.ts`):

- **가설 기반 질문 선별**: 성향 태그에 따라 질문 우선순위 변경
- **선택 장애 탐지**: 결정 피로도에 따라 질문 수 조정
- **동적 질문 로딩**: 답변에 따라 다음 질문 변경

**현재 구현**:
- Quick/Standard/Deep 모드로 고정
- V5에서는 동적 질문 선택 (최대 6개)

---

#### 3.1.4 리스크 문구 후보

**V4 RiskAssessor** (`lib/estimate-v4/engines/personality/RiskAssessor.ts`):

| 위험 코드 | 메시지 | 심각도 | 예비비 추가 |
|----------|--------|--------|------------|
| `first_time_buyer` | 첫 인테리어 경험으로 예상치 못한 상황이 발생할 수 있습니다. | medium | +3% |
| `tight_budget` | 예산 여유가 없어 추가 비용 발생 시 어려움이 있을 수 있습니다. | medium | +2% |
| `unclear_style` | 스타일이 미정이면 시공 중 변경이 발생할 수 있습니다. | low | +1% |
| `old_building` | 20년 이상 건물은 숨은 하자 발견 확률이 높습니다. | high | +5% |
| `large_family` | 가족 구성원이 많아 의견 조율이 필요합니다. | low | +1% |
| `joint_decision` | 공동 의사결정으로 진행 속도가 느려질 수 있습니다. | low | +1% |

**V5 리스크 메시지 생성** (`lib/analysis/v5/risk-message-generator.ts`):
- 태그 기반 리스크 문구 생성
- 성향 태그 + 기본 정보 조합

---

### 3.2 성향 결과로 달라져야 하는 것 (핵심)

#### ✅ 공정 추천 변경
- 성향 점수 → 공정 우선순위
- 예: `storage_importance >= 7` → `storage_system` 공정 필수

#### ✅ 옵션 기본값 변경
- 성향 점수 → 옵션 ON/OFF
- 예: `cleaning_preference >= 7` → `dishwasher` 옵션 기본 ON

#### ✅ 등급 추천 변경
- 성향 점수 → 등급 추천
- 예: `budget_flexibility >= 7` → `premium` 등급 추천

#### ✅ 리스크 문구 변경
- 성향 점수 → 위험 요소 탐지
- 예: `complexity_tolerance <= 3` → "공사 복잡도 수용성 낮음" 경고

#### ✅ 질문 순서 변경
- 성향 태그 → 다음 질문 우선순위
- 예: `STORAGE_RISK_HIGH` 태그 → 수납 관련 질문 우선 노출

#### ✅ 견적 금액 변경
- 성향 점수 → 자재 등급 조정
- 예: `value_protection >= 7` → 고급 자재 추천 → 견적 상승

---

## 4. 삭제·폐기 허용 범위 (필수)

### 4.1 V3 TraitEngine

**현재 상태**: ✅ **유지 필수**

**이유**:
- V4 PersonalityEngine이 V3 TraitEngine을 래핑하여 사용
- 핵심 성향 분석 로직이 V3에 구현됨
- 12개 성향 지표 계산의 근본 로직

**위치**: `lib/analysis/engine-v3/engines/TraitEngine.ts`

**의존성**:
- V4 TraitScorer → V3 TraitEngine 호출
- V3 ProcessEngine → V3 TraitEngine 결과 필요
- V3 RiskEngine → V3 TraitEngine 결과 필요

**결론**: ❌ **삭제 불가** (핵심 엔진)

---

### 4.2 V4 PersonalityEngine

**현재 상태**: ✅ **유지 필수**

**이유**:
- 최신 인터페이스 (V4)
- V3를 래핑하여 호환성 유지
- TypeClassifier, RiskAssessor 등 신규 기능 포함

**위치**: `lib/estimate-v4/engines/personality/`

**결론**: ❌ **삭제 불가** (메인 인터페이스)

---

### 4.3 MBTI/VibeInput

**현재 상태**: ⚠️ **부분 유지 (로그만)**

**현재 사용**:
- `lib/analysis/vibeAnalyzer.ts`: MBTI/혈액형/별자리 분석
- `app/vibe-profile/page.tsx`: Vibe 입력 페이지
- `app/onboarding/personality/page.tsx`: Vibe 모드 지원

**V3 TraitEngine에서 사용**:
```typescript
// V3 TraitEngine.adjustByVibeInput()
if (vibeInput.mbti) {
  // MBTI 기반 조정 (간단한 예시)
  if (mbti.includes('J')) {
    adjusted.수납중요도 += 5
  }
}
```

**문제점**:
- V4에서 V3로 변환 시 VibeInput이 전달되지 않음
- 실제로 작동하지 않음

**권장 조치**:
- ✅ **로그만 유지**: 입력은 받지만 성향 분석에는 미반영
- ⚠️ **또는 완전 폐기**: VibeInput 입력 UI 제거

**결론**: ⚠️ **로그만 유지 또는 폐기 가능**

---

### 4.4 점수 결과 화면

**현재 상태**: ✅ **유지 필수**

**표시 위치**:
1. `app/result/ResultContent.tsx`: 성향 분석 결과 페이지
2. `app/onboarding/estimate/page.tsx`: 견적 페이지 (성향 매칭도)
3. `components/onboarding/v4/V4EstimateResultDisplay.tsx`: V4 견적 결과

**표시 내용**:
- 성향 점수 (15개 카테고리 또는 12개 지표)
- 성향 매칭도 (0-100%)
- 집값 방어 점수 (별점 5개)
- 생활 개선 점수
- 우선 문제 영역
- 키워드

**결론**: ❌ **삭제 불가** (사용자 피드백 핵심)

---

### 4.5 기타 삭제 가능 항목

#### ✅ 삭제 가능
- `lib/analysis/engine-v2.ts`: V2 엔진 (레거시)
- `lib/analysis/engine.ts`: 구 엔진 통합 파일
- 테스트 스크립트 중 사용하지 않는 것

#### ❌ 삭제 불가
- `lib/analysis/engine-v3/`: V3 엔진 전체
- `lib/estimate-v4/`: V4 시스템 전체
- `lib/analysis/answer-mappings.ts`: 답변 매핑 테이블
- `lib/traits/question-criteria-v3.json`: 질문 기준표
- `lib/store/personalityStore.ts`: 성향 분석 상태 관리

---

## 5. 기술 제약 (필수)

### 5.1 Cursor 제약 조건

**파일 위치**: `.cursor/rules/.cursorrules`

**주요 제약**:
1. **파일 수정 규칙**:
   - 기존 내용 복사/붙여넣기 금지
   - 필요한 부분만 수정
   - 전체 덮어쓰기 금지

2. **빌드 체크**:
   - 파일 3개 이상 수정 후 `npm run build` 실행 필수
   - 타입 에러 무시 금지

3. **금지 사항**:
   - 한 번에 10개 이상 파일 수정 금지
   - 같은 파일 반복 수정 금지

4. **인코딩**:
   - 모든 파일 UTF-8 (BOM 없음)

5. **주석 규칙**:
   - 모든 주석은 영문으로만 작성
   - 한글 주석 사용 금지
   - JSDoc도 영문으로만

6. **보호 파일** (오늘 수정 금지):
   - `types/process-options.ts`
   - `constants/process-definitions.ts`
   - `constants/process-mapping.ts`
   - `components/onboarding/process/TierOptionSelector.tsx`
   - `app/onboarding/process-new/page.tsx`
   - `lib/store/processStore.ts`

---

### 5.2 파일명 고정 여부

#### ✅ 고정 파일명 (변경 불가)

**API 라우트**:
- `app/api/estimate/v4/route.ts` - V4 견적 API
- `app/api/analysis/submit/route.ts` - 성향 분석 제출
- `app/api/analyze/v5/route.ts` - V5 분석 API

**타입 정의**:
- `lib/estimate-v4/types/personality.types.ts` - V4 성향 타입
- `lib/estimate-v4/types/input.types.ts` - V4 입력 타입

**엔진 파일**:
- `lib/analysis/engine-v3/engines/TraitEngine.ts` - V3 성향 엔진
- `lib/estimate-v4/engines/personality/PersonalityEngineV4.ts` - V4 성향 엔진

**데이터 파일**:
- `lib/analysis/answer-mappings.ts` - 답변 매핑 테이블
- `lib/traits/question-criteria-v3.json` - 질문 기준표

#### ⚠️ 변경 가능 파일명

- 테스트 파일
- 유틸리티 파일
- 문서 파일

---

### 5.3 API 인터페이스 변경 가능 여부

#### ❌ 변경 불가 (하위 호환성 필수)

**공개 API**:
- `/api/estimate/v4` - V4 견적 API
  - 요청 형식: `CollectedInputV4`
  - 응답 형식: `UIEstimateV4`
  
- `/api/analysis/submit` - 성향 분석 제출
  - 요청 형식: `AnalysisRequest`
  - 응답 형식: `AnalysisResult`

- `/api/analyze/v5` - V5 분석 API
  - 요청 형식: `V5AnalysisRequest`
  - 응답 형식: `V5AnalysisResult`

**변경 시 영향**:
- 프론트엔드 코드 수정 필요
- 기존 사용자 세션 깨짐
- 배포 시 호환성 문제

**결론**: ❌ **API 인터페이스 변경 불가** (하위 호환성 필수)

---

### 5.4 기존 DB 스키마 변경 가능 여부

#### ⚠️ 제한적 변경 가능

**Supabase 테이블**:

**변경 가능**:
- 데이터 추가 (새 레코드)
- 인덱스 추가
- 함수 추가

**변경 불가 (또는 신중히)**:
- 기존 컬럼 삭제
- 기존 컬럼 타입 변경
- 제약조건 삭제

**주요 테이블**:
- `personality_traits`: 성향 특성
- `personality_materials`: 성향-자재 매핑
- `answer_score_mapping`: 답변-점수 매핑
- `materials`: 자재 정보
- `construction_phases`: 공사 단계

**권장 조치**:
- ✅ 새 컬럼 추가는 가능
- ✅ 새 테이블 생성은 가능
- ❌ 기존 테이블 구조 변경은 마이그레이션 필요

---

## 6. 종합 정리

### 6.1 현재 확정 소스 요약

| 항목 | 파일 위치 | 상태 | 비고 |
|------|----------|------|------|
| 질문 목록 | `lib/analysis/questions/` | ✅ 확정 | Quick 4, Standard 16, Deep 17 |
| answer-mappings | `lib/analysis/answer-mappings.ts` | ✅ 확정 | 약 300개 매핑 |
| 질문 기준표 | `lib/traits/question-criteria-v3.json` | ✅ 확정 | V3 형식 |
| 성향 지표 | `lib/traits/trait-indicators-v3.json` | ✅ 확정 | 12개 지표 |

---

### 6.2 고객 입력 스키마 요약

| 항목 | 타입 | 필수 여부 |
|------|------|----------|
| 공간 정보 | `SpaceInfoV4` | ✅ 필수 |
| 성향 답변 | `UserAnswerV4[]` | ✅ 필수 |
| 선호 설정 | `PreferencesV4` | ✅ 필수 |
| 공간 선택 | `string[]` | ⚠️ 선택 |
| 공정 선택 | `Record<string, string[]>` | ⚠️ 선택 |

---

### 6.3 결정 대상 요약

**성향 결과로 변경되는 것**:
1. ✅ 공정 포함/제외 (태그 기반)
2. ✅ 옵션 기본 ON/OFF (태그 기반)
3. ✅ 등급 추천 (성향 점수 기반)
4. ✅ 리스크 문구 (위험 요소 기반)
5. ⚠️ 질문 우선순위 (V5에서 동적, 현재는 고정)
6. ✅ 견적 금액 (자재 등급 조정)

---

### 6.4 삭제 허용 범위 요약

| 항목 | 상태 | 조치 |
|------|------|------|
| V3 TraitEngine | ❌ 삭제 불가 | 유지 필수 |
| V4 PersonalityEngine | ❌ 삭제 불가 | 유지 필수 |
| MBTI/VibeInput | ⚠️ 로그만 또는 폐기 | 선택 가능 |
| 점수 결과 화면 | ❌ 삭제 불가 | 유지 필수 |
| V2 엔진 | ✅ 삭제 가능 | 레거시 |

---

### 6.5 기술 제약 요약

| 항목 | 제약 내용 |
|------|----------|
| Cursor 규칙 | 파일 수정 규칙, 빌드 체크, 보호 파일 |
| 파일명 | API 라우트, 타입 정의, 엔진 파일 고정 |
| API 인터페이스 | ❌ 변경 불가 (하위 호환성) |
| DB 스키마 | ⚠️ 제한적 변경 가능 (마이그레이션 필요) |

---

## 7. 권장 사항

### 7.1 즉시 수정 필요

1. **TraitScorer에 preferences 파라미터 추가**
   - 현재 preferences 정보가 손실됨
   - TypeClassifier가 제대로 작동하지 않음

2. **VibeInput 지원 추가 또는 완전 제거**
   - 현재 작동하지 않음
   - 지원하려면 V4 → V3 변환 시 전달 필요
   - 또는 완전히 제거

3. **TypeClassifier의 organization_habit 수정**
   - 존재하지 않는 키 조회
   - `storage_importance`로 대체 필요

---

### 7.2 단기 개선

1. **점수 변환 공식 개선**
   - answer-mappings의 1-10 → -50~+50 변환 공식 정확도 향상

2. **SpaceInfo에 totalPeople 추가**
   - V3 SpaceInfo 타입에 totalPeople 필드 추가

3. **에러 처리 개선**
   - 기본값 반환 대신 명시적 에러 처리

---

### 7.3 장기 개선

1. **타입 안정성 강화**
   - 모든 `any` 타입을 구체적인 타입으로 변경

2. **로깅 통일**
   - console.log → logger로 통일

3. **성능 최적화**
   - 질문 기준표 캐싱
   - 답변 처리 병렬화

---

## 8. 결론

인테리봇 성향분석 시스템은 **V4 PersonalityEngine**이 메인 인터페이스이며, 내부적으로 **V3 TraitEngine**을 호출하는 구조입니다.

**핵심 발견**:
1. ✅ 질문 체계는 확정됨 (37개 질문)
2. ✅ answer-mappings는 최종본 (약 300개 매핑)
3. ✅ 고객 입력 스키마는 명확함 (V4 타입)
4. ✅ 결정 대상은 정의됨 (공정/옵션/등급/리스크)
5. ⚠️ V3/V4 엔진은 삭제 불가 (핵심 로직)
6. ⚠️ MBTI/VibeInput은 현재 작동하지 않음 (로그만 또는 폐기)
7. ❌ API 인터페이스는 변경 불가 (하위 호환성)

**다음 단계**:
1. TraitScorer의 preferences 정보 손실 문제 수정
2. TypeClassifier의 키 조회 문제 수정
3. VibeInput 지원 추가 또는 완전 제거 결정
4. 점수 변환 공식 개선

---

**문서 작성일**: 2024년  
**최종 업데이트**: 2024년  
**작성자**: AI Assistant




