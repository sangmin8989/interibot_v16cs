# 헌법 v1.1 - 다음 단계 실행 가이드

**작성일**: 2025년 12월  
**목적**: 헌법 v1.1 최종 봉인 작업 후 필수 실행 단계

---

## 📋 실행 순서

### 1단계: 제약조건 위반 데이터 확인 (필수)

**파일**: `docs/헌법_v1.1_제약조건_위반_데이터_확인_SQL.sql`

**실행 방법**:
1. Supabase Dashboard → SQL Editor 열기
2. `헌법_v1.1_제약조건_위반_데이터_확인_SQL.sql` 파일 내용 복사
3. SQL Editor에 붙여넣기
4. Run 버튼 클릭

**확인 사항**:
- 위반 데이터가 있는지 확인
- 위반 데이터가 있으면 먼저 수정 필요
- 위반 데이터가 없으면 다음 단계 진행

**예상 결과**:
- 위반 데이터가 있으면: 각 테이블별 위반 건수 표시
- 위반 데이터가 없으면: 모든 쿼리 결과가 0건

---

### 1.5단계: 위반 데이터 처리 (필수)

**파일 선택**:
- **권장**: `docs/헌법_v1.1_위반_데이터_처리_SQL_단계별.sql` (각 쿼리를 개별 실행)
- **대안**: `docs/헌법_v1.1_위반_데이터_처리_SQL_한번에.sql` (모든 UPDATE를 한 번에 실행)

**⚠️ 주의사항**:
- **1단계에서 확인한 위반 데이터를 먼저 처리해야 합니다**
- 가격이 없는 자재는 비활성화 처리합니다
- 나중에 가격을 추가하면 다시 활성화할 수 있습니다
- **오류 발생 시**: 단계별 파일을 사용하여 각 쿼리를 개별 실행하세요

**실행 방법 (단계별 파일 사용 - 권장)**:
1. Supabase Dashboard → SQL Editor 열기
2. `헌법_v1.1_위반_데이터_처리_SQL_단계별.sql` 파일 열기
3. **STEP 1** 쿼리만 복사하여 실행
4. **STEP 1 확인** 쿼리 실행하여 결과 확인
5. **STEP 2** 쿼리 실행
6. **STEP 2 확인** 쿼리 실행하여 결과 확인
7. **STEP 3** 쿼리 실행
8. **STEP 3 확인** 쿼리 실행하여 결과 확인
9. **STEP 4 (최종 확인)** 쿼리 실행 - 모든 violation_count가 0인지 확인

**실행 방법 (한 번에 실행 파일 사용)**:
1. Supabase Dashboard → SQL Editor 열기
2. `헌법_v1.1_위반_데이터_처리_SQL_한번에.sql` 파일 내용 복사
3. SQL Editor에 붙여넣기
4. Run 버튼 클릭
5. 최종 확인 쿼리 결과가 모두 0건인지 확인

**처리 내용**:
- 가격이 없는 활성화된 자재 → `is_active = false`로 변경
- unit이 없는 활성화된 자재 → `is_active = false`로 변경
- 아르젠 기준이 아닌 활성화된 자재 → `is_active = false`로 변경

**예상 결과**:
- 위반 데이터가 모두 비활성화됨
- 최종 확인 쿼리에서 모든 violation_count가 0

---

### 1.6단계: 제약조건 위반 데이터 재확인 (필수)

**파일**: `docs/헌법_v1.1_제약조건_위반_재확인_SQL.sql`

**⚠️ 중요**: 제약조건 적용 전에 반드시 재확인하세요

**실행 방법**:
1. Supabase Dashboard → SQL Editor 열기
2. `헌법_v1.1_제약조건_위반_재확인_SQL.sql` 파일 내용 복사
3. SQL Editor에 붙여넣기
4. Run 버튼 클릭
5. **활성화된 자재** 중 위반 데이터가 있는지 확인

**확인 사항**:
- 활성화된 자재(`is_active = true`) 중 가격 없는 자재
- 활성화된 자재 중 unit 없는 자재
- 활성화된 자재 중 아르젠 기준이 아닌 자재
- 활성화된 노무 중 생산성 정보 불완전한 경우

**예상 결과**:
- 모든 violation_count가 0이어야 제약조건 적용 가능
- 위반 데이터가 있으면 다시 1.5단계 실행 필요

---

### 2단계: DB CHECK 제약조건 적용 (위반 데이터 재확인 후)

**파일 선택**:
- **권장**: `docs/헌법_v1.1_제약조건_삭제_및_재적용_SQL.sql` (기존 제약조건 삭제 후 수정본 재적용)
- **대안**: `docs/헌법_v1.1_제약조건_적용_수정본.sql` (새로 적용하는 경우)

**⚠️ 중요**: 
- 기존 제약조건이 이미 존재하는 경우 → `헌법_v1.1_제약조건_삭제_및_재적용_SQL.sql` 사용
- 제약조건이 없는 경우 → `헌법_v1.1_제약조건_적용_수정본.sql` 사용

**⚠️ 주의사항**:
- **1.6단계를 먼저 실행하여 활성화된 데이터 중 위반 데이터를 확인하세요**
- 위반 데이터가 있는 상태에서 제약조건을 적용하면 실패합니다
- **수정본 파일 사용**: `헌법_v1.1_제약조건_적용_수정본.sql`은 활성화된 데이터만 체크하도록 수정되었습니다
- **오류 발생 시**: 1.6단계를 다시 실행하여 위반 데이터를 확인하고, 필요시 1.5단계를 다시 실행하세요

**실행 방법 (기존 제약조건이 있는 경우 - 권장)**:
1. Supabase Dashboard → SQL Editor 열기
2. `헌법_v1.1_제약조건_삭제_및_재적용_SQL.sql` 파일 내용 전체 복사
3. SQL Editor에 붙여넣기
4. Run 버튼 클릭
5. 제약조건 확인 쿼리 결과 확인 (파일 내 포함)

**실행 방법 (제약조건이 없는 경우)**:
1. Supabase Dashboard → SQL Editor 열기
2. `헌법_v1.1_제약조건_적용_수정본.sql` 파일 내용 전체 복사
3. SQL Editor에 붙여넣기
4. Run 버튼 클릭
5. 제약조건 확인 쿼리 실행하여 적용 확인

**확인 방법**:
- 제약조건 확인 쿼리 실행 (파일 내 포함)
- 각 테이블별 제약조건이 정상적으로 적용되었는지 확인

**예상 결과**:
- 각 테이블에 제약조건이 정상적으로 추가됨
- 제약조건 확인 쿼리에서 제약조건 목록 표시

---

### 3단계: 실제 테스트 (필수)

**테스트 시나리오**:
1. 개발 서버 실행 (`npm run dev`)
2. 브라우저에서 견적 페이지 열기
3. 평수 25, 주방 공간 선택
4. finish/electric/kitchen 공정 선택
5. 견적 계산 버튼 클릭

**확인 사항**:

#### ✅ 정상 케이스
- 견적이 정상적으로 생성됨
- 0원 항목이 없음
- 모든 자재/노무 정보가 정상적으로 표시됨

#### ❌ 에러 케이스 (자재/노무 정보 없음)
- 에러 발생 시 브라우저 콘솔 확인
- 네트워크 탭에서 API 응답 확인
- 예상 응답:
  ```json
  {
    "status": "ESTIMATE_FAILED",
    "failedAt": "MATERIAL_OR_LABOR_VALIDATION",
    "reason": "견적에 필요한 필수 단가/노무 정보가 DB에 존재하지 않습니다."
  }
  ```

**서버 로그 확인**:
- 터미널에서 상세한 에러 메시지 확인
- `❌ 헌법 v1.1 검증 실패:` 로그 확인
- 내부 로그는 상세하게 표시됨 (디버깅 용이)

---

## 🔍 검증 체크리스트

### 코드 레벨 검증
- [x] `material-service-strict.ts` 생성 완료
- [x] `labor-service-strict.ts` 생성 완료
- [x] `constitution-v1-engine.ts`에서 헌법 v1.1 전용 서비스 사용
- [x] API 라우트에서 에러 메시지 통일
- [x] 기존 함수 deprecated 표시

### DB 레벨 검증
- [x] 제약조건 위반 데이터 확인 완료
- [ ] 위반 데이터 처리 완료 (비활성화)
- [ ] 최종 확인 쿼리 결과 모두 0건 확인 완료
- [ ] DB CHECK 제약조건 적용 완료
- [ ] 제약조건 확인 쿼리 실행 완료

### 테스트 검증
- [ ] 정상 케이스 테스트 완료
- [ ] 에러 케이스 테스트 완료
- [ ] 통일된 에러 메시지 확인 완료
- [ ] 내부 로그 상세 메시지 확인 완료

---

## 📝 문제 해결 가이드

### 제약조건 적용 실패 시

**원인**: 기존 데이터에 제약조건 위반이 있음

**해결 방법**:
1. `헌법_v1.1_제약조건_위반_데이터_확인_SQL.sql` 실행
2. 위반 데이터 확인
3. 위반 데이터 수정 (예: 가격 추가, unit 추가 등)
4. 다시 제약조건 적용 시도

### 견적 계산 실패 시

**원인**: 자재/노무 정보가 DB에 없음

**해결 방법**:
1. 서버 로그에서 상세한 에러 메시지 확인
2. 에러 메시지에 표시된 자재/노무 정보 확인
3. Supabase에서 해당 자재/노무 정보 추가 또는 수정
4. 다시 견적 계산 시도

### 에러 메시지가 통일되지 않을 때

**원인**: API 라우트에서 에러 메시지 통일 로직이 작동하지 않음

**해결 방법**:
1. `app/api/estimate/constitution/route.ts` 확인
2. `isMaterialOrLaborError` 로직 확인
3. `error.reason`에 '필수 단가/노무 정보' 문자열 포함 여부 확인

---

## 🎯 완료 기준

### 필수 완료 항목
- [x] 코드 레벨 작업 완료
- [ ] DB 제약조건 위반 데이터 확인 완료
- [ ] DB 제약조건 적용 완료
- [ ] 실제 테스트 완료

### 선택 완료 항목
- [x] 기존 함수 deprecated 표시 완료

---

## 📌 참고 사항

### 제약조건 적용 전 필수 확인
- 제약조건 위반 데이터가 있으면 제약조건 적용이 실패합니다
- 반드시 위반 데이터를 먼저 확인하고 수정하세요

### 테스트 시 주의사항
- 정상 케이스와 에러 케이스 모두 테스트하세요
- 브라우저 콘솔과 서버 로그를 모두 확인하세요
- 네트워크 탭에서 API 응답 구조를 확인하세요

### 에러 메시지 구조
- **외부 응답**: 통일된 메시지 ("견적에 필요한 필수 단가/노무 정보가 DB에 존재하지 않습니다.")
- **내부 로그**: 상세한 메시지 (디버깅 용이)
- **failedAt**: 자재/노무 관련은 'MATERIAL_OR_LABOR_VALIDATION', 기타는 'ENGINE_VALIDATION'

---

**작성일**: 2025년 12월  
**작성자**: AI Assistant (Cursor)  
**상태**: ✅ 코드 작업 완료, DB 제약조건 적용 및 테스트 대기 중











