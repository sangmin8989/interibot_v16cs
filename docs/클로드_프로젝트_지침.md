# 인테리봇 견적 디버깅 프로젝트 지침

## 프로젝트 개요

**프로젝트명**: 인테리봇 견적 디버깅  
**목적**: 견적 시스템의 에러 제거 및 안정화  
**기술 스택**: Next.js 14, TypeScript, Supabase, Zustand

---

## 핵심 원칙

### 1. 안전성 우선 (Safety First)
- **모든 견적 결과 접근은 옵셔널 체이닝(`?.`) 필수**
- `undefined` 값이 UI로 전달되지 않도록 항상 기본값 제공
- 에러를 throw하지 않고 안전한 기본값 반환

### 2. 비동기 처리 명확화
- `async` 함수는 반드시 `await`로 호출
- Promise 체이닝 대신 `async/await` 사용
- 에러 처리는 `try-catch`로 명확히 구분

### 3. 타입 안전성
- TypeScript strict 모드 준수
- 모든 함수의 반환 타입 명시
- `undefined` 가능성은 타입에 명시

### 4. 점진적 개선
- 기존 코드를 한 번에 대규모 수정하지 않음
- 최소한의 변경으로 문제 해결
- 수정 후 즉시 테스트

---

## 작업 규칙

### 코드 작성 규칙

1. **안전 체크 필수**
   ```typescript
   // ❌ 금지
   estimate.summary.grandTotal
   
   // ✅ 필수
   estimate?.summary?.grandTotal || 0
   ```

2. **비동기 함수 호출**
   ```typescript
   // ❌ 금지
   const result = calculateFullEstimateV3(input)
   
   // ✅ 필수
   const result = await calculateFullEstimateV3(input)
   ```

3. **에러 처리**
   ```typescript
   // ✅ 필수 패턴
   try {
     const result = await calculateEstimate(input)
     return adaptEstimateResult(result)
   } catch (error) {
     console.error('견적 계산 실패:', error)
     return adaptEstimateResult(null) // 안전한 기본값
   }
   ```

### 파일 수정 규칙

1. **부분 수정만 허용**
   - 전체 파일 덮어쓰기 금지
   - 필요한 부분만 수정
   - 기존 로직 보존

2. **한 번에 수정할 파일 수 제한**
   - 3개 이상 수정 시 빌드 체크 필수
   - 10개 이상 동시 수정 금지

3. **보호 파일 수정 금지**
   - `types/process-options.ts`
   - `constants/process-definitions.ts`
   - `lib/store/processStore.ts`

### 테스트 규칙

1. **수정 후 즉시 테스트**
   - 브라우저에서 직접 확인
   - 콘솔 에러 확인
   - 견적 계산 정상 작동 확인

2. **빌드 체크**
   - 파일 3개 이상 수정 시 `npm run build` 실행
   - 빌드 에러 발생 시 즉시 수정
   - 타입 에러 무시 금지

---

## 시스템 아키텍처 이해

### 견적 엔진 구조

**현재 상태**: 두 개의 견적 시스템 혼재
1. **V3 계산기** (`lib/estimate/calculator-v3.ts`)
   - 4등급 시스템 (BASIC, STANDARD, ARGEN, PREMIUM)
   - 파일 기반 가격 데이터
   - `calculateFullEstimateV3` 함수 (async)

2. **헌법 v1 엔진** (`lib/estimate/constitution-v1-engine.ts`)
   - 단일 아르젠 기준
   - Supabase DB 기반
   - `generateEstimate` 함수

### 데이터 흐름

```
사용자 입력 (Store)
  ↓
견적 계산 함수 (V3 또는 헌법 v1)
  ↓
어댑터 레이어 (estimate-result-adapter.ts) ← 권장
  ↓
UI 렌더링
```

### 주요 파일 위치

- **견적 페이지**: `app/onboarding/estimate/page.tsx`
- **V3 계산기**: `lib/estimate/calculator-v3.ts`
- **헌법 v1 엔진**: `lib/estimate/constitution-v1-engine.ts`
- **어댑터**: `lib/adapters/estimate-result-adapter.ts`
- **타입 정의**: `lib/types/헌법_견적_타입.ts`

---

## 에러 처리 표준

### 견적 계산 에러

```typescript
// 표준 패턴
async function safeCalculateEstimate(input: EstimateInputV3) {
  try {
    const result = await calculateFullEstimateV3(input)
    
    // 어댑터를 통한 안전한 변환 (권장)
    return adaptEstimateResult(result)
    
    // 또는 직접 안전 체크
    return {
      grandTotal: result?.summary?.grandTotal || 0,
      materialTotal: result?.summary?.materialTotal || 0,
      laborTotal: result?.summary?.laborTotal || 0,
      breakdown: result?.summary?.breakdown || []
    }
  } catch (error) {
    console.error('견적 계산 실패:', error)
    // 에러 발생 시 안전한 기본값 반환
    return adaptEstimateResult(null)
  }
}
```

### UI 렌더링 에러 방지

```typescript
// ✅ 안전한 렌더링
{formatWon(estimate?.summary?.grandTotal || 0)}

// ❌ 위험한 코드
{formatWon(estimate.summary.grandTotal)}
```

---

## 디버깅 가이드

### 에러 발생 시 확인 사항

1. **비동기 처리 확인**
   - `async` 함수에 `await` 사용했는지
   - Promise가 아닌 실제 값인지

2. **타입 확인**
   - `summary`가 `undefined`인지
   - 옵셔널 체이닝 사용했는지

3. **데이터 흐름 추적**
   - Store에서 올바른 값이 전달되는지
   - 계산 함수가 정상 반환하는지
   - 어댑터가 올바르게 변환하는지

### 로깅 규칙

```typescript
// ✅ 구조화된 로깅
console.log('✅ 견적 계산 완료:', {
  평수: py,
  총액: formatWon(result?.grandTotal || 0),
  자재비: formatWon(result?.materialTotal || 0),
  노무비: formatWon(result?.laborTotal || 0)
})

// ❌ 비구조화된 로깅
console.log(result)
```

---

## 작업 우선순위

### 즉시 수정 (Critical)
1. ✅ 비동기 함수에 `await` 추가
2. ✅ 모든 `summary.grandTotal` 접근에 안전 체크
3. ✅ UI 렌더링 부분 옵셔널 체이닝 적용

### 단기 개선 (High Priority)
1. 어댑터 레이어 실제 적용
2. 에러 바운더리 추가
3. 구조화된 에러 로깅

### 중기 개선 (Medium Priority)
1. 견적 엔진 통합 또는 명확한 분리
2. 타입 안전성 강화
3. 테스트 코드 작성

---

## 금지 사항

1. **전체 파일 덮어쓰기 금지**
2. **보호 파일 수정 금지**
3. **안전 체크 없이 객체 속성 접근 금지**
4. **비동기 함수를 동기적으로 호출 금지**
5. **에러를 throw하지 않고 안전한 기본값 반환**

---

## 참고 문서

- 전체 구조 분석: `docs/인테리봇_전체_구조_분석.md`
- 에러 수정 보고서: `docs/에러_수정_완료_보고서.md`
- 헌법 v1 타입: `lib/types/헌법_견적_타입.ts`

---

**마지막 업데이트**: 2025-12-17



