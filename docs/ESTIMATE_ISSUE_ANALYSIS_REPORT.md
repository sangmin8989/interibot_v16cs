# 견적 처리 문제 분석 보고서

## 📋 분석 개요

**분석 일시**: 2025-01-XX  
**분석 대상**: 견적 계산 시스템 (calculator-v3.ts, estimate/page.tsx)  
**문제**: 견적이 정확하게 처리되지 않음

---

## 🔍 발견된 문제점

### 1. 입력 데이터 검증 부족 ⚠️ **중요**

#### 문제
- 평수(py)가 0 이하일 때 기본값(34평) 사용하지만, 경고만 출력
- 등급(grade) 검증은 API 레벨에서만 수행
- 공간/공정 선택 데이터 누락 시 처리 로직이 복잡함

#### 위치
- `app/onboarding/estimate/page.tsx:426-444` (평수 결정 로직)
- `app/api/estimate/v3/route.ts:25-45` (입력 검증)

#### 영향
- 잘못된 입력으로 인한 부정확한 견적 계산
- 사용자에게 명확한 피드백 부족

---

### 2. 공간/공정 선택 데이터 누락 처리 ⚠️ **중요**

#### 문제
- `selectedSpaces`, `enabledProcessIds`, `processSelections`가 모두 없을 때
- "전체 시공 기준"으로 계산하지만, 사용자에게 명확히 알리지 않음
- UI에 경고는 있지만, 계산 로직에서 일관성 부족

#### 위치
- `app/onboarding/estimate/page.tsx:824-840` (데이터 없음 경고)
- `lib/estimate/calculator-v3.ts:425-610` (공정 추출 로직)

#### 영향
- 사용자가 선택하지 않았는데도 전체 공정으로 계산되어 금액이 과다하게 표시될 수 있음

---

### 3. 계산 로직 복잡성으로 인한 오류 가능성 ⚠️ **중요**

#### 문제
- 공간별/공정별 조건 분기가 많아서 일부 케이스 누락 가능
- 안방만 선택, 2개 욕실 선택 등 특수 케이스 처리 로직이 복잡
- `hasAllProcesses`, `onlyMasterBedroomSelected` 등 플래그가 많아서 관리 어려움

#### 위치
- `lib/estimate/calculator-v3.ts:1556-1700` (합계 계산 로직)
- `lib/estimate/calculator-v3.ts:425-610` (공정 추출 로직)

#### 영향
- 특정 조합에서 금액이 잘못 계산될 수 있음
- 디버깅이 어려움

---

### 4. 에러 처리 부족 ⚠️ **보통**

#### 문제
- API 호출 실패 시 에러 메시지가 사용자에게 명확히 전달되지 않음
- 계산 중 예외 발생 시 부분적 실패 처리 없음

#### 위치
- `app/onboarding/estimate/page.tsx:684-687` (에러 체크)
- `app/api/estimate/v3/route.ts:63-77` (에러 처리)

#### 영향
- 사용자가 왜 견적이 안 나오는지 알기 어려움

---

### 5. 데이터 일관성 문제 ⚠️ **보통**

#### 문제
- `spaceInfo.pyeong`과 `calculatedPy`가 다를 수 있음
- `bathroomCount` 계산 로직이 여러 곳에 분산
- `processSelections`와 `enabledProcessIds`의 관계가 명확하지 않음

#### 위치
- `app/onboarding/estimate/page.tsx:426-472` (평수/욕실 개수 결정)
- `lib/estimate/calculator-v3.ts:403-416` (입력 파싱)

#### 영향
- 같은 입력에 대해 다른 결과가 나올 수 있음

---

## 🎯 우선순위별 수정 계획

### Priority 1: 입력 데이터 검증 강화 (즉시 수정)

**목표**: 잘못된 입력을 사전에 차단하고 명확한 피드백 제공

**수정 사항**:
1. 평수 검증 강화 (0 이하 시 에러, 기본값 사용 금지)
2. 공간/공정 선택 여부 명확히 확인
3. 사용자에게 선택 누락 시 경고 표시

---

### Priority 2: 공간/공정 선택 데이터 누락 처리 개선 (즉시 수정)

**목표**: 선택 데이터가 없을 때 명확한 처리

**수정 사항**:
1. 선택 데이터 없을 때 "전체 시공" 모드 명시
2. 사용자에게 확인 메시지 표시
3. 계산 로직에서 일관성 유지

---

### Priority 3: 계산 로직 단순화 및 검증 (중기 수정)

**목표**: 복잡한 조건 분기를 단순화하고 검증 로직 추가

**수정 사항**:
1. 공정 추출 로직 단순화
2. 합계 계산 로직 검증 추가
3. 단위 테스트 작성

---

### Priority 4: 에러 처리 개선 (중기 수정)

**목표**: 사용자에게 명확한 에러 메시지 제공

**수정 사항**:
1. API 에러 메시지 개선
2. 부분 실패 처리
3. 재시도 로직 추가

---

## 📊 영향도 분석

| 문제 | 심각도 | 영향 범위 | 수정 난이도 | 우선순위 |
|------|--------|----------|------------|----------|
| 입력 데이터 검증 부족 | 높음 | 전체 사용자 | 낮음 | 1 |
| 공간/공정 선택 누락 처리 | 높음 | 전체 사용자 | 중간 | 2 |
| 계산 로직 복잡성 | 중간 | 특정 케이스 | 높음 | 3 |
| 에러 처리 부족 | 중간 | 에러 발생 시 | 중간 | 4 |
| 데이터 일관성 | 낮음 | 일부 케이스 | 중간 | 5 |

---

## 🔧 즉시 수정 항목 (Priority 1, 2)

### 1. 입력 데이터 검증 강화

**파일**: `app/onboarding/estimate/page.tsx`

**수정 내용**:
- 평수 검증: 0 이하 시 에러 표시, 기본값 사용 금지
- 공간/공정 선택 여부 확인 강화
- 사용자 피드백 개선

### 2. 공간/공정 선택 데이터 누락 처리

**파일**: `app/onboarding/estimate/page.tsx`, `lib/estimate/calculator-v3.ts`

**수정 내용**:
- 선택 데이터 없을 때 명확한 모드 설정
- 사용자 확인 메시지 추가
- 계산 로직 일관성 유지

---

## 📝 다음 단계

1. ✅ **즉시 수정**: Priority 1, 2 항목 수정
2. ⏳ **중기 수정**: Priority 3, 4 항목 수정
3. 📊 **검증**: 수정 후 테스트 시나리오 실행
4. 📈 **모니터링**: 실제 사용 데이터 수집 및 분석

---

## 🎯 완료 기준

- [ ] 평수 검증이 강화되어 잘못된 입력 차단
- [ ] 공간/공정 선택 누락 시 명확한 처리
- [ ] 사용자에게 명확한 피드백 제공
- [ ] 계산 결과가 일관성 있게 나옴
- [ ] 에러 발생 시 명확한 메시지 표시












