# ì¸í…Œë¦¬ë´‡ ê²¬ì  ì—ëŸ¬ ë¬¸ì œì  ë¶„ì„

**ì‘ì„±ì¼**: 2025-12-17  
**í”„ë¡œì íŠ¸**: ì¸í…Œë¦¬ë´‡ ê²¬ì  ë””ë²„ê¹…

---

## ğŸ”´ í˜„ì¬ ë°œìƒ ì¤‘ì¸ ì—ëŸ¬

### ì—ëŸ¬ 1: TypeError - grandTotal ì ‘ê·¼ ì‹¤íŒ¨

**ì—ëŸ¬ ë©”ì‹œì§€**:
```
TypeError: Cannot read properties of undefined (reading 'grandTotal')
```

**ë°œìƒ ìœ„ì¹˜**:
- `app/onboarding/estimate/page.tsx:660`
- `app/onboarding/estimate/page.tsx:1145` (UI ë Œë”ë§)
- `app/onboarding/estimate/page.tsx:1234` (UI ë Œë”ë§)

**ì—ëŸ¬ ë°œìƒ ì½”ë“œ**:
```typescript
// âŒ ë¬¸ì œ ì½”ë“œ (660ë²ˆ ì¤„)
console.log('âœ… V3 ê²¬ì  ê²°ê³¼:', {
  í‰ìˆ˜: py,
  basic: formatWon(basicEstimate.summary.grandTotal),  // summaryê°€ undefined
  standard: formatWon(standardEstimate.summary.grandTotal),
  argen: formatWon(argenEstimate.summary.grandTotal),
  premium: formatWon(premiumEstimate.summary.grandTotal),
})

// âŒ ë¬¸ì œ ì½”ë“œ (1145ë²ˆ ì¤„ - UI)
{formatPrice(estimate.summary.grandTotal)}

// âŒ ë¬¸ì œ ì½”ë“œ (1234ë²ˆ ì¤„ - UI)
{formatWon(currentEstimate.summary.grandTotal)}
```

---

## ğŸ” ê·¼ë³¸ ì›ì¸ ë¶„ì„

### ì›ì¸ 1: ë¹„ë™ê¸° í•¨ìˆ˜ë¥¼ ë™ê¸°ì ìœ¼ë¡œ í˜¸ì¶œ âš ï¸ **ê°€ì¥ ì‹¬ê°**

**ë¬¸ì œ**:
- `calculateFullEstimateV3`ëŠ” `async` í•¨ìˆ˜ì¸ë° `await` ì—†ì´ í˜¸ì¶œë¨
- Promise ê°ì²´ê°€ ë°˜í™˜ë˜ì–´ `summary` ì†ì„±ì´ ì—†ìŒ

**ì½”ë“œ ìœ„ì¹˜**: `app/onboarding/estimate/page.tsx:637-652`

```typescript
// âŒ í˜„ì¬ ì½”ë“œ (ì—ëŸ¬ ë°œìƒ)
const basicEstimate = calculateFullEstimateV3({ ...baseInput, grade: 'BASIC' })
const standardEstimate = calculateFullEstimateV3({ ...baseInput, grade: 'STANDARD' })
const argenEstimate = calculateFullEstimateV3({ ...baseInput, grade: 'ARGEN' })
const premiumEstimate = calculateFullEstimateV3({ ...baseInput, grade: 'PREMIUM' })

// ê²°ê³¼: basicEstimateëŠ” Promise ê°ì²´
// basicEstimate.summary â†’ undefined (Promiseì—ëŠ” summary ì†ì„±ì´ ì—†ìŒ)
```

**í•¨ìˆ˜ ì •ì˜ í™•ì¸**:
```typescript
// lib/estimate/calculator-v3.ts:390
export async function calculateFullEstimateV3(input: EstimateInputV3): Promise<FullEstimateV3> {
  // ... ë¹„ë™ê¸° ë¡œì§
  return {
    summary: {
      grandTotal: ...,
      // ...
    }
  }
}
```

### ì›ì¸ 2: ì•ˆì „ ì²´í¬ ë¶€ì¬

**ë¬¸ì œ**:
- `summary`ê°€ `undefined`ì¼ ìˆ˜ ìˆëŠ”ë° ì˜µì…”ë„ ì²´ì´ë‹(`?.`) ë¯¸ì‚¬ìš©
- ê¸°ë³¸ê°’(`|| 0`) ì œê³µ ì—†ìŒ

**ì˜í–¥**:
- ê³„ì‚° ì‹¤íŒ¨ ì‹œ UI í¬ë˜ì‹œ
- ì‚¬ìš©ì ê²½í—˜ ì €í•˜

### ì›ì¸ 3: íƒ€ì… ì •ì˜ì™€ ì‹¤ì œ êµ¬í˜„ ë¶ˆì¼ì¹˜

**ë¬¸ì œ**:
- íƒ€ì… ì •ì˜ì—ëŠ” `summary`ê°€ í•„ìˆ˜ë¡œ ì •ì˜ë˜ì–´ ìˆìŒ
- ì‹¤ì œë¡œëŠ” ê³„ì‚° ì‹¤íŒ¨ ì‹œ `summary`ê°€ ì—†ì„ ìˆ˜ ìˆìŒ

```typescript
// íƒ€ì… ì •ì˜ (lib/estimate/calculator-v3.ts:244)
export interface FullEstimateV3 {
  summary: {  // í•„ìˆ˜ë¡œ ì •ì˜ë¨
    grandTotal: number;
    materialTotal: number;
    // ...
  };
}

// ì‹¤ì œ ë™ì‘: ê³„ì‚° ì‹¤íŒ¨ ì‹œ summaryê°€ ì—†ì„ ìˆ˜ ìˆìŒ
```

### ì›ì¸ 4: ì—ëŸ¬ ì²˜ë¦¬ ë¶€ì¬

**ë¬¸ì œ**:
- ê³„ì‚° ì‹¤íŒ¨ ì‹œ `undefined` ë°˜í™˜
- UIì—ì„œ `undefined.summary.grandTotal` ì ‘ê·¼ ì‹œ í¬ë˜ì‹œ
- ì‚¬ìš©ìì—ê²Œ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì œê³µ ì•ˆ ë¨

---

## ğŸ“Š ì‹œìŠ¤í…œ êµ¬ì¡°ìƒ ë¬¸ì œì 

### ë¬¸ì œ 1: ê²¬ì  ì—”ì§„ ì´ì¤‘í™”

**í˜„ì¬ ìƒíƒœ**: ë‘ ê°œì˜ ê²¬ì  ì‹œìŠ¤í…œì´ í˜¼ì¬

1. **V3 ê³„ì‚°ê¸°** (`lib/estimate/calculator-v3.ts`)
   - 4ë“±ê¸‰ ì‹œìŠ¤í…œ (BASIC, STANDARD, ARGEN, PREMIUM)
   - íŒŒì¼ ê¸°ë°˜ ê°€ê²© ë°ì´í„°
   - `calculateFullEstimateV3` í•¨ìˆ˜ (async)
   - **í˜„ì¬ ì—ëŸ¬ ë°œìƒ ì§€ì **

2. **í—Œë²• v1 ì—”ì§„** (`lib/estimate/constitution-v1-engine.ts`)
   - ë‹¨ì¼ ì•„ë¥´ì   ê¸°ì¤€
   - Supabase DB ê¸°ë°˜
   - `generateEstimate` í•¨ìˆ˜

**ì˜í–¥**:
- ì½”ë“œ ì¤‘ë³µ ë° ìœ ì§€ë³´ìˆ˜ ì–´ë ¤ì›€
- ì¼ê´€ì„± ì—†ëŠ” ë°ì´í„° ì†ŒìŠ¤
- UIì—ì„œ ë‘ ì‹œìŠ¤í…œì„ í˜¼ìš©í•˜ì—¬ ì‚¬ìš©

### ë¬¸ì œ 2: ë°ì´í„° íë¦„ ë¶ˆëª…í™•

```
ì‚¬ìš©ì ì…ë ¥ (Store)
  â†“
ê²¬ì  ê³„ì‚° í•¨ìˆ˜ (V3 ë˜ëŠ” í—Œë²• v1) â† ì–´ëŠ ê²ƒì„ ì‚¬ìš©í• ì§€ ë¶ˆëª…í™•
  â†“
ì–´ëŒ‘í„° ë ˆì´ì–´ (ìƒì„±ëì§€ë§Œ ë¯¸ì‚¬ìš©) â† ì•ˆì „ ë³€í™˜ ê¸°íšŒ ë†“ì¹¨
  â†“
UI ë Œë”ë§ â† ì—ëŸ¬ ë°œìƒ ì§€ì 
```

### ë¬¸ì œ 3: ìƒíƒœ ê´€ë¦¬ ë³µì¡ì„±

**ì—¬ëŸ¬ Storeê°€ ë³µì¡í•˜ê²Œ ìƒí˜¸ì‘ìš©**:
- `spaceInfoStore`: í‰ìˆ˜, ë°© ê°œìˆ˜ ë“±
- `processStore`: ê³µì • ì„ íƒ
- `scopeStore`: ê³µê°„ ì„ íƒ

**ë¬¸ì œ**:
- Store ê°„ ë™ê¸°í™” ë¬¸ì œ ê°€ëŠ¥
- `selectedSpaces: undefined` ê°™ì€ ìƒíƒœ ë°œìƒ ê°€ëŠ¥

---

## ğŸ¯ í•´ê²° ë°©ì•ˆ

### ì¦‰ì‹œ ìˆ˜ì • í•„ìš” (Critical)

#### ìˆ˜ì • 1: await ì¶”ê°€

```typescript
// âœ… ìˆ˜ì • í›„
const basicEstimate = await calculateFullEstimateV3({ ...baseInput, grade: 'BASIC' })
const standardEstimate = await calculateFullEstimateV3({ ...baseInput, grade: 'STANDARD' })
const argenEstimate = await calculateFullEstimateV3({ ...baseInput, grade: 'ARGEN' })
const premiumEstimate = await calculateFullEstimateV3({ ...baseInput, grade: 'PREMIUM' })
```

#### ìˆ˜ì • 2: ì•ˆì „ ì²´í¬ ì¶”ê°€

```typescript
// âœ… ìˆ˜ì • í›„
console.log('âœ… V3 ê²¬ì  ê²°ê³¼:', {
  í‰ìˆ˜: py,
  basic: formatWon(basicEstimate?.summary?.grandTotal || 0),
  standard: formatWon(standardEstimate?.summary?.grandTotal || 0),
  argen: formatWon(argenEstimate?.summary?.grandTotal || 0),
  premium: formatWon(premiumEstimate?.summary?.grandTotal || 0),
})

// âœ… UI ë Œë”ë§ ìˆ˜ì •
{formatPrice(estimate?.summary?.grandTotal || 0)}
{formatWon(currentEstimate?.summary?.grandTotal || 0)}
```

#### ìˆ˜ì • 3: ì—ëŸ¬ ì²˜ë¦¬ ì¶”ê°€

```typescript
try {
  const basicEstimate = await calculateFullEstimateV3({ ...baseInput, grade: 'BASIC' })
  // ... ë‚˜ë¨¸ì§€ ê³„ì‚°
} catch (error) {
  console.error('âŒ ê²¬ì  ê³„ì‚° ì—ëŸ¬:', error)
  setError('ê²¬ì  ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.')
  // ì•ˆì „í•œ ê¸°ë³¸ê°’ ì„¤ì •
  setEstimates({
    basic: { summary: { grandTotal: 0, materialTotal: 0, laborTotal: 0 } },
    // ...
  })
}
```

### ì¤‘ê¸° ê°œì„  (High Priority)

#### ê°œì„  1: ì–´ëŒ‘í„° ë ˆì´ì–´ ì ìš©

```typescript
import { adaptEstimateResult } from '@/lib/adapters/estimate-result-adapter'

// ê³„ì‚° í›„
const adaptedBasic = adaptEstimateResult(basicEstimate)
const adaptedStandard = adaptEstimateResult(standardEstimate)

// ì‚¬ìš© ì‹œ (ì•ˆì „í•¨ì´ ë³´ì¥ë¨)
console.log('âœ… V3 ê²¬ì  ê²°ê³¼:', {
  basic: formatWon(adaptedBasic.grandTotal),  // í•­ìƒ ìˆ«ì
  // ...
})
```

#### ê°œì„  2: ì—ëŸ¬ ë°”ìš´ë”ë¦¬ ì¶”ê°€

```typescript
// React Error Boundaryë¡œ UI í¬ë˜ì‹œ ë°©ì§€
<ErrorBoundary fallback={<ErrorFallback />}>
  <EstimatePage />
</ErrorBoundary>
```

---

## ğŸ“ ì¬í˜„ ë°©ë²•

1. ë¸Œë¼ìš°ì €ì—ì„œ `http://localhost:3001/onboarding/estimate` ì ‘ì†
2. ê³µê°„ ì„ íƒ (ì˜ˆ: ì£¼ë°©)
3. ê³µì • ì„ íƒ (ì˜ˆ: ì£¼ë°© ì½”ì–´, ì¡°ëª…/ì „ê¸°)
4. ê²¬ì  ê³„ì‚° ë²„íŠ¼ í´ë¦­
5. **ì—ëŸ¬ ë°œìƒ**: ì½˜ì†”ì— `TypeError: Cannot read properties of undefined (reading 'grandTotal')` í‘œì‹œ

---

## ğŸ”— ê´€ë ¨ íŒŒì¼

- **ì—ëŸ¬ ë°œìƒ íŒŒì¼**: `app/onboarding/estimate/page.tsx`
- **V3 ê³„ì‚°ê¸°**: `lib/estimate/calculator-v3.ts`
- **í—Œë²• v1 ì—”ì§„**: `lib/estimate/constitution-v1-engine.ts`
- **ì–´ëŒ‘í„°**: `lib/adapters/estimate-result-adapter.ts` (ìƒì„±ë¨, ë¯¸ì‚¬ìš©)
- **íƒ€ì… ì •ì˜**: `lib/types/í—Œë²•_ê²¬ì _íƒ€ì….ts`

---

## âœ… ìˆ˜ì • ìƒíƒœ

- âœ… await ì¶”ê°€ ì™„ë£Œ
- âœ… ì•ˆì „ ì²´í¬ ì¶”ê°€ ì™„ë£Œ
- âš ï¸ ì–´ëŒ‘í„° ì ìš© (ì„ íƒì‚¬í•­)
- âš ï¸ ì—ëŸ¬ ë°”ìš´ë”ë¦¬ ì¶”ê°€ (ë¯¸ì™„ë£Œ)

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-12-17



