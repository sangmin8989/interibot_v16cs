# ê²¬ì  ì‹¤íŒ¨ ì¡°ê±´ ê°•í™” ìµœì¢… ë¶„ì„ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2024ë…„ 12ì›”  
**ë¶„ì„ ëŒ€ìƒ**: 
1. `createSingleProcessBlock` ì‹¤íŒ¨ ì±…ì„ ì¬ì •ì˜ ëª…ì„¸
2. `checkFailures` ì—­í•  ì¶•ì†Œ ë° ìµœì¢… ë°©ì–´ì„  ëª…ì„¸

**ëª©ì **: ê³µì • ë‹¨ìœ„ ê²€ì¦ê³¼ êµ¬ì¡° ë‹¨ìœ„ ê²€ì¦ì˜ ì±…ì„ ë¶„ë¦¬ ë° êµ¬í˜„ ë°©ì•ˆ ì œì‹œ

---

## ğŸ“‹ ê°œìš”

ê²¬ì  ì‹¤íŒ¨ ì¡°ê±´ ê°•í™”ëŠ” **ë‘ ë‹¨ê³„ ê²€ì¦**ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:

1. **1ì°¨ ê´€ë¬¸**: `createSingleProcessBlock` - ê³µì • í•˜ë‚˜ì˜ ìœ íš¨ì„± í™•ì •
2. **ìµœì¢… ë°©ì–´ì„ **: `checkFailures` - êµ¬ì¡°ì  ì‹¤íŒ¨ë§Œ íŒë‹¨

**í•µì‹¬ ì›ì¹™**:
- ê³µì • ë‹¨ìœ„ ì˜¤ë¥˜ â†’ `createSingleProcessBlock`ì—ì„œ ì¦‰ì‹œ ì‹¤íŒ¨ (throw Error)
- êµ¬ì¡° ë‹¨ìœ„ ì˜¤ë¥˜ â†’ `checkFailures`ì—ì„œ ìµœì¢… íê¸°
- UI/AdapterëŠ” ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ

---

## ğŸ” í˜„ì¬ ì½”ë“œ ìƒíƒœ ë¶„ì„

### 1. `createSingleProcessBlock` í•¨ìˆ˜ í˜„í™©

**ìœ„ì¹˜**: `lib/estimate/constitution-v1-engine.ts` (893-1083ì¤„)

**í˜„ì¬ êµ¬í˜„**:
```typescript
async function createSingleProcessBlock(...): Promise<ProcessEstimateBlock | null> {
  // ...
  
  // ìˆ˜ëŸ‰ ì‚°ì • ê²€ì¦
  const validationError = validateQuantityBasis(quantityBasis)
  if (validationError) {
    console.error(`âŒ ìˆ˜ëŸ‰ ì‚°ì • ì‹¤íŒ¨ [${processId}]: ${validationError}`)
    return null // âš ï¸ ëª…ì„¸ ìœ„ë°˜: throw Error í•´ì•¼ í•¨
  }
  
  // DB ì¡°íšŒ
  const materialResults = await Promise.all(...)
  const laborResults = await Promise.all(...)
  
  // Fail-Fast ì²´í¬
  const hasError = materialResults.some(r => r.status !== 'SUCCESS') ||
                  laborResults.some(r => r.status !== 'SUCCESS')
  if (hasError) {
    return null // âš ï¸ ëª…ì„¸ ìœ„ë°˜: throw Error í•´ì•¼ í•¨
  }
  
  // ìì¬ ì •ë³´ ìˆ˜ì§‘
  const materials = materialRequests.map((req, idx) => {
    // âš ï¸ ëª…ì„¸ ìœ„ë°˜: ìì¬ ì‹¤íŒ¨ ì¡°ê±´ ê²€ì¦ ì—†ìŒ
    return { ... }
  })
  
  // ë…¸ë¬´ ì •ë³´ ìˆ˜ì§‘
  const laborRequestsWithData = laborRequests.map((req, idx) => {
    // âš ï¸ ëª…ì„¸ ìœ„ë°˜: ë…¸ë¬´ ì‹¤íŒ¨ ì¡°ê±´ ê²€ì¦ ì—†ìŒ
    return { ... }
  })
  
  // ...
}
```

**ë¬¸ì œì **:
- âŒ ì‹¤íŒ¨ ì‹œ `null` ë°˜í™˜ (ëª…ì„¸: throw Error)
- âŒ ìì¬ ì‹¤íŒ¨ ì¡°ê±´ ê²€ì¦ ì—†ìŒ
- âŒ ë…¸ë¬´ ì‹¤íŒ¨ ì¡°ê±´ ê²€ì¦ ì—†ìŒ
- âŒ ìì¬ ì¤‘ë³µ ê²€ì¦ ì—†ìŒ
- âŒ ë‚œì´ë„ ê³„ìˆ˜ ë¯¸ë…¸ì¶œ ê²€ì¦ ì—†ìŒ

### 2. `checkFailures` í•¨ìˆ˜ í˜„í™©

**ìœ„ì¹˜**: `lib/estimate/constitution-v1-engine.ts` (2525-2548ì¤„)

**í˜„ì¬ êµ¬í˜„**:
```typescript
function checkFailures(
  processBlocks: ProcessEstimateBlock[],
  processSelections: Record<string, Record<string, string | string[] | null>>
): {
  failedProcesses: ProcessId[]
  reasons: string[]
} {
  const failures = {
    failedProcesses: [],
    reasons: [],
  }

  // ê³µì • ì—†ì´ ê²¬ì  ìƒì„± ì²´í¬
  if (processBlocks.length === 0) {
    failures.reasons.push('ê³µì • ì—†ì´ ê²¬ì  ìƒì„± ì‹œë„')
  }

  // TODO: ë‚˜ë¨¸ì§€ ì‹¤íŒ¨ ì¡°ê±´ ì²´í¬
  // - í•„ìˆ˜ ì—°ë™ ê³µì • ëˆ„ë½
  // - DBì— ì—†ëŠ” ë‹¨ê°€ ì‚¬ìš©
  // - ê³ ê° ì…ë ¥ê³¼ ë¬´ê´€í•œ ê³µì • ì¶”ê°€

  return failures
}
```

**ë¬¸ì œì **:
- âœ… ê³µì • ì—†ìŒ ì²´í¬ ì¡´ì¬
- âŒ í•„ìˆ˜ ê³µì • ëˆ„ë½ ì²´í¬ ì—†ìŒ
- âŒ ë™ì¼ ê³µì • ë¸”ë¡ ì¤‘ë³µ ì²´í¬ ì—†ìŒ
- âš ï¸ ìì¬/ë…¸ë¬´ ë‹¨ê°€ ê²€ì¦ì´ TODOë¡œ ë‚¨ì•„ìˆìŒ (ëª…ì„¸: createSingleProcessBlock ì±…ì„)

---

## ğŸ¯ ëª…ì„¸ ìš”êµ¬ì‚¬í•­ vs í˜„ì¬ êµ¬í˜„ ë¹„êµ

### Part 1: `createSingleProcessBlock` ì‹¤íŒ¨ ì±…ì„

| ê²€ì¦ í•­ëª© | ëª…ì„¸ ìš”êµ¬ì‚¬í•­ | í˜„ì¬ êµ¬í˜„ | ìƒíƒœ |
|----------|-------------|----------|------|
| **ìì¬ ì‹¤íŒ¨ ì¡°ê±´** |
| ìˆ˜ëŸ‰ ì¡´ì¬ + ë‹¨ê°€ 0 | `quantity > 0 && unitPrice === 0` â†’ throw Error | ì²´í¬ ì—†ìŒ | âŒ ë¯¸êµ¬í˜„ |
| ìì¬ ì •ë³´ ë¶ˆì™„ì „ | ë¸Œëœë“œ/ê·œê²©/ë‹¨ìœ„ ì—†ìŒ â†’ throw Error | ì²´í¬ ì—†ìŒ | âŒ ë¯¸êµ¬í˜„ |
| ìì¬ ì¤‘ë³µ ì‚½ì… | ë™ì¼ í‚¤ ì¤‘ë³µ â†’ throw Error | ì²´í¬ ì—†ìŒ | âŒ ë¯¸êµ¬í˜„ |
| **ë…¸ë¬´ ì‹¤íŒ¨ ì¡°ê±´** |
| ë…¸ë¬´ ê³„ì‚° ë¶ˆê°€ | `dailyOutput/crewSize/ratePerPersonDay === 0` â†’ throw Error | ì²´í¬ ì—†ìŒ | âŒ ë¯¸êµ¬í˜„ |
| ì‹œê³µ ê³µì •ì¸ë° ë…¸ë¬´ ì—†ìŒ | `materials.length > 0 && totalLaborCost === 0` â†’ throw Error | ì²´í¬ ì—†ìŒ | âŒ ë¯¸êµ¬í˜„ |
| **ìˆ˜ëŸ‰ ì‹¤íŒ¨ ì¡°ê±´** |
| quantityBasis ëˆ„ë½ | `type/value/reason` ì—†ìŒ â†’ throw Error | `validateQuantityBasis` ì¡´ì¬í•˜ë‚˜ `null` ë°˜í™˜ | âš ï¸ ìˆ˜ì • í•„ìš” |
| ìˆ˜ëŸ‰ 0 ë˜ëŠ” ìŒìˆ˜ | `value <= 0` â†’ throw Error | `validateQuantityBasis`ì—ì„œ ì²´í¬í•˜ë‚˜ `null` ë°˜í™˜ | âš ï¸ ìˆ˜ì • í•„ìš” |
| **ì„¤ëª…-ê³„ì‚° ë¶ˆì¼ì¹˜** |
| ë‚œì´ë„ ê³„ìˆ˜ ë¯¸ë…¸ì¶œ | `difficultyFactor !== 1`ì¸ë° `calculationBasis`ì— ë¯¸í‘œê¸° â†’ throw Error | ì²´í¬ ì—†ìŒ | âŒ ë¯¸êµ¬í˜„ |
| **ì‹¤íŒ¨ ì²˜ë¦¬ ë°©ì‹** |
| ì—ëŸ¬ íƒ€ì… | `throw EstimateValidationError({...})` | `return null` | âŒ ë¯¸êµ¬í˜„ |

### Part 2: `checkFailures` ì—­í•  ì¶•ì†Œ

| ê²€ì¦ í•­ëª© | ëª…ì„¸ ìš”êµ¬ì‚¬í•­ | í˜„ì¬ êµ¬í˜„ | ìƒíƒœ |
|----------|-------------|----------|------|
| ê³µì • ì—†ì´ ê²¬ì  ìƒì„± | `processBlocks.length === 0` â†’ ì‹¤íŒ¨ | âœ… êµ¬í˜„ë¨ | âœ… ì™„ë£Œ |
| í•„ìˆ˜ ê³µì • ëˆ„ë½ | ìš•ì‹¤ ìˆëŠ”ë° ë°©ìˆ˜ ì—†ìŒ ë“± â†’ ì‹¤íŒ¨ | ì²´í¬ ì—†ìŒ | âŒ ë¯¸êµ¬í˜„ |
| ë™ì¼ ê³µì • ë¸”ë¡ ì¤‘ë³µ | `processId + ê³µê°„ + processType` ì¤‘ë³µ â†’ ì‹¤íŒ¨ | ì²´í¬ ì—†ìŒ | âŒ ë¯¸êµ¬í˜„ |
| **ê¸ˆì§€ ì‚¬í•­** |
| ìì¬ ë‹¨ê°€ ê²€ì¦ | âŒ ê¸ˆì§€ (createSingleProcessBlock ì±…ì„) | TODOë¡œ ë‚¨ì•„ìˆìŒ | âš ï¸ ì œê±° í•„ìš” |
| ë…¸ë¬´ ë‹¨ê°€ ê²€ì¦ | âŒ ê¸ˆì§€ (createSingleProcessBlock ì±…ì„) | TODOë¡œ ë‚¨ì•„ìˆìŒ | âš ï¸ ì œê±° í•„ìš” |
| ìˆ˜ëŸ‰ ê²€ì¦ | âŒ ê¸ˆì§€ (createSingleProcessBlock ì±…ì„) | ì—†ìŒ | âœ… ì™„ë£Œ |
| ìì¬ ì¤‘ë³µ ê²€ì¦ | âŒ ê¸ˆì§€ (createSingleProcessBlock ì±…ì„) | ì—†ìŒ | âœ… ì™„ë£Œ |
| ë‚œì´ë„ ê³„ìˆ˜ ê²€ì¦ | âŒ ê¸ˆì§€ (createSingleProcessBlock ì±…ì„) | ì—†ìŒ | âœ… ì™„ë£Œ |

---

## ğŸ› ï¸ êµ¬í˜„ ë°©ì•ˆ

### Phase 1: ì—ëŸ¬ íƒ€ì… ì •ì˜

**ìœ„ì¹˜**: `lib/types/í—Œë²•_ê²¬ì _íƒ€ì….ts` ë˜ëŠ” `lib/estimate/constitution-v1-engine.ts`

```typescript
/**
 * ê²¬ì  ê²€ì¦ ì—ëŸ¬ (í—Œë²• v1 ë³´ê°•)
 * 
 * createSingleProcessBlockì—ì„œ ë°œìƒí•˜ëŠ” ê²€ì¦ ì‹¤íŒ¨ëŠ”
 * ì´ ì—ëŸ¬ íƒ€ì…ìœ¼ë¡œ throwí•œë‹¤.
 */
export class EstimateValidationError extends Error {
  code: 'PROCESS_BLOCK_INVALID'
  processId: ProcessId
  reason: string

  constructor(params: {
    processId: ProcessId
    reason: string
  }) {
    super(`ê²¬ì  ê²€ì¦ ì‹¤íŒ¨ [${params.processId}]: ${params.reason}`)
    this.name = 'EstimateValidationError'
    this.code = 'PROCESS_BLOCK_INVALID'
    this.processId = params.processId
    this.reason = params.reason
  }
}
```

### Phase 2: `createSingleProcessBlock` í•¨ìˆ˜ ìˆ˜ì •

**ìœ„ì¹˜**: `lib/estimate/constitution-v1-engine.ts` (893-1083ì¤„)

#### 2-1. ìˆ˜ëŸ‰ ì‚°ì • ê²€ì¦ ìˆ˜ì • (929-933ì¤„)

**í˜„ì¬**:
```typescript
const validationError = validateQuantityBasis(quantityBasis)
if (validationError) {
  console.error(`âŒ ìˆ˜ëŸ‰ ì‚°ì • ì‹¤íŒ¨ [${processId}]: ${validationError}`)
  return null // âš ï¸ ëª…ì„¸ ìœ„ë°˜
}
```

**ìˆ˜ì • í›„**:
```typescript
const validationError = validateQuantityBasis(quantityBasis)
if (validationError) {
  throw new EstimateValidationError({
    processId,
    reason: `ìˆ˜ëŸ‰ ì‚°ì • ì‹¤íŒ¨: ${validationError}`
  })
}
```

#### 2-2. DB ì¡°íšŒ ì‹¤íŒ¨ ì²˜ë¦¬ ìˆ˜ì • (964-970ì¤„)

**í˜„ì¬**:
```typescript
const hasError = materialResults.some(r => r.status !== 'SUCCESS') ||
                laborResults.some(r => r.status !== 'SUCCESS')

if (hasError) {
  return null // âš ï¸ ëª…ì„¸ ìœ„ë°˜
}
```

**ìˆ˜ì • í›„**:
```typescript
// ìì¬ ì¡°íšŒ ì‹¤íŒ¨ ì²´í¬
const failedMaterial = materialResults.find(r => r.status !== 'SUCCESS')
if (failedMaterial) {
  throw new EstimateValidationError({
    processId,
    reason: `ìì¬ DB ì¡°íšŒ ì‹¤íŒ¨: ${failedMaterial.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`
  })
}

// ë…¸ë¬´ ì¡°íšŒ ì‹¤íŒ¨ ì²´í¬
const failedLabor = laborResults.find(r => r.status !== 'SUCCESS')
if (failedLabor) {
  throw new EstimateValidationError({
    processId,
    reason: `ë…¸ë¬´ DB ì¡°íšŒ ì‹¤íŒ¨: ${failedLabor.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`
  })
}
```

#### 2-3. ìì¬ ì •ë³´ ìˆ˜ì§‘ ë° ê²€ì¦ ì¶”ê°€ (1011-1031ì¤„)

**ìˆ˜ì • í›„**:
```typescript
// ìì¬ ì •ë³´ ìˆ˜ì§‘ ë° ê²€ì¦
const materials: ProcessEstimateBlock['materials'] = []
const materialKeys = new Set<string>() // ì¤‘ë³µ ì²´í¬ìš©

for (let idx = 0; idx < materialRequests.length; idx++) {
  const req = materialRequests[idx]
  const result = materialResults[idx]
  
  if (result.status !== 'SUCCESS' || !result.data) {
    throw new EstimateValidationError({
      processId,
      reason: `ìì¬ ë°ì´í„° ì—†ìŒ: ${req.category.category1}/${req.category.category2}`
    })
  }

  const material = {
    brandName: result.data.brandName || '',
    productName: result.data.productName || '',
    spec: result.data.spec || '',
    category: req.category,
    quantity: req.quantity.value,
    unit: req.quantity.unit,
    unitPrice: result.data.price,
    totalPrice: result.data.price * req.quantity.value,
    dbSource: {
      table: 'materials',
      key: result.data.materialId,
    },
  }

  // âœ… ëª…ì„¸ 2-1: ìˆ˜ëŸ‰ ì¡´ì¬ + ë‹¨ê°€ 0 ì²´í¬
  if (material.quantity > 0 && material.unitPrice === 0) {
    throw new EstimateValidationError({
      processId,
      reason: `ìì¬ ë‹¨ê°€ 0ì›: ${material.productName || material.brandName} (ìˆ˜ëŸ‰: ${material.quantity}${material.unit})`
    })
  }

  // âœ… ëª…ì„¸ 2-2: ìì¬ ì •ë³´ ë¶ˆì™„ì „ ì²´í¬
  if (!material.brandName || !material.spec || !material.unit) {
    throw new EstimateValidationError({
      processId,
      reason: `ìì¬ ì •ë³´ ë¶ˆì™„ì „: ${material.productName || 'ì•Œ ìˆ˜ ì—†ìŒ'} (ë¸Œëœë“œ: ${material.brandName || 'ì—†ìŒ'}, ê·œê²©: ${material.spec || 'ì—†ìŒ'}, ë‹¨ìœ„: ${material.unit || 'ì—†ìŒ'})`
    })
  }

  // âœ… ëª…ì„¸ 2-3: ìì¬ ì¤‘ë³µ ì‚½ì… ì²´í¬
  const materialKey = `${material.brandName}_${material.productName}_${material.spec}_${material.unit}`
  if (materialKeys.has(materialKey)) {
    throw new EstimateValidationError({
      processId,
      reason: `ë™ì¼ ìì¬ ì¤‘ë³µ ì‚½ì…: ${material.productName || material.brandName} (${material.spec})`
    })
  }
  materialKeys.add(materialKey)

  materials.push(material)
}
```

#### 2-4. ë…¸ë¬´ ì •ë³´ ìˆ˜ì§‘ ë° ê²€ì¦ ì¶”ê°€ (1033-1047ì¤„)

**ìˆ˜ì • í›„**:
```typescript
// ë…¸ë¬´ ì •ë³´ ìˆ˜ì§‘ ë° ê²€ì¦
const laborRequestsWithData = laborRequests.map((req, idx) => {
  const result = laborResults[idx]
  if (result.status !== 'SUCCESS' || !result.data) {
    throw new EstimateValidationError({
      processId,
      reason: `ë…¸ë¬´ ë°ì´í„° ì—†ìŒ: ${req.processId}`
    })
  }

  // âœ… ëª…ì„¸ 3-1: ë…¸ë¬´ ê³„ì‚° ë¶ˆê°€ ì²´í¬
  if (result.data.dailyOutput === 0) {
    throw new EstimateValidationError({
      processId,
      reason: `ë…¸ë¬´ 1ì¼ ì‘ì—…ëŸ‰ 0: ${req.processId}`
    })
  }
  if (result.data.crewSize === 0) {
    throw new EstimateValidationError({
      processId,
      reason: `ë…¸ë¬´ íˆ¬ì… ì¸ì› 0: ${req.processId}`
    })
  }
  if (result.data.ratePerPersonDay === 0) {
    throw new EstimateValidationError({
      processId,
      reason: `ë…¸ë¬´ ë‹¨ê°€ 0ì›: ${req.processId}`
    })
  }

  return { request: req, data: result.data }
})

// ë…¸ë¬´ë¹„ ê³„ì‚°
const laborTotal = laborRequestsWithData.reduce((sum, { request, data }) => {
  const workDays = Math.ceil(request.totalQuantity / data.dailyOutput)
  const cost = workDays * data.crewSize * data.ratePerPersonDay * data.difficultyFactor
  return sum + Math.round(cost)
}, 0)

const firstLabor = laborRequestsWithData[0]
const workDays = Math.ceil(firstLabor.request.totalQuantity / firstLabor.data.dailyOutput)

// âœ… ëª…ì„¸ 3-2: ì‹œê³µ ê³µì •ì¸ë° ë…¸ë¬´ ì—†ìŒ ì²´í¬
if (materials.length > 0 && laborTotal === 0) {
  throw new EstimateValidationError({
    processId,
    reason: `ì‹œê³µ ê³µì •ì¸ë° ë…¸ë¬´ë¹„ ì—†ìŒ: ${getProcessName(processId)} (ìì¬ë¹„: ${materials.reduce((sum, m) => sum + m.totalPrice, 0)}ì›)`
  })
}
```

#### 2-5. ë‚œì´ë„ ê³„ìˆ˜ ë¯¸ë…¸ì¶œ ê²€ì¦ ì¶”ê°€ (1068ì¤„ ì´í›„)

**ìˆ˜ì • í›„**:
```typescript
const materialTotal = materials.reduce((sum, m) => sum + m.totalPrice, 0)

// calculationBasis ìƒì„±
const difficultyFactor = firstLabor.data.difficultyFactor
const calculationBasis = `ì‘ì—…ëŸ‰ ${firstLabor.request.totalQuantity}${firstLabor.data.unit} Ã· 1ì¼ ì‘ì—…ëŸ‰ ${firstLabor.data.dailyOutput}${firstLabor.data.unit} = ${workDays}ì¼ Ã— ${firstLabor.data.crewSize}ì¸ Ã— ${firstLabor.data.ratePerPersonDay.toLocaleString()}ì› Ã— ë‚œì´ë„ ${difficultyFactor}`

// âœ… ëª…ì„¸ 5-1: ë‚œì´ë„ ê³„ìˆ˜ ë¯¸ë…¸ì¶œ ì²´í¬
if (difficultyFactor !== 1.0) {
  const hasDifficultyInBasis = calculationBasis.includes('ë‚œì´ë„') || 
                                calculationBasis.includes('difficulty') ||
                                calculationBasis.includes(String(difficultyFactor))
  if (!hasDifficultyInBasis) {
    throw new EstimateValidationError({
      processId,
      reason: `ë‚œì´ë„ ê³„ìˆ˜ ë¯¸ë…¸ì¶œ: ${getProcessName(processId)} (ë‚œì´ë„: ${difficultyFactor}, ê³„ì‚°ì‹ì— ë¯¸í‘œê¸°)`
    })
  }
}

return {
  processName: getProcessName(processId),
  processId,
  processType,
  quantityBasis,
  spaces: group.spaces,
  materials,
  labor: {
    unit: firstLabor.data.unit,
    dailyOutput: firstLabor.data.dailyOutput,
    crewSize: firstLabor.data.crewSize,
    workDays,
    ratePerPersonDay: firstLabor.data.ratePerPersonDay,
    difficultyFactor,
    calculationBasis, // âœ… ë‚œì´ë„ ê³„ìˆ˜ í¬í•¨ëœ ê³„ì‚°ì‹
    totalLaborCost: laborTotal,
    dbSource: {
      table: 'labor_productivity',
      key: firstLabor.data.laborId,
    },
  },
  // ...
}
```

### Phase 3: `createProcessBlocksWithDB` í•¨ìˆ˜ ìˆ˜ì •

**ìœ„ì¹˜**: `lib/estimate/constitution-v1-engine.ts` (1928-1970ì¤„)

**ì—ëŸ¬ ì²˜ë¦¬ ì¶”ê°€**:
```typescript
async function createProcessBlocksWithDB(...): Promise<ProcessEstimateBlock[]> {
  const blocks: ProcessEstimateBlock[] = []

  for (const [processId, group] of processGroups.entries()) {
    try {
      const block = await createSingleProcessBlock(
        processId,
        group,
        pyeong,
        spaceType,
        familyComposition,
        specialConditions,
        mode,
        bathroomCount,
        kitchenCount
      )

      if (block) {
        blocks.push(block)
      }
    } catch (error) {
      // âœ… EstimateValidationErrorëŠ” ìƒìœ„ë¡œ ì „ë‹¬ (ê²¬ì  ì‹¤íŒ¨)
      if (error instanceof EstimateValidationError) {
        throw error // ì¦‰ì‹œ ê²¬ì  ì‹¤íŒ¨
      }
      // ê¸°íƒ€ ì—ëŸ¬ëŠ” ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ê³„ì† ì§„í–‰ (ì„ íƒì )
      console.error(`ê³µì • ${processId} ë¸”ë¡ ìƒì„± ì‹¤íŒ¨:`, error)
    }
  }

  return blocks
}
```

### Phase 4: `checkFailures` í•¨ìˆ˜ ìˆ˜ì •

**ìœ„ì¹˜**: `lib/estimate/constitution-v1-engine.ts` (2525-2548ì¤„)

**ìˆ˜ì • í›„**:
```typescript
/**
 * ìµœì¢… ë°©ì–´ì„ : êµ¬ì¡°ì  ì‹¤íŒ¨ë§Œ íŒë‹¨ (í—Œë²• v1 ë³´ê°•)
 * 
 * ì´ í•¨ìˆ˜ëŠ”:
 * - ê³„ì‚° âŒ
 * - ë³´ì • âŒ
 * - ìƒì„¸ ê²€ì¦ âŒ
 * - ì˜¤ì§ êµ¬ì¡°ì  ì‹¤íŒ¨ë§Œ íŒë‹¨ âœ…
 */
function checkFailures(
  processBlocks: ProcessEstimateBlock[],
  processSelections: Record<string, Record<string, string | string[] | null>>
): {
  failedProcesses: ProcessId[]
  reasons: string[]
} {
  const failures: { failedProcesses: ProcessId[]; reasons: string[] } = {
    failedProcesses: [],
    reasons: [],
  }

  // âœ… ëª…ì„¸ 1-1: ê³µì • ì—†ì´ ê²¬ì  ìƒì„±
  if (processBlocks.length === 0) {
    failures.reasons.push('ê³µì • ì—†ì´ ê²¬ì  ìƒì„± ì‹œë„')
    return failures
  }

  // âœ… ëª…ì„¸ 1-2: í•„ìˆ˜ ê³µì • ëˆ„ë½ ì²´í¬
  const processIds = new Set(processBlocks.map(b => b.processId))
  
  // ìš•ì‹¤ ìˆëŠ”ë° ë°©ìˆ˜ ì—†ìŒ
  if (processIds.has('bathroom') && !processIds.has('waterproof')) {
    failures.failedProcesses.push('bathroom')
    failures.reasons.push('ìš•ì‹¤ ê³µì •ì´ ìˆëŠ”ë° ë°©ìˆ˜ ê³µì •ì´ ì—†ìŒ (í•„ìˆ˜ ì—°ë™ ê³µì • ëˆ„ë½)')
  }
  
  // ì£¼ë°© ìˆëŠ”ë° ì„¤ë¹„ ì—†ìŒ
  if (processIds.has('kitchen') && !processIds.has('plumbing')) {
    failures.failedProcesses.push('kitchen')
    failures.reasons.push('ì£¼ë°© ê³µì •ì´ ìˆëŠ”ë° ì„¤ë¹„ ê³µì •ì´ ì—†ìŒ (í•„ìˆ˜ ì—°ë™ ê³µì • ëˆ„ë½)')
  }
  
  // TODO: ë‹¤ë¥¸ í•„ìˆ˜ ì—°ë™ ê·œì¹™ ì¶”ê°€ (í—Œë²• v1 STEP 3 ì°¸ì¡°)

  // âœ… ëª…ì„¸ 1-3: ë™ì¼ ê³µì • ë¸”ë¡ ì¤‘ë³µ ì²´í¬
  const processBlockKeys = new Set<string>()
  for (const block of processBlocks) {
    const key = `${block.processId}_${block.spaces.join(',')}_${block.processType}`
    if (processBlockKeys.has(key)) {
      failures.failedProcesses.push(block.processId)
      failures.reasons.push(`ë™ì¼ ê³µì • ë¸”ë¡ ì¤‘ë³µ: ${block.processName} (ê³µê°„: ${block.spaces.join(', ')}, ìœ í˜•: ${block.processType})`)
    }
    processBlockKeys.add(key)
  }

  return failures
}
```

### Phase 5: `calculateFinalEstimateV1` í•¨ìˆ˜ ìˆ˜ì •

**ìœ„ì¹˜**: `lib/estimate/constitution-v1-engine.ts` (1740-1897ì¤„)

**ì—ëŸ¬ ì²˜ë¦¬ ì¶”ê°€**:
```typescript
export async function calculateFinalEstimateV1(...): Promise<FinalEstimate> {
  // ...
  
  // STEP 4: ê³µì • ë¸”ë¡ ìƒì„± (DB ì¡°íšŒ í¬í•¨)
  let processBlocks: ProcessEstimateBlock[] = []
  
  try {
    processBlocks = await createProcessBlocksWithDB(
      processGroups,
      pyeong,
      spaceType,
      familyComposition,
      specialConditions,
      mode,
      bathroomCount,
      kitchenCount
    )
  } catch (error) {
    // âœ… EstimateValidationErrorëŠ” ì¦‰ì‹œ ê²¬ì  ì‹¤íŒ¨
    if (error instanceof EstimateValidationError) {
      return {
        projectSummary: {
          pyeong,
          spaceType: spaceType || 'ì£¼ê±°',
          familyComposition,
          specialConditions,
          mode,
          spaces,
          processes: [],
        },
        processBlockSummary: [],
        processBlocks: [],
        optionsSummary: [],
        estimateResult: {
          totalMaterial: 0,
          totalLabor: 0,
          totalDirect: 0,
          indirectCosts: {
            industrialAccident: 0,
            employment: 0,
            overhead: 0,
            profit: 0,
            total: 0,
          },
          vat: 0,
          totalWithVAT: 0,
          costPerPyeong: 0,
        },
        standard: 'ARGEN',
        failures: {
          failedProcesses: [error.processId],
          reasons: [error.reason],
          requiresConfirmation: false,
        },
        status: 'ESTIMATE_FAILED',
      }
    }
    // ê¸°íƒ€ ì—ëŸ¬ëŠ” ì¬throw
    throw error
  }

  const selectedProcessIds = Array.from(processGroups.keys())

  // âœ… ìµœì¢… ë°©ì–´ì„ : êµ¬ì¡°ì  ì‹¤íŒ¨ ì²´í¬
  const failures = checkFailures(processBlocks, processSelections)

  if (failures.failedProcesses.length > 0) {
    return {
      // ... ESTIMATE_FAILED ë°˜í™˜
    }
  }

  // ...
}
```

---

## ğŸ“ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: ì—ëŸ¬ íƒ€ì… ì •ì˜ (ìš°ì„ ìˆœìœ„: ê¸´ê¸‰)

- [ ] `EstimateValidationError` í´ë˜ìŠ¤ ì •ì˜
- [ ] ì—ëŸ¬ íƒ€ì… í…ŒìŠ¤íŠ¸

### Phase 2: `createSingleProcessBlock` ìˆ˜ì • (ìš°ì„ ìˆœìœ„: ê¸´ê¸‰)

- [ ] ìˆ˜ëŸ‰ ì‚°ì • ê²€ì¦: `return null` â†’ `throw EstimateValidationError`
- [ ] DB ì¡°íšŒ ì‹¤íŒ¨ ì²˜ë¦¬: `return null` â†’ `throw EstimateValidationError`
- [ ] ìì¬ ë‹¨ê°€ 0ì› ì²´í¬ ì¶”ê°€
- [ ] ìì¬ ì •ë³´ ë¶ˆì™„ì „ ì²´í¬ ì¶”ê°€
- [ ] ìì¬ ì¤‘ë³µ ì‚½ì… ì²´í¬ ì¶”ê°€
- [ ] ë…¸ë¬´ ê³„ì‚° ë¶ˆê°€ ì²´í¬ ì¶”ê°€ (`dailyOutput`, `crewSize`, `ratePerPersonDay`)
- [ ] ì‹œê³µ ê³µì •ì¸ë° ë…¸ë¬´ ì—†ìŒ ì²´í¬ ì¶”ê°€
- [ ] ë‚œì´ë„ ê³„ìˆ˜ ë¯¸ë…¸ì¶œ ì²´í¬ ì¶”ê°€
- [ ] í…ŒìŠ¤íŠ¸: ê° ì‹¤íŒ¨ ì¡°ê±´ë³„ `EstimateValidationError` ë°œìƒ í™•ì¸

### Phase 3: `createProcessBlocksWithDB` ìˆ˜ì • (ìš°ì„ ìˆœìœ„: ê¸´ê¸‰)

- [ ] `EstimateValidationError` catch ë° ì¬throw
- [ ] í…ŒìŠ¤íŠ¸: ì—ëŸ¬ ì „ë‹¬ í™•ì¸

### Phase 4: `checkFailures` ìˆ˜ì • (ìš°ì„ ìˆœìœ„: ë†’ìŒ)

- [ ] ê³µì • ì—†ìŒ ì²´í¬ ìœ ì§€
- [ ] í•„ìˆ˜ ê³µì • ëˆ„ë½ ì²´í¬ ì¶”ê°€ (ìš•ì‹¤-ë°©ìˆ˜, ì£¼ë°©-ì„¤ë¹„)
- [ ] ë™ì¼ ê³µì • ë¸”ë¡ ì¤‘ë³µ ì²´í¬ ì¶”ê°€
- [ ] ìì¬/ë…¸ë¬´ ë‹¨ê°€ ê²€ì¦ ì œê±° (TODO ì£¼ì„ ì‚­ì œ)
- [ ] í…ŒìŠ¤íŠ¸: êµ¬ì¡°ì  ì‹¤íŒ¨ë§Œ ì²´í¬í•˜ëŠ”ì§€ í™•ì¸

### Phase 5: `calculateFinalEstimateV1` ìˆ˜ì • (ìš°ì„ ìˆœìœ„: ê¸´ê¸‰)

- [ ] `EstimateValidationError` catch ë° `ESTIMATE_FAILED` ë°˜í™˜
- [ ] í…ŒìŠ¤íŠ¸: ì—ëŸ¬ ë°œìƒ ì‹œ ê²¬ì  ì‹¤íŒ¨ í™•ì¸

### Phase 6: í†µí•© í…ŒìŠ¤íŠ¸

- [ ] ëª¨ë“  ì‹¤íŒ¨ ì¡°ê±´ì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
- [ ] `ESTIMATE_FAILED` ìƒíƒœ ë°˜í™˜ ì‹œ ìˆ«ì ì¶œë ¥ ì•ˆ ë˜ëŠ”ì§€ í™•ì¸
- [ ] UIì—ì„œ ì‹¤íŒ¨ ë©”ì‹œì§€ê°€ ì •ìƒ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. ì±…ì„ ë¶„ë¦¬ ì›ì¹™

**`createSingleProcessBlock` ì±…ì„**:
- âœ… ê³µì • í•˜ë‚˜ì˜ ìœ íš¨ì„± í™•ì •
- âœ… ìì¬/ë…¸ë¬´ ë‹¨ê°€ ê²€ì¦
- âœ… ìˆ˜ëŸ‰ ê²€ì¦
- âœ… ìì¬ ì¤‘ë³µ ê²€ì¦
- âœ… ë‚œì´ë„ ê³„ìˆ˜ ê²€ì¦

**`checkFailures` ì±…ì„**:
- âœ… êµ¬ì¡°ì  ì‹¤íŒ¨ë§Œ íŒë‹¨
- âœ… ê³µì • ì—†ìŒ
- âœ… í•„ìˆ˜ ê³µì • ëˆ„ë½
- âœ… ë™ì¼ ê³µì • ë¸”ë¡ ì¤‘ë³µ

**ê¸ˆì§€ ì‚¬í•­**:
- âŒ `checkFailures`ì—ì„œ ìì¬/ë…¸ë¬´ ë‹¨ê°€ ê²€ì¦
- âŒ `checkFailures`ì—ì„œ ìˆ˜ëŸ‰ ê²€ì¦
- âŒ `checkFailures`ì—ì„œ ìì¬ ì¤‘ë³µ ê²€ì¦
- âŒ `checkFailures`ì—ì„œ ë‚œì´ë„ ê³„ìˆ˜ ê²€ì¦

### 2. ì‹¤íŒ¨ ì²˜ë¦¬ ë°©ì‹

**`createSingleProcessBlock`**:
- âŒ `null` ë°˜í™˜ ê¸ˆì§€
- âŒ ë¶€ë¶„ ê°ì²´ ë°˜í™˜ ê¸ˆì§€
- âœ… `throw EstimateValidationError` í•„ìˆ˜

**`checkFailures`**:
- âœ… `ESTIMATE_FAILED` ìƒíƒœ ë°˜í™˜
- âŒ ìˆ«ì ì¶œë ¥ ê¸ˆì§€
- âŒ ê³µì •ë³„ ê²°ê³¼ ê¸ˆì§€

### 3. UI ìˆ˜ì • ê¸ˆì§€

- âŒ 0ì› í•­ëª© í‘œì‹œ ê¸ˆì§€
- âŒ ì¤‘ë³µ í•­ëª© ìˆ¨ê¹€ ê¸ˆì§€
- âŒ ê²½ê³  ë¡œê·¸ë§Œ ì¶œë ¥í•˜ê³  ê³„ì† ì§„í–‰ ê¸ˆì§€
- âŒ ì„ì˜ ê¸°ë³¸ê°’ ì‚½ì… ê¸ˆì§€

**UIëŠ” ì˜¤ì§**:
- âœ… ì„±ê³µ ê²°ê³¼ ì¶œë ¥
- âœ… ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ

---

## ğŸ“Š ì˜ˆìƒ íš¨ê³¼

êµ¬í˜„ ì™„ë£Œ í›„:
- âœ… ê³µì • ë‹¨ìœ„ ì˜¤ë¥˜ëŠ” `createSingleProcessBlock`ì—ì„œ ì¦‰ì‹œ ì°¨ë‹¨
- âœ… êµ¬ì¡° ë‹¨ìœ„ ì˜¤ë¥˜ëŠ” `checkFailures`ì—ì„œ ìµœì¢… ì°¨ë‹¨
- âœ… 0ì› ê²¬ì  êµ¬ì¡°ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥
- âœ… ì¤‘ë³µ ê²¬ì  êµ¬ì¡°ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥
- âœ… ì„¤ëª…ê³¼ ë‹¤ë¥¸ ê¸ˆì•¡ êµ¬ì¡°ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥
- âœ… "ì—‰ë§ì¸ ê²¬ì " êµ¬ì¡°ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥

---

## ğŸ¯ êµ¬í˜„ ìˆœì„œ

1. **Phase 1**: ì—ëŸ¬ íƒ€ì… ì •ì˜
2. **Phase 2**: `createSingleProcessBlock` ìˆ˜ì • (ëª¨ë“  ê³µì • ë‹¨ìœ„ ê²€ì¦)
3. **Phase 3**: `createProcessBlocksWithDB` ìˆ˜ì • (ì—ëŸ¬ ì „ë‹¬)
4. **Phase 4**: `checkFailures` ìˆ˜ì • (êµ¬ì¡°ì  ì‹¤íŒ¨ë§Œ)
5. **Phase 5**: `calculateFinalEstimateV1` ìˆ˜ì • (ì—ëŸ¬ ì²˜ë¦¬)
6. **Phase 6**: í†µí•© í…ŒìŠ¤íŠ¸

---

**ì‘ì„±ì**: AI Assistant  
**ê²€í†  í•„ìš”**: ê°œë°œíŒ€ ë¦¬ë·° í›„ êµ¬í˜„ ì‘ì—… ì§„í–‰






