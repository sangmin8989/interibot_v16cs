# Phase 6 — AI 호출 제한 정책 설계안

> **버전**: 1.0 (고정본)  
> **작성일**: 2025-01-21  
> **상태**: 정책 설계 완료 (코드 미적용)

---

## 0) Phase 6 절대 원칙

### 핵심 원칙
- ✅ **정책만 설계** (코드·환경변수 변경 금지)
- ✅ **관측 지표 기반으로만 임계값 정의**
- ✅ **UX 핵심 경로 보호가 최우선**
- ✅ **이미지 생성 우선 제어, 텍스트 후순위**

### 적용 순서 고정
```
IMAGE → CHAT → 기타
```
**역순 적용 금지**: 기타 → CHAT → IMAGE 순서로 적용하지 않음

---

## 1) 라우트 분류 (고정)

### A. 고비용·고지연 (1순위 제어)

| 라우트 | Action | 특징 | 전략 |
|--------|--------|------|------|
| 이미지 생성 | `IMAGE_GENERATE` | 지연↑, 비용↑, UX 체감↓(대체 가능) | 먼저 걸고, 강하게 |
| 이미지 프롬프트 | `IMAGE_PROMPT` | 지연↑, 비용↑, UX 체감↓(대체 가능) | 먼저 걸고, 강하게 |
| 비전 분석 | `VISION_ANALYSIS` | 지연↑, 비용↑, UX 체감↓(대체 가능) | 먼저 걸고, 강하게 |

**특징:**
- 지연 시간 높음
- 비용 높음
- UX 체감 낮음 (대체 가능)

**전략:** 먼저 걸고, 강하게 제한

---

### B. 상호작용 핵심 (2순위 제어)

| 라우트 | Action | 특징 | 전략 |
|--------|--------|------|------|
| 채팅 | `CHAT` | 빈도↑, UX 민감 | 완만한 제한, 지연 우선 |
| 공정 추천 | `PROCESS_RECOMMEND` | 빈도↑, UX 민감 | 완만한 제한, 지연 우선 |
| 옵션 추천 | `OPTION_RECOMMEND` | 빈도↑, UX 민감 | 완만한 제한, 지연 우선 |

**특징:**
- 호출 빈도 높음
- UX 민감도 높음

**전략:** 완만한 제한, 지연 우선 (차단보다는 지연)

---

### C. 시스템 핵심 (보호 대상)

| 라우트 | Action | 특징 | 전략 |
|--------|--------|------|------|
| 성향 분석 | `TRAIT_ANALYSIS` | 인테리봇 신뢰의 핵심 | 원칙적 무제한 (단, 악용 감지 시만 제한) |
| 요약 | `SUMMARY` | 인테리봇 신뢰의 핵심 | 원칙적 무제한 (단, 악용 감지 시만 제한) |
| 견적 AI | `ESTIMATE_AI` | 인테리봇 신뢰의 핵심 | 원칙적 무제한 (단, 악용 감지 시만 제한) |

**특징:**
- 인테리봇 신뢰의 핵심 기능
- 사용자 경험에 직접적 영향

**전략:** 원칙적 무제한 (단, 악용 감지 시만 제한)

---

## 2) 제한 트리거 기준 (관측 기반)

### IMAGE 계열

| 지표 | 임계값 | 조치 |
|------|--------|------|
| 분당 호출 | ≥ 20 | 제한 후보 |
| 평균 duration | ≥ 3s | 제한 후보 |
| 실패율 | ≥ 10% | 즉시 제한 검토 |

**트리거 충족 = 제한 검토, 즉시 적용 아님**

---

### CHAT 계열

| 지표 | 임계값 | 조치 |
|------|--------|------|
| 분당 호출 | ≥ 60 | 제한 후보 |
| 단일 라우트 점유율 | ≥ 40% | 제한 후보 |

---

### 공통 (악용 감지)

| 패턴 | 설명 | 조치 |
|------|------|------|
| 특정 사용자/세션 반복 호출 | 동일 세션에서 짧은 시간 내 반복 호출 | 제한 검토 |
| 짧은 프롬프트 + 고빈도 | 스크립트 의심 패턴 | 제한 검토 |

**※ 트리거 충족 = 제한 검토, 즉시 적용 아님**

---

## 3) 제한 방식 설계 (단계형)

### Level 0 — 관측만 (현재)

**상태:** ✅ 적용 중 (Phase 5 완료)

- 로그 수집
- 정책 문서 유지
- 제한 없음

---

### Level 1 — 소프트 제한

**조건:** Level 0에서 트리거 기준 1개 이상 충족

**조치:**
- 응답 지연 (예: 300~800ms 인위적 지연)
- UX 안내 문구 (차후 구현)
  - "잠시만 기다려주세요..."
  - "처리 중입니다..."

**목적:** 사용자 체감을 "막힘"이 아니라 "잠깐 기다림"으로 인식

---

### Level 2 — 하드 제한

**조건:** Level 1에서도 트리거 기준 지속 충족

**조치:**
- 요청 차단
- 대체 경로 제시
  - 텍스트 설명 제공
  - 이전 결과 재사용
  - 캐시된 결과 반환

**적용 순서:**
1. IMAGE 계열 먼저
2. CHAT 계열 다음
3. 기타 마지막

---

## 4) 사용자 체감 보호 규칙 (중요)

### 핵심 원칙

1. **첫 요청은 항상 통과**
   - 사용자의 첫 AI 호출은 무조건 성공
   - 연속 호출만 제한

2. **연속 호출만 제한**
   - 단일 호출은 제한 없음
   - 짧은 시간 내 반복 호출만 제한

3. **분석/견적 결과는 캐시 우선**
   - 동일 입력에 대해서는 캐시된 결과 반환
   - 불필요한 AI 호출 방지

4. **"막힘"이 아니라 "잠깐 기다림"으로 인식되게 설계**
   - 차단 메시지보다는 지연 처리
   - 사용자 경험 최우선

---

## 5) enableLimit 전환 조건 (명문화)

### Phase 6.5 진입 조건

다음 중 **2개 이상** 충족 시 `enableLimit=true` 검토 가능:

| 조건 | 기준 | 기간 |
|------|------|------|
| IMAGE_GENERATE 분당 호출 | ≥ 20 | 3일 연속 |
| 평균 duration | ≥ 3s | 5회 이상 |
| 전체 AI 비용 중 IMAGE 비율 | ≥ 50% | - |
| 특정 라우트 점유율 | ≥ 40% | - |

**현재 상태:** Phase 5 완료, Phase 6.5 대기 중

---

## 6) 산출물 상태

### 완료된 산출물

- ✅ **정책 문서**: 본 문서
- ✅ **라우트 분류표**: A, B, C 3단계 분류
- ✅ **트리거 기준**: 관측 기반 임계값 정의
- ✅ **단계형 제한 전략**: Level 0, 1, 2 설계
- ✅ **UX 보호 규칙**: 사용자 체감 보호 원칙

### 대기 중인 산출물

- ⏳ **코드 구현**: Phase 6.5에서 진행
- ⏳ **환경변수 설정**: Phase 6.5에서 진행
- ⏳ **모니터링 대시보드**: Phase 6.5에서 진행

---

## 7) 적용 로드맵

### Phase 6 (현재)
- ✅ 정책 설계 완료
- ✅ 관측 로그 수집 중
- ⏳ 트리거 기준 모니터링

### Phase 6.5 (조건 충족 시)
- ⏳ `enableLimit=true` 전환 검토
- ⏳ Level 1 소프트 제한 구현
- ⏳ UX 안내 문구 추가

### Phase 7 (필요 시)
- ⏳ Level 2 하드 제한 구현
- ⏳ 대체 경로 구현
- ⏳ 캐시 시스템 강화

---

## 8) 모니터링 체크리스트

### 일일 확인 항목

- [ ] IMAGE 계열 분당 호출 수
- [ ] CHAT 계열 분당 호출 수
- [ ] 평균 duration (IMAGE, CHAT)
- [ ] 실패율 (전체, 라우트별)
- [ ] 라우트별 점유율

### 주간 확인 항목

- [ ] 전체 AI 비용 중 IMAGE 비율
- [ ] 특정 라우트 점유율 추이
- [ ] 사용자별 호출 패턴
- [ ] 악용 의심 패턴

### Phase 6.5 진입 판단

- [ ] 위 조건 중 2개 이상 충족 여부
- [ ] UX 영향도 평가
- [ ] 제한 정책 적용 검토

---

## 부록: 라우트 매핑표

| 실제 라우트 경로 | Action | 분류 | 우선순위 |
|-----------------|--------|------|----------|
| `/api/v5/analyze/photo` | `IMAGE_GENERATE` | A | 1 |
| `/api/image/prompt` | `IMAGE_GENERATE` | A | 1 |
| `/api/analyze/vision` | `IMAGE_GENERATE` | A | 1 |
| `/api/v5/analyze/chat` | `CHAT` | B | 2 |
| `/api/recommend/process` | `PROCESS_RECOMMEND` | B | 2 |
| `/api/recommend/argen` | `OPTION_RECOMMEND` | B | 2 |
| `/api/generate-questions` | `TRAIT_ANALYSIS` | C | 3 |
| `/api/analysis/submit` | `SUMMARY` | C | 3 |
| `/api/estimate/materials` | `ESTIMATE_AI` | C | 3 |
| `/api/analyze/preference` | `TRAIT_ANALYSIS` | C | 3 |
| `/api/test-model-verification` | `DEBUG` | - | - |

---

**문서 끝**

**버전:** 1.0 (고정본)  
**작성일:** 2025-01-21  
**상태:** 정책 설계 완료


