# 인테리봇 성향분석 로직 문제점 분석 보고서

> 작성일: 2024년  
> 분석 범위: V3 TraitEngine, V4 PersonalityEngine, 변환 로직  
> 심각도: 🔴 Critical, 🟡 Major, 🟢 Minor

---

## 📋 목차

1. [요약](#요약)
2. [치명적 문제 (Critical)](#치명적-문제-critical)
3. [중요 문제 (Major)](#중요-문제-major)
4. [개선 권장 사항 (Minor)](#개선-권장-사항-minor)
5. [해결 방안](#해결-방안)

---

## 요약

### 발견된 문제점 통계

| 심각도 | 개수 | 영향 |
|--------|------|------|
| 🔴 Critical | 5개 | 성향 분석 결과가 부정확하거나 누락됨 |
| 🟡 Major | 4개 | 기능은 작동하지만 예상치 못한 동작 |
| 🟢 Minor | 3개 | 코드 품질 및 유지보수성 개선 필요 |

### 핵심 문제 요약

1. **사용자 입력 정보 손실**: V4 → V3 변환 시 preferences 정보가 하드코딩된 기본값으로 대체됨
2. **키 매핑 불일치**: V3와 V4 간 성향 키 매핑이 완전하지 않음
3. **점수 변환 공식 오류**: answer-mappings의 1-10 점수를 -50~+50으로 변환하는 공식이 부정확
4. **데이터 소스 충돌**: answer-mappings와 질문 기준표 간 우선순위가 불명확
5. **SpaceInfo 정보 누락**: V3 SpaceInfo에 totalPeople 등 필수 정보가 없을 수 있음

---

## 치명적 문제 (Critical)

### 🔴 문제 1: TraitScorer에서 사용자 Preferences 정보 손실

**위치**: `lib/estimate-v4/engines/personality/TraitScorer.ts:28-50`

**문제 코드**:
```typescript
// 1. V4 입력 → V3 입력 변환
const v3Input = toV3TraitEngineInput({
  answers,
  spaceInfo,
  preferences: {
    budget: { min: 0, max: 0, flexibility: 'uncertain' },  // ❌ 하드코딩
    family: {
      totalPeople: 0,      // ❌ 실제 값 무시
      hasInfant: false,    // ❌ 실제 값 무시
      hasChild: false,     // ❌ 실제 값 무시
      hasElderly: false,   // ❌ 실제 값 무시
      hasPet: false,       // ❌ 실제 값 무시
    },
    lifestyle: {
      remoteWork: false,   // ❌ 실제 값 무시
      cookOften: false,   // ❌ 실제 값 무시
      guestsOften: false, // ❌ 실제 값 무시
    },
    purpose: 'live',       // ❌ 실제 값 무시
  },
  // ...
})
```

**문제점**:
- `calculateTraitScores` 함수가 `preferences` 파라미터를 받지 않음
- V4 입력의 실제 preferences 정보가 모두 무시되고 기본값으로 대체됨
- TypeClassifier에서 사용하는 가족/생활 유형 분류가 항상 빈 배열이 됨

**영향**:
- ✅ 사용자가 "재택근무한다"고 답해도 `remote_work` 타입이 분류되지 않음
- ✅ 사용자가 "아이가 있다"고 답해도 `has_child` 타입이 분류되지 않음
- ✅ TypeClassifier의 lifestyle, family 배열이 항상 비어있음
- ✅ RiskAssessor의 후회위험 평가가 부정확함

**해결 방안**:
```typescript
// 수정 전
export async function calculateTraitScores(
  answers: UserAnswerV4[],
  spaceInfo: SpaceInfoV4
): Promise<TraitScoreV4[]>

// 수정 후
export async function calculateTraitScores(
  answers: UserAnswerV4[],
  spaceInfo: SpaceInfoV4,
  preferences: PreferencesV4  // ✅ 추가
): Promise<TraitScoreV4[]>
```

---

### 🔴 문제 2: TypeClassifier에서 존재하지 않는 키 조회

**위치**: `lib/estimate-v4/engines/personality/TypeClassifier.ts:62-66`

**문제 코드**:
```typescript
// 성격 유형 분류
const orgScore = scoreMap.get('organization_habit') ?? 5  // ❌ 존재하지 않는 키
const storageScore = scoreMap.get('storage_importance') ?? 5
const cleaningScore = scoreMap.get('cleaning_preference') ?? 5
const noiseScore = scoreMap.get('noise_sensitivity') ?? 5
const lightScore = scoreMap.get('light_importance') ?? 5
```

**문제점**:
- `organization_habit`은 V4 TraitScoreV4에 존재하지 않는 키
- V3 TraitIndicators12에는 `수납중요도`, `관리민감도` 등이 있지만 `정리습관`은 없음
- `trait-mapper.ts`에는 `organization_habit` → `정리습관` 매핑이 있지만, 실제 V3 결과에는 `정리습관`이 없음

**영향**:
- ✅ `clean_oriented` 타입이 항상 분류되지 않음 (orgScore가 항상 5)
- ✅ `storage_focused` 타입이 항상 분류되지 않음
- ✅ 성격 유형 분류가 제대로 작동하지 않음

**해결 방안**:
```typescript
// 수정 후
const orgScore = scoreMap.get('storage_importance') ?? 5  // ✅ 수납중요도로 대체
// 또는
const orgScore = (scoreMap.get('storage_importance') ?? 5) + 
                 (scoreMap.get('cleaning_preference') ?? 5) / 2  // ✅ 복합 점수
```

---

### 🔴 문제 3: 점수 변환 공식의 부정확성

**위치**: `lib/analysis/engine-v3/engines/TraitEngine.ts:170-186`

**문제 코드**:
```typescript
private convertAnswerMappingsToImpact(answerMappingsImpacts: AnswerImpact[]): any {
  const indicators: Record<string, { value: number }> = {}
  
  // answer-mappings의 score(1-10)를 TraitEngine의 value(-50~+50)로 변환
  // score 1-10을 -50~+50 범위로 매핑: (score - 5.5) * 10
  answerMappingsImpacts.forEach(({ category, score }) => {
    const indicatorKey = this.mapCategoryToIndicator(category)
    if (indicatorKey) {
      // score 1-10을 -50~+50 범위로 변환
      const value = (score - 5.5) * 10  // ❌ 부정확한 공식
      indicators[indicatorKey] = { value }
    }
  })
  
  return Object.keys(indicators).length > 0 ? { indicators } : null
}
```

**문제점**:
- 공식 `(score - 5.5) * 10`의 문제:
  - score = 1 → value = -45 (너무 낮음)
  - score = 10 → value = +45 (너무 높음)
  - score = 5 → value = -5 (중간값이 음수)
- 질문 기준표의 영향값은 -50~+50 범위인데, answer-mappings는 1-10 범위
- 두 데이터 소스의 스케일이 다름

**영향**:
- ✅ answer-mappings를 사용하는 답변의 영향이 과소 또는 과대 평가됨
- ✅ 질문 기준표와 answer-mappings 간 점수 일관성 부족
- ✅ 동일한 의미의 답변이 다른 점수로 계산될 수 있음

**해결 방안**:
```typescript
// 수정 후: 더 정확한 변환 공식
const value = (score - 5.5) * 9.09  // 1→-40.9, 5→-4.5, 10→+40.9 (더 균형잡힘)
// 또는
const value = (score - 1) * (100 / 9) - 50  // 1→-50, 5.5→0, 10→+50
```

---

### 🔴 문제 4: SpaceInfo 기반 조정에서 totalPeople 누락

**위치**: `lib/analysis/engine-v3/engines/TraitEngine.ts:216-240`

**문제 코드**:
```typescript
private adjustBySpaceInfo(
  indicators: TraitIndicators12,
  spaceInfo: any  // ❌ any 타입
): TraitIndicators12 {
  const adjusted = { ...indicators }

  // 가족 구성원 수가 많으면 가족영향도, 수납중요도 증가
  if (spaceInfo.totalPeople && spaceInfo.totalPeople >= 4) {  // ❌ totalPeople이 없을 수 있음
    adjusted.가족영향도 = validateIndicatorRange('가족영향도', adjusted.가족영향도 + 10)
    adjusted.수납중요도 = validateIndicatorRange('수납중요도', adjusted.수납중요도 + 10)
  }
  // ...
}
```

**문제점**:
- V3 SpaceInfo 타입에 `totalPeople` 필드가 없음
- `toV3SpaceInfo` 함수에서 `totalPeople`을 변환하지 않음
- `adjustBySpaceInfo`에서 `totalPeople`을 체크하지만 항상 undefined

**영향**:
- ✅ 대가족(4인 이상) 사용자의 가족영향도, 수납중요도가 조정되지 않음
- ✅ SpaceInfo 기반 추가 조정이 제대로 작동하지 않음

**해결 방안**:
```typescript
// 1. V3 SpaceInfo 타입에 totalPeople 추가
export interface SpaceInfo {
  // ... 기존 필드
  totalPeople?: number  // ✅ 추가
}

// 2. toV3SpaceInfo에서 totalPeople 변환
export function toV3SpaceInfo(spaceInfo: SpaceInfoV4) {
  return {
    // ... 기존 필드
    totalPeople: spaceInfo.preferences?.family?.totalPeople ?? 0  // ✅ 추가
  }
}
```

---

### 🔴 문제 5: 키 매핑 불일치로 인한 데이터 손실

**위치**: `lib/estimate-v4/converters/trait-mapper.ts`

**문제 코드**:
```typescript
export const V3_KO_TO_V4_EN: Record<string, string> = {
  '수납중요도': 'storage_importance',
  '동선중요도': 'flow_importance',
  // ...
  '정리습관': 'organization_habit',  // ❌ V3 TraitIndicators12에 없음
  '요리빈도': 'cooking_frequency',    // ❌ V3 TraitIndicators12에 없음
  // ...
}
```

**문제점**:
- 매핑 테이블에 있는 키들이 실제 V3 TraitIndicators12 타입에 없음
- `정리습관`, `요리빈도`, `손님빈도` 등은 V3에 존재하지 않음
- V3 → V4 변환 시 이러한 키들이 무시됨

**영향**:
- ✅ V3에서 계산된 일부 성향 점수가 V4로 변환되지 않음
- ✅ TypeClassifier에서 `organization_habit`을 조회해도 항상 undefined
- ✅ 데이터 손실 발생

**해결 방안**:
```typescript
// 1. V3 TraitIndicators12에 누락된 키 추가
export interface TraitIndicators12 {
  // ... 기존 12개
  정리습관?: number      // ✅ 추가
  요리빈도?: number      // ✅ 추가
  손님빈도?: number      // ✅ 추가
  // ...
}

// 2. 또는 매핑 테이블에서 존재하지 않는 키 제거
export const V3_KO_TO_V4_EN: Record<string, string> = {
  // 존재하는 키만 매핑
}
```

---

## 중요 문제 (Major)

### 🟡 문제 6: 데이터 소스 우선순위 불명확

**위치**: `lib/analysis/engine-v3/engines/TraitEngine.ts:54-66`

**문제 코드**:
```typescript
// 5. 답변별 영향 적용
for (const [questionId, answerId] of Object.entries(input.answers)) {
  // 먼저 answer-mappings.ts에서 찾기 (판단 축 질문 등)
  let impact: any = null
  const answerMappingsImpacts = getAnswerImpacts(questionId, answerId)
  
  if (answerMappingsImpacts && answerMappingsImpacts.length > 0) {
    // answer-mappings 형식을 TraitEngine 형식으로 변환
    impact = this.convertAnswerMappingsToImpact(answerMappingsImpacts)
  } else {
    // answer-mappings에 없으면 질문 기준표에서 찾기
    impact = this.getAnswerImpact(criteria, questionId, answerId)
  }
  // ...
}
```

**문제점**:
- answer-mappings를 우선 조회하지만, 두 데이터 소스가 충돌할 때 처리 로직이 없음
- 같은 질문에 대해 answer-mappings와 질문 기준표에 모두 데이터가 있을 수 있음
- 어떤 것을 우선할지 명확하지 않음

**영향**:
- ✅ 동일한 질문-답변 조합이 다른 점수로 계산될 수 있음
- ✅ 데이터 일관성 부족

**해결 방안**:
- 명확한 우선순위 정책 수립 (예: answer-mappings 우선, 없으면 질문 기준표)
- 충돌 감지 및 로깅 추가

---

### 🟡 문제 7: 에러 처리 시 기본값 반환으로 인한 문제 은폐

**위치**: `lib/analysis/engine-v3/engines/TraitEngine.ts:128-138`

**문제 코드**:
```typescript
} catch (error) {
  console.error('❌ [TraitEngine] 성향 분석 오류:', error)
  
  // Fallback: 기본 결과 반환
  return {
    indicators: createDefaultIndicators(),  // ❌ 모든 지표 50점
    keywords: ['일반'],
    priorityAreas: ['거실', '주방'],
    lifestyleType: 'general'
  }
}
```

**문제점**:
- 에러 발생 시 조용히 기본값을 반환하여 문제를 은폐
- 사용자는 에러를 인지하지 못하고 잘못된 결과를 받음
- 디버깅이 어려움

**영향**:
- ✅ 에러가 발생해도 사용자는 정상 작동으로 오인
- ✅ 잘못된 성향 분석 결과로 인한 잘못된 추천

**해결 방안**:
- 에러를 상위로 전파하거나 명시적인 에러 응답 반환
- 에러 로깅 강화

---

### 🟡 문제 8: V4 → V3 변환 시 VibeInput 누락

**위치**: `lib/estimate-v4/engines/personality/TraitScorer.ts:28-50`

**문제 코드**:
```typescript
const v3Input = toV3TraitEngineInput({
  answers,
  spaceInfo,
  preferences: { /* ... */ },
  // ❌ vibeInput이 없음
})
```

**문제점**:
- V3 TraitEngine은 `vibeInput` (MBTI, 혈액형, 별자리)을 지원하지만
- V4에서 V3로 변환할 때 `vibeInput`을 전달하지 않음
- `adjustByVibeInput` 함수가 호출되지 않음

**영향**:
- ✅ MBTI, 혈액형, 별자리 정보가 성향 분석에 반영되지 않음
- ✅ VibeInput 기능이 작동하지 않음

**해결 방안**:
- V4 입력에 vibeInput 추가
- toV3TraitEngineInput에서 vibeInput 변환

---

### 🟡 문제 9: 점수 변환 시 반올림으로 인한 정밀도 손실

**위치**: `lib/estimate-v4/converters/output-converter.ts:21-41`

**문제 코드**:
```typescript
export function toV4TraitScores(
  v3Result: TraitEngineResult
): TraitScoreV4[] {
  const { indicators, priorityAreas } = v3Result
  const confidence = priorityAreas.length > 0 ? 0.85 : 0.7

  return Object.entries(indicators).map(([koKey, score]) => {
    const enKey = V3_KO_TO_V4_EN[koKey] ?? koKey

    // V3는 0-100 범위, V4는 1-10 범위이므로 변환 필요
    // V3 score (0-100) → V4 (1-10): Math.round(score / 10)
    const v4Score = Math.max(1, Math.min(10, Math.round(score / 10)))  // ❌ 반올림
    // ...
  })
}
```

**문제점**:
- `Math.round(score / 10)`로 반올림하면 정밀도 손실 발생
- 예: V3 score 45 → V4 score 5, V3 score 55 → V4 score 6
- 5점 차이가 1점 차이로 축소됨

**영향**:
- ✅ 미세한 성향 차이가 사라짐
- ✅ 점수 분포가 좁아짐

**해결 방안**:
- 더 정밀한 변환 공식 사용 (예: `Math.round(score / 10 * 10) / 10`로 소수점 1자리)
- 또는 V4 점수 범위를 1-10에서 1-100으로 확장

---

## 개선 권장 사항 (Minor)

### 🟢 개선 1: 타입 안정성 강화

**문제**:
- `spaceInfo: any` 타입 사용
- `impact: any` 타입 사용
- 타입 가드 부족

**해결 방안**:
- 모든 `any` 타입을 구체적인 타입으로 변경
- 타입 가드 함수 추가

---

### 🟢 개선 2: 로깅 일관성

**문제**:
- `console.log`, `console.warn`, `console.error` 혼용
- V4는 `logger` 사용, V3는 `console` 사용

**해결 방안**:
- 통일된 로깅 시스템 사용
- 모든 로그를 `logger`로 통일

---

### 🟢 개선 3: 성능 최적화

**문제**:
- 질문 기준표를 매번 로드 (캐싱 없음)
- 답변별 순차 처리 (병렬 처리 가능)

**해결 방안**:
- 질문 기준표 캐싱
- 답변 처리 병렬화

---

## 해결 방안

### 우선순위별 해결 계획

#### 🔴 Priority 1: 즉시 수정 필요

1. **TraitScorer에 preferences 파라미터 추가**
   ```typescript
   // lib/estimate-v4/engines/personality/TraitScorer.ts
   export async function calculateTraitScores(
     answers: UserAnswerV4[],
     spaceInfo: SpaceInfoV4,
     preferences: PreferencesV4  // ✅ 추가
   ): Promise<TraitScoreV4[]>
   ```

2. **TypeClassifier의 organization_habit 수정**
   ```typescript
   // lib/estimate-v4/engines/personality/TypeClassifier.ts
   const orgScore = scoreMap.get('storage_importance') ?? 5  // ✅ 수정
   ```

3. **점수 변환 공식 개선**
   ```typescript
   // lib/analysis/engine-v3/engines/TraitEngine.ts
   const value = (score - 1) * (100 / 9) - 50  // ✅ 개선된 공식
   ```

#### 🟡 Priority 2: 단기 개선

4. **SpaceInfo에 totalPeople 추가**
5. **에러 처리 개선**
6. **VibeInput 지원 추가**

#### 🟢 Priority 3: 장기 개선

7. **타입 안정성 강화**
8. **로깅 통일**
9. **성능 최적화**

---

## 테스트 권장 사항

### 단위 테스트

1. **TraitScorer 테스트**
   - preferences가 제대로 전달되는지 확인
   - V4 → V3 → V4 변환 정확도 확인

2. **TypeClassifier 테스트**
   - 존재하지 않는 키 조회 시 기본값 반환 확인
   - 타입 분류 정확도 확인

3. **점수 변환 테스트**
   - answer-mappings 점수 변환 정확도 확인
   - V3 ↔ V4 점수 변환 정확도 확인

### 통합 테스트

1. **전체 플로우 테스트**
   - 사용자 입력 → 성향 분석 → 타입 분류 → 위험 평가 전체 플로우
   - 각 단계에서 데이터 손실 없는지 확인

2. **엣지 케이스 테스트**
   - 답변이 없는 경우
   - 일부 답변만 있는 경우
   - 에러 발생 시나리오

---

## 결론

인테리봇 성향분석 로직에서 **5개의 치명적 문제**와 **4개의 중요 문제**를 발견했습니다.

**가장 시급한 문제**:
1. ✅ TraitScorer에서 preferences 정보 손실
2. ✅ TypeClassifier에서 존재하지 않는 키 조회
3. ✅ 점수 변환 공식의 부정확성

이러한 문제들로 인해 **사용자의 실제 입력이 성향 분석에 제대로 반영되지 않고 있습니다.**

**권장 조치**:
- Priority 1 문제들을 즉시 수정
- 수정 후 전체 플로우 테스트 수행
- 사용자 피드백 수집 및 검증

---

**문서 작성일**: 2024년  
**최종 업데이트**: 2024년  
**작성자**: AI Assistant




