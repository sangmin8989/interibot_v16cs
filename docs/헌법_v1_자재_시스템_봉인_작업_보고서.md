# ì¸í…Œë¦¬ë´‡ í—Œë²• v1 â€“ ìì¬ ì‹œìŠ¤í…œ ì „ë©´ ë´‰ì¸ ì‘ì—… ë³´ê³ ì„œ

**ì‘ì—… ì¼ì**: 2025ë…„ 12ì›”
**ì‘ì—… ëª©ì **: ë‹¨ê°€ê°€ ì—†ëŠ” ìì¬ëŠ” ì½”ë“œ ë ˆë²¨ì—ì„œ "ì¡´ì¬ ìì²´ê°€ ë¶ˆê°€ëŠ¥"í•˜ê²Œ ë§Œë“¤ê¸°  
**ì‘ì—… ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ğŸ“‹ ì‘ì—… ê°œìš”

### ëª©ì 
ê°€ê²©Â·ë…¸ë¬´ ì •ë³´ê°€ ë¶ˆì™„ì „í•œ ê³µì •ì€ ì½”ë“œ ë ˆë²¨ì—ì„œ "ì¡´ì¬ ìì²´ê°€ ë¶ˆê°€ëŠ¥"í•˜ë„ë¡ ë´‰ì¸í•˜ì—¬, ì‹¤ë¬´ ê³„ì•½ ê°€ëŠ¥í•œ ê²¬ì  ì‹œìŠ¤í…œì„ êµ¬ì¶•

### í•µì‹¬ ì›ì¹™
- **ë‹¨ê°€ ì—†ëŠ” ìì¬ëŠ” ìš”ì²­ ìì²´ê°€ ë¶ˆë²•**
- **íŒŒì¼ ê¸°ë°˜ ê°€ê²© ì‹œìŠ¤í…œ ì „ë©´ ê¸ˆì§€**
- **fallback/ë³´ì •ê°’ ì „ë©´ ê¸ˆì§€**
- **ê°€ê²© ê²€ì¦ì€ DB ì¡°íšŒ ì‹œì ì—ë§Œ ìˆ˜í–‰**

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. ìì¬ ê°€ê²© ê²€ì¦ ê°•í™” (`queryMaterialFromDB`)

**íŒŒì¼**: `lib/estimate/constitution-v1-engine.ts` (ë¼ì¸ 1925-1942)

**ë³€ê²½ ì „**:
```typescript
const finalPrice = data.price || data.price_argen || 0  // âŒ ê°€ê²©ì´ ì—†ì–´ë„ 0ìœ¼ë¡œ ì²˜ë¦¬
return {
  status: 'SUCCESS',
  data: {
    price: finalPrice,  // âŒ 0ì› ìì¬ê°€ ê·¸ëŒ€ë¡œ ë°˜í™˜ë¨
  }
}
```

**ë³€ê²½ í›„**:
```typescript
// âŒ || 0 ì œê±°: ê°€ê²©ì´ ì—†ìœ¼ë©´ nullë¡œ ì²˜ë¦¬ (fallback ê¸ˆì§€)
const finalPrice = data.price ?? data.price_argen ?? null

// âœ… ê°€ê²© ê²€ì¦: 0ì´ê±°ë‚˜ nullì´ë©´ ì¦‰ì‹œ ì‹¤íŒ¨ (ë‹¨ê°€ ì—†ëŠ” ìì¬ëŠ” ìš”ì²­ ìì²´ê°€ ë¶ˆë²•)
if (finalPrice === null || finalPrice === undefined || finalPrice <= 0) {
  return {
    status: 'NOT_FOUND',
    message: `ìì¬ ê°€ê²© ì •ë³´ ì—†ìŒ: ${data.product_name} (${request.category.category1}/${request.category.category2})`,
    allowFallback: false,
  }
}

return {
  status: 'SUCCESS',
  data: {
    price: finalPrice,  // âœ… ì´ì œ ë°˜ë“œì‹œ > 0
  }
}
```

**íš¨ê³¼**:
- âœ… ê°€ê²©ì´ ì—†ëŠ” ìì¬ëŠ” DB ì¡°íšŒ ì‹œì ì— ì¦‰ì‹œ ì°¨ë‹¨
- âœ… 0ì› ìì¬ê°€ ê²¬ì ì— í¬í•¨ë˜ì§€ ì•ŠìŒ
- âœ… `|| 0` fallback íŒ¨í„´ ì œê±°

---

### 2. ë…¸ë¬´ë¹„ ê²€ì¦ ê°•í™” (`queryLaborFromDB`)

**íŒŒì¼**: `lib/estimate/constitution-v1-engine.ts` (ë¼ì¸ 2042-2067)

**ë³€ê²½ ì „**:
```typescript
return {
  status: 'SUCCESS',
  data: {
    dailyOutput: productivityData.daily_output || request.dailyOutput,  // âŒ 0ì¼ ìˆ˜ ìˆìŒ
    crewSize: productivityData.crew_size || request.crewSize,  // âŒ 0ì¼ ìˆ˜ ìˆìŒ
    ratePerPersonDay: costData.daily_rate || 0,  // âŒ 0ìœ¼ë¡œ fallback
  }
}
```

**ë³€ê²½ í›„**:
```typescript
// âœ… í—Œë²• v1 ë´‰ì¸: ë…¸ë¬´ ì •ë³´ ê²€ì¦ (0ì´ê±°ë‚˜ nullì´ë©´ ì¦‰ì‹œ ì‹¤íŒ¨)
const dailyOutput = productivityData.daily_output ?? request.dailyOutput ?? null
const crewSize = productivityData.crew_size ?? request.crewSize ?? null
const ratePerPersonDay = costData.daily_rate ?? null

// âœ… ë…¸ë¬´ ê²€ì¦: í•˜ë‚˜ë¼ë„ 0ì´ê±°ë‚˜ nullì´ë©´ ì¦‰ì‹œ ì‹¤íŒ¨
if (dailyOutput === null || dailyOutput === undefined || dailyOutput <= 0) {
  return {
    status: 'NOT_FOUND',
    message: `ë…¸ë¬´ ìƒì‚°ì„± ì •ë³´ ì—†ìŒ: dailyOutput (${request.processId})`,
  }
}

if (crewSize === null || crewSize === undefined || crewSize <= 0) {
  return {
    status: 'NOT_FOUND',
    message: `ë…¸ë¬´ ìƒì‚°ì„± ì •ë³´ ì—†ìŒ: crewSize (${request.processId})`,
  }
}

if (ratePerPersonDay === null || ratePerPersonDay === undefined || ratePerPersonDay <= 0) {
  return {
    status: 'NOT_FOUND',
    message: `ë…¸ë¬´ ë‹¨ê°€ ì •ë³´ ì—†ìŒ: ratePerPersonDay (${request.processId})`,
  }
}

return {
  status: 'SUCCESS',
  data: {
    dailyOutput,  // âœ… ì´ì œ ë°˜ë“œì‹œ > 0
    crewSize,  // âœ… ì´ì œ ë°˜ë“œì‹œ > 0
    ratePerPersonDay,  // âœ… ì´ì œ ë°˜ë“œì‹œ > 0
  }
}
```

**íš¨ê³¼**:
- âœ… ë…¸ë¬´ ì •ë³´ê°€ ë¶ˆì™„ì „í•œ ê³µì •ì€ ì¦‰ì‹œ ì°¨ë‹¨
- âœ… `dailyOutput`, `crewSize`, `ratePerPersonDay` ëª¨ë‘ ê²€ì¦
- âœ… `|| 0` fallback íŒ¨í„´ ì œê±°

---

### 3. ì´ì¤‘ ê²€ì¦ êµ¬ì¡° í™•ì¸

**íŒŒì¼**: `lib/estimate/constitution-v1-engine.ts`

#### ìì¬ ê²€ì¦ (ë¼ì¸ 1110-1118)
```typescript
if (result.status !== 'SUCCESS' || !result.data) {
  throw new EstimateValidationError({
    processId,
    reason: `ìì¬ ë°ì´í„° ì—†ìŒ: ${req.category.category1}/${req.category.category2}`
  })
}
```

#### ë…¸ë¬´ ê²€ì¦ (ë¼ì¸ 1228-1253)
```typescript
if (result.status !== 'SUCCESS' || !result.data) {
  throw new EstimateValidationError({
    processId,
    reason: `ë…¸ë¬´ ë°ì´í„° ì—†ìŒ: ${req.processId}`
  })
}

// âœ… ëª…ì„¸ 3-1: ë…¸ë¬´ ê³„ì‚° ë¶ˆê°€ ì²´í¬
if (result.data.dailyOutput === 0) {
  throw new EstimateValidationError({
    processId,
    reason: `ë…¸ë¬´ 1ì¼ ì‘ì—…ëŸ‰ 0: ${req.processId}`
  })
}
// ... crewSize, ratePerPersonDay ê²€ì¦
```

**íš¨ê³¼**:
- âœ… DB ì¡°íšŒ ë‹¨ê³„ì—ì„œ ì°¨ë‹¨ (1ì°¨ ë°©ì–´)
- âœ… `createSingleProcessBlock`ì—ì„œ ì¬ê²€ì¦ (2ì°¨ ë°©ì–´)
- âœ… ì´ì¤‘ ì•ˆì „ì¥ì¹˜ë¡œ ê²¬ì  ì‹œìŠ¤í…œ ì•ˆì •ì„± í–¥ìƒ

---

### 4. API ì—ëŸ¬ ì²˜ë¦¬ í™•ì¸

**íŒŒì¼**: `app/api/estimate/constitution/route.ts` (ë¼ì¸ 98-166)

**í˜„ì¬ êµ¬í˜„**:
- âœ… `EstimateValidationError`ëŠ” 422 (Unprocessable Entity)ë¡œ ë³€í™˜
- âœ… 500 Internal Server Error ê¸ˆì§€
- âœ… êµ¬ì²´ì ì¸ ì‹¤íŒ¨ ì‚¬ìœ  (`reason`) ë°˜í™˜

```typescript
if (calcError instanceof EstimateValidationError) {
  return NextResponse.json(
    {
      status: 'ESTIMATE_FAILED',
      failedAt: 'ENGINE_VALIDATION',
      reason: calcError.reason,
      failedProcesses: [calcError.processId],
    },
    { status: 422 } // 422 Unprocessable Entity (500 ê¸ˆì§€)
  )
}
```

---

## ğŸ“Š ì‘ì—… ê²°ê³¼

### ì œê±°ëœ íŒ¨í„´
- âŒ `|| 0` fallback íŒ¨í„´
- âŒ `?? 0` fallback íŒ¨í„´
- âŒ íŒŒì¼ ê¸°ë°˜ ê°€ê²© ì‹œìŠ¤í…œ (constitution-v1-engine.tsì—ì„œëŠ” ì´ë¯¸ DBë§Œ ì‚¬ìš© ì¤‘)

### ê°•í™”ëœ ê²€ì¦
- âœ… ìì¬ ê°€ê²©: DB ì¡°íšŒ ì‹œì ì— ì¦‰ì‹œ ê²€ì¦
- âœ… ë…¸ë¬´ ì •ë³´: `dailyOutput`, `crewSize`, `ratePerPersonDay` ëª¨ë‘ ê²€ì¦
- âœ… ì´ì¤‘ ê²€ì¦: DB ì¡°íšŒ + `createSingleProcessBlock` ë‹¨ê³„

### ë³´ì¥ë˜ëŠ” ìƒíƒœ
- âœ… ê°€ê²©ì´ ì—†ëŠ” ìì¬ëŠ” ê²¬ì ì— í¬í•¨ë  ìˆ˜ ì—†ìŒ
- âœ… 0ì› ìì¬ëŠ” ì¡´ì¬í•  ìˆ˜ ì—†ìŒ
- âœ… ë…¸ë¬´ ì •ë³´ê°€ ë¶ˆì™„ì „í•œ ê³µì •ì€ ì¦‰ì‹œ ì°¨ë‹¨
- âœ… ëª¨ë“  ì‹¤íŒ¨ëŠ” 422 ìƒíƒœ ì½”ë“œë¡œ ë°˜í™˜

---

## ğŸ” ê²€ì¦ ì™„ë£Œ ì‚¬í•­

### 1. ì½”ë“œ ê²€ì¦
- âœ… ë¦°í„° ì˜¤ë¥˜ ì—†ìŒ
- âœ… TypeScript íƒ€ì… ì˜¤ë¥˜ ì—†ìŒ
- âœ… íŒŒì¼ ê¸°ë°˜ ê°€ê²© ì‹œìŠ¤í…œ ë¯¸ì‚¬ìš© í™•ì¸ (`constitution-v1-engine.ts`)

### 2. ë¡œì§ ê²€ì¦
- âœ… `queryMaterialFromDB`: ê°€ê²©ì´ 0ì´ê±°ë‚˜ nullì´ë©´ `NOT_FOUND` ë°˜í™˜
- âœ… `queryLaborFromDB`: ë…¸ë¬´ ì •ë³´ê°€ 0ì´ê±°ë‚˜ nullì´ë©´ `NOT_FOUND` ë°˜í™˜
- âœ… `createSingleProcessBlock`: `NOT_FOUND`ë¥¼ `EstimateValidationError`ë¡œ ë³€í™˜
- âœ… API ë¼ìš°íŠ¸: `EstimateValidationError`ë¥¼ 422ë¡œ ë³€í™˜

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

### 1. DB ê°€ê²© ì—…ë°ì´íŠ¸ (í•„ìˆ˜)
**íŒŒì¼**: `docs/í—Œë²•_ì‹¤í–‰_ìì¬_ê°€ê²©_ì—…ë°ì´íŠ¸_SQL.sql`

LED ë‹¤ìš´ë¼ì´íŠ¸ ê°€ê²© ì—…ë°ì´íŠ¸ SQL ì‹¤í–‰:
```sql
UPDATE materials SET price_argen = 35000 
WHERE category_1 = 'ì¡°ëª…' 
  AND category_2 = 'ë‹¤ìš´ë¼ì´íŠ¸' 
  AND product_name LIKE '%LED ë‹¤ìš´ë¼ì´íŠ¸ 3ì¸ì¹˜ 5W%' 
  AND is_argen_standard = true;
```

**ì‹¤í–‰ ë°©ë²•**:
1. Supabase Dashboard â†’ SQL Editor
2. ìœ„ SQL ì¿¼ë¦¬ ì‹¤í–‰
3. ì—…ë°ì´íŠ¸ëœ í–‰ ìˆ˜ í™•ì¸

### 2. ì‹¤ì œ í…ŒìŠ¤íŠ¸
**í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤**:
1. í‰ìˆ˜ 25, ì£¼ë°© ê³µê°„ ì„ íƒ
2. finish/electric/kitchen ê³µì • ì„ íƒ
3. ê²¬ì  ê³„ì‚° ë²„íŠ¼ í´ë¦­
4. LED ë‹¤ìš´ë¼ì´íŠ¸ ê°€ê²©ì´ ì •ìƒì ìœ¼ë¡œ ì¡°íšŒë˜ëŠ”ì§€ í™•ì¸
5. 0ì› í•­ëª©ì´ ì—†ëŠ”ì§€ í™•ì¸

**ì˜ˆìƒ ê²°ê³¼**:
- âœ… LED ë‹¤ìš´ë¼ì´íŠ¸ ê°€ê²©: 35,000ì›/EA
- âœ… ê²¬ì  ì •ìƒ ìƒì„±
- âœ… 0ì› í•­ëª© ì—†ìŒ

### 3. ì—ëŸ¬ ë©”ì‹œì§€ ê°œì„  (ì„ íƒ)
í˜„ì¬ `NOT_FOUND` ë©”ì‹œì§€ê°€ "ìì¬ ë°ì´í„° ì—†ìŒ"ìœ¼ë¡œë§Œ í‘œì‹œë©ë‹ˆë‹¤. ê°€ê²©ì´ ì—†ì„ ë•Œ ë” êµ¬ì²´ì ì¸ ë©”ì‹œì§€ë¡œ ê°œì„  ê°€ëŠ¥:

```typescript
// í˜„ì¬
reason: `ìì¬ ë°ì´í„° ì—†ìŒ: ${req.category.category1}/${req.category.category2}`

// ê°œì„ ì•ˆ
reason: `ìì¬ ê°€ê²© ì •ë³´ ì—†ìŒ: ${data.product_name} (${req.category.category1}/${req.category.category2})`
```

---

## ğŸ¯ ì‘ì—… ì™„ë£Œ ì„ ì–¸

### ë‹¬ì„±í•œ ëª©í‘œ
- âœ… **ë‹¨ê°€ ì—†ëŠ” ìì¬ëŠ” ì½”ë“œ ë ˆë²¨ì—ì„œ ì¡´ì¬ ë¶ˆê°€ëŠ¥**
- âœ… **íŒŒì¼ ê¸°ë°˜ ê°€ê²© ì‹œìŠ¤í…œ ì „ë©´ ê¸ˆì§€** (constitution-v1-engine.ts ê¸°ì¤€)
- âœ… **fallback/ë³´ì •ê°’ ì „ë©´ ê¸ˆì§€**
- âœ… **ê°€ê²© ê²€ì¦ì€ DB ì¡°íšŒ ì‹œì ì—ë§Œ ìˆ˜í–‰**

### ì‹œìŠ¤í…œ ìƒíƒœ
- âœ… ê²¬ì  ì—”ì§„ì´ "ì‹¤ë¬´ ê³„ì•½ ê°€ëŠ¥í•œ ì‹œìŠ¤í…œ"ìœ¼ë¡œ ë´‰ì¸ë¨
- âœ… ê°€ê²©ì´ ì—†ëŠ” ìì¬ëŠ” íƒœì–´ë‚  ìˆ˜ ì—†ëŠ” êµ¬ì¡°
- âœ… 0ì› ìì¬ëŠ” êµ¬ì¡°ì ìœ¼ë¡œ ìƒì„± ë¶ˆê°€

---

## ğŸ“Œ ì°¸ê³  ì‚¬í•­

### íŒŒì¼ ê¸°ë°˜ ê°€ê²© ì‹œìŠ¤í…œ
- `constitution-v1-engine.ts`ì—ì„œëŠ” ì´ë¯¸ DBë§Œ ì‚¬ìš© ì¤‘
- `material-service.ts`ì— íŒŒì¼ ê¸°ë°˜ ê°€ê²© ì‹œìŠ¤í…œì´ ìˆìœ¼ë‚˜, `constitution-v1-engine.ts`ì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- í–¥í›„ `material-service.ts`ë„ DB ì „ìš©ìœ¼ë¡œ ì „í™˜ ê°€ëŠ¥ (í˜„ì¬ëŠ” ìš°ì„ ìˆœìœ„ ë‚®ìŒ)

### ë…¸ë¬´ë¹„ ê²€ì¦
- `createSingleProcessBlock`ì—ì„œ ì´ë¯¸ ë…¸ë¬´ë¹„ ê²€ì¦ ìˆ˜í–‰ ì¤‘ (ë¼ì¸ 1236-1253)
- DB ì¡°íšŒ ë‹¨ê³„ì—ì„œ ì¶”ê°€ ê²€ì¦ìœ¼ë¡œ ì´ì¤‘ ì•ˆì „ì¥ì¹˜ êµ¬ì„±

---

**ì‘ì—… ì™„ë£Œì¼**: 2025ë…„ 1ì›”  
**ì‘ì—…ì**: AI Assistant (Cursor)  
**ê²€ì¦ ìƒíƒœ**: âœ… ì½”ë“œ ê²€ì¦ ì™„ë£Œ, ì‹¤ì œ í…ŒìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘




